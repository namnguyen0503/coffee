================================================================
PHẦN 1: THỐNG KÊ TỔNG QUAN (DÙNG CHO EXCEL REPORT)
================================================================
Project Name: coffee
Scan Date:    2026-01-04 21:20:58
Total Files:  169
--------------------------------
[File Counts by Type]
- PHP Files (Logic):    55
- HTML/CSS/JS (View):   48
- SQL (Database):       1
- Images/Assets:        23 (Đã bỏ qua nội dung)
--------------------------------
[Code Volume]
- Total Lines of Logic: 5865 lines

================================================================
PHẦN 2: CẤU TRÚC THƯ MỤC (PROJECT TREE)
================================================================
coffee/
    coffee (13).sql
    config.inc.php
    create_hash.php
    erp.py
    index.php
    ket_qua_scan.txt
    login.php
    logout.php
    NewPage.mp3
    password.txt
    README.docx
    readme.txt
    root_main.js
    admin/
        index.php
        api/
            add_item.php
            add_schedule.php
            add_user.php
            add_voucher.php
            auto_update_status.php
            cancel_order.php
            delete_item.php
            delete_schedule.php
            delete_voucher.php
            export_excel.php
            get_ingredients.php
            get_items.php
            get_orders.php
            get_order_detail.php
            get_recipe_detail.php
            get_report_stats.php
            get_schedules.php
            get_users.php
            get_vouchers.php
            update_ingredient_min.php
            update_item.php
            update_min_stock.php
            update_user.php
        assets/
            dist/
                css/
                    adminlte.css
                    adminlte.css.map
                    adminlte.min.css
                    adminlte.min.css.map
                    alt/
                        adminlte.components.css
                        adminlte.components.css.map
                        adminlte.components.min.css
                        adminlte.components.min.css.map
                        adminlte.core.css
                        adminlte.core.css.map
                        adminlte.core.min.css
                        adminlte.core.min.css.map
                        adminlte.extra-components.css
                        adminlte.extra-components.css.map
                        adminlte.extra-components.min.css
                        adminlte.extra-components.min.css.map
                        adminlte.light.css
                        adminlte.light.css.map
                        adminlte.light.min.css
                        adminlte.light.min.css.map
                        adminlte.pages.css
                        adminlte.pages.css.map
                        adminlte.pages.min.css
                        adminlte.pages.min.css.map
                        adminlte.plugins.css
                        adminlte.plugins.css.map
                        adminlte.plugins.min.css
                        adminlte.plugins.min.css.map
                img/
                    logo coffee.png
                    logo.png
                js/
                    adminlte.js
                    adminlte.js.map
                    adminlte.min.js
                    adminlte.min.js.map
                    demo.js
                    pages/
                        dashboard.js
                        dashboard2.js
                        dashboard3.js
            plugins/
                fontawesome-free/
                    css/
                        all.css
                        all.min.css
                    webfonts/
                        fa-brands-400.eot
                        fa-brands-400.svg
                        fa-brands-400.ttf
                        fa-brands-400.woff
                        fa-brands-400.woff2
                        fa-regular-400.eot
                        fa-regular-400.svg
                        fa-regular-400.ttf
                        fa-regular-400.woff
                        fa-regular-400.woff2
                        fa-solid-900.eot
                        fa-solid-900.svg
                        fa-solid-900.ttf
                        fa-solid-900.woff
                        fa-solid-900.woff2
                jquery/
                    jquery.js
                    jquery.min.js
                    jquery.min.map
                    jquery.slim.js
                    jquery.slim.min.js
                    jquery.slim.min.map
                jquery-knob/
                    jquery.knob.min.js
                jquery-mapael/
                    jquery.mapael.js
                    jquery.mapael.min.js
                    maps/
                        france_departments.js
                        france_departments.min.js
                        README.txt
                        usa_states.js
                        usa_states.min.js
                        world_countries.js
                        world_countries.min.js
                        world_countries_mercator.js
                        world_countries_mercator.min.js
                        world_countries_miller.js
                        world_countries_miller.min.js
                jquery-mousewheel/
                    jquery.mousewheel.js
                    LICENSE.txt
        tinh-nang/
            composer.json
            composer.lock
            display-item.css
    assets/
        img/
            drink/
                1766479775_ad.jpg
                1766568160_OIP.webp
                1766636352_bo_pc.jpg
                ca-phe-den.jpg
                index.php
                latte-da.jpg
                nuoc-ep-cam.png
                sinh-to-bo.avif
                tra-dao-cam-sa.jpg
            food/
                1766626403_bo_pc.jpg
                banh-mi-bo-toi.webp
                banh-mousse-chanh-leo.png
                banh-muffin-chocolate.jpg
                banh-tiramisu.png
                index.php
                khoai-tay-chien.jpg
    core/
        debug_log.txt
        debug_order.txt
        index.php
        order_processor.php
        products-list.php
        session_manager.php
        warehouse_logic.php
    includes/
        config.php
        db_connection.php
        index.php
    pos/
        check_voucher.php
        customer_view.php
        get_order_details.php
        history.php
        index.php
        menu.php
        css/
            all.min.css
            bootstrap.css
            index.php
            pos_style.css
        js/
            bootstrap.js
            index.php
            pos_main.js
        webfonts/
            fa-brands-400.woff2
            fa-regular-400.woff2
            fa-solid-900.woff2
            fa-v4compatibility.woff2
    warehouse/
        add_ingredient.php
        get_history_api.php
        history.php
        index.php
        process_add_new.php
        process_export.php
        process_import.php
        suppliers.php
        css/
            warehouse_style.css

================================================================
PHẦN 3: NỘI DUNG CODE CỐT LÕI (CONTEXT CHO CLAUDE)
================================================================
>>> CHỈ DẪN CHO AI: Dưới đây là logic xử lý và CSDL.
>>> Hãy bỏ qua CSS/HTML. Hãy dùng thông tin này vẽ DFD và ERD.

---------------- START FILE: coffee (13).sql ----------------
-- phpMyAdmin SQL Dump
-- version 5.2.1
-- https://www.phpmyadmin.net/
--
-- Host: 127.0.0.1
-- Generation Time: Dec 24, 2025 at 07:32 PM
-- Server version: 10.4.32-MariaDB
-- PHP Version: 8.2.12

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
START TRANSACTION;
SET time_zone = "+00:00";


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;

--
-- Database: `coffee`
--

-- --------------------------------------------------------

--
-- Table structure for table `categories`
--

CREATE TABLE `categories` (
  `id` int(11) NOT NULL,
  `name` varchar(255) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `categories`
--

INSERT INTO `categories` (`id`, `name`) VALUES
(1, 'Đồ uống'),
(2, 'Đồ ăn');

-- --------------------------------------------------------

--
-- Table structure for table `ingredients`
--

CREATE TABLE `ingredients` (
  `id` int(11) NOT NULL,
  `name` varchar(100) NOT NULL,
  `unit` varchar(20) NOT NULL,
  `quantity` float DEFAULT 0,
  `min_quantity` float DEFAULT 10,
  `last_updated` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `ingredients`
--

INSERT INTO `ingredients` (`id`, `name`, `unit`, `quantity`, `min_quantity`, `last_updated`, `updated_at`) VALUES
(1, 'Hạt Cà phê', 'g', 5280, 500, '2025-12-24 14:46:17', '2025-12-24 18:29:45'),
(2, 'Sữa tươi', 'ml', 98000, 200, '2025-12-24 17:59:41', '2025-12-24 18:29:45'),
(3, 'Trà túi lọc (Đào)', 'túi', 1978, 10, '2025-12-24 14:46:17', '2025-12-24 18:29:45'),
(4, 'Cam tươi', 'quả', 19734.5, 20, '2025-12-24 14:46:17', '2025-12-24 18:29:45'),
(5, 'Bơ sáp', 'g', 20412, 500, '2025-12-23 09:15:54', '2025-12-24 18:29:45'),
(6, 'Bột mì', 'g', 49750, 1000, '2025-12-24 17:59:41', '2025-12-24 18:29:45'),
(7, 'Chocolate', 'g', 20020, 300, '2025-12-21 05:05:13', '2025-12-24 18:29:45'),
(8, 'Khoai tây đông lạnh', 'g', 14978, 1000, '2025-12-21 05:15:32', '2025-12-24 18:29:45'),
(9, 'Bánh mì ổ', 'ổ', 232, 10, '2025-12-21 08:53:18', '2025-12-24 18:29:45'),
(10, 'Bơ lạt', 'g', 4343430, 200, '2025-12-21 08:53:08', '2025-12-24 18:29:45'),
(11, 'Tỏi', 'g', 100, 50, '2025-12-21 05:15:32', '2025-12-24 18:29:45'),
(12, 'Lá Parsley khô', 'g', 50, 10, '2025-12-23 14:48:53', '2025-12-24 18:29:45'),
(13, 'Sữa đặc', 'ml', 400, 100, '2025-12-21 05:15:32', '2025-12-24 18:29:45'),
(14, 'Trân châu đen', 'kg', 50, 10, '2025-12-24 18:30:17', '2025-12-24 18:30:17');

-- --------------------------------------------------------

--
-- Table structure for table `inventory_log`
--

CREATE TABLE `inventory_log` (
  `id` int(11) NOT NULL,
  `ingredient_id` int(11) DEFAULT NULL,
  `type` enum('import','export') NOT NULL,
  `quantity` float NOT NULL,
  `cost` decimal(15,0) DEFAULT 0 COMMENT 'Tổng tiền nhập hàng',
  `note` text DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT current_timestamp(),
  `user_id` int(11) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `inventory_log`
--

INSERT INTO `inventory_log` (`id`, `ingredient_id`, `type`, `quantity`, `cost`, `note`, `created_at`, `user_id`) VALUES
(1, 1, 'import', 5000, 1000000, 'Nhập cafe đợt 1', '2025-12-01 01:00:00', 1),
(2, 1, 'import', 5000, 1200000, 'Nhập cafe đợt 2 (giá tăng)', '2025-12-15 01:00:00', 1),
(3, 2, 'import', 20000, 600000, 'Sữa Vinamilk thùng', '2025-12-01 01:30:00', 1),
(4, 2, 'import', 30000, 900000, 'Sữa Vinamilk thùng đợt 2', '2025-12-10 02:00:00', 1),
(5, 3, 'import', 200, 100000, 'Trà Cozy Đào', '2025-12-02 03:00:00', 1),
(6, 4, 'import', 50, 250000, 'Cam Vinh', '2025-12-02 03:15:00', 1),
(7, 4, 'import', 50, 250000, 'Cam Vinh đợt 2', '2025-12-20 00:00:00', 1),
(8, 5, 'import', 5000, 300000, 'Bơ sáp Daklak', '2025-12-05 01:00:00', 1),
(9, 5, 'import', 5000, 300000, 'Bơ sáp đợt 2', '2025-12-18 01:00:00', 1),
(10, 6, 'import', 10000, 200000, 'Bột mì đa dụng', '2025-12-01 07:00:00', 1),
(11, 7, 'import', 2000, 400000, 'Chocolate đen nguyên chất', '2025-12-03 04:00:00', 1),
(12, 8, 'import', 5000, 250000, 'Khoai tây đông lạnh', '2025-12-03 04:30:00', 1),
(13, 9, 'import', 100, 200000, 'Bánh mì tươi trong ngày', '2025-12-19 23:00:00', 1),
(14, 10, 'import', 1000, 200000, 'Bơ lạt Anchor', '2025-12-05 02:00:00', 1),
(15, 11, 'import', 500, 25000, 'Tỏi xay', '2025-12-05 02:00:00', 1),
(16, 12, 'import', 100, 50000, 'Lá gia vị khô', '2025-12-05 02:00:00', 1),
(17, 13, 'import', 5000, 250000, 'Sữa đặc Ngôi sao', '2025-12-01 01:30:00', 1),
(18, 6, 'export', 50, 0, 'Bán đơn #129', '2025-12-24 14:46:17', 1),
(19, 2, 'export', 50, 0, 'Bán đơn #129', '2025-12-24 14:46:17', 1),
(20, 1, 'export', 20, 0, 'Bán đơn #129', '2025-12-24 14:46:17', 1),
(21, 3, 'export', 2, 0, 'Bán đơn #129', '2025-12-24 14:46:17', 1),
(22, 4, 'export', 1, 0, 'Bán đơn #129', '2025-12-24 14:46:17', 1),
(23, 6, 'export', 50, 0, 'Bán đơn #130', '2025-12-24 17:59:41', 1),
(24, 2, 'export', 100, 0, 'Bán đơn #130', '2025-12-24 17:59:41', 1),
(25, 14, 'import', 50, 0, 'Khởi tạo nguyên liệu mới. Vốn: 5,000,000', '2025-12-24 18:30:17', 1);

-- --------------------------------------------------------

--
-- Table structure for table `orders`
--

CREATE TABLE `orders` (
  `id` int(11) NOT NULL,
  `user_id` int(11) NOT NULL DEFAULT 1,
  `order_date` datetime NOT NULL DEFAULT current_timestamp(),
  `total_price` int(11) NOT NULL,
  `payment_method` varchar(50) DEFAULT 'cash' COMMENT 'cash hoặc transfer',
  `status` varchar(255) NOT NULL DEFAULT 'not_paid',
  `session_id` int(11) DEFAULT NULL,
  `voucher_code` varchar(50) DEFAULT NULL,
  `discount_percent` decimal(5,2) DEFAULT 0.00,
  `final_amount` decimal(10,2) DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `orders`
--

INSERT INTO `orders` (`id`, `user_id`, `order_date`, `total_price`, `payment_method`, `status`, `session_id`, `voucher_code`, `discount_percent`, `final_amount`) VALUES
(1, 1, '2025-11-30 21:10:28', 0, 'cash', 'not_paid', NULL, NULL, 0.00, 0.00),
(2, 1, '2025-12-07 14:17:59', 25000, 'cash', 'not_paid', NULL, NULL, 0.00, 0.00),
(3, 1, '2025-12-07 14:20:16', 32000, 'cash', 'not_paid', NULL, NULL, 0.00, 0.00),
(4, 1, '2025-12-07 14:27:34', 25000, 'cash', 'not_paid', NULL, NULL, 0.00, 0.00),
(5, 1, '2025-12-07 14:30:47', 60000, 'cash', 'not_paid', NULL, NULL, 0.00, 0.00),
(6, 1, '2025-12-11 18:15:18', 32000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(7, 1, '2025-12-11 18:39:01', 3748000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(8, 1, '2025-12-11 18:50:33', 90000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(9, 1, '2025-12-11 18:51:30', 450000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(10, 1, '2025-12-12 10:28:43', 2235000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(11, 1, '2025-12-12 10:29:44', 155000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(12, 1, '2025-12-12 10:30:16', 195000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(13, 1, '2025-12-12 10:30:33', 120000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(14, 1, '2025-12-12 10:39:33', 777000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(15, 1, '2025-12-12 10:47:35', 385000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(16, 1, '2025-12-12 11:07:07', 77000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(17, 1, '2025-12-12 11:25:10', 336000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(18, 1, '2025-12-17 20:52:56', 430000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(19, 1, '2025-12-17 20:53:28', 603000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(20, 1, '2025-12-17 22:37:26', 531000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(21, 1, '2025-12-17 22:38:00', 167000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(22, 1, '2025-12-17 22:44:08', 403000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(23, 1, '2025-12-17 22:44:21', 120000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(24, 1, '2025-12-17 22:44:26', 240000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(25, 1, '2025-12-17 22:44:37', 662000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(26, 1, '2025-12-17 22:44:43', 538000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(27, 1, '2025-12-17 22:44:50', 295000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(28, 1, '2025-12-17 22:46:45', 428000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(29, 1, '2025-12-17 22:47:22', 804000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(30, 1, '2025-12-17 22:47:30', 372000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(31, 1, '2025-12-17 22:49:29', 160000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(32, 1, '2025-12-17 22:49:50', 95000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(33, 1, '2025-12-17 22:50:10', 90000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(34, 1, '2025-12-17 22:50:40', 175000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(35, 1, '2025-12-17 22:51:28', 148000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(36, 1, '2025-12-17 22:51:39', 58000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(37, 1, '2025-12-17 22:51:50', 115000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(38, 1, '2025-12-17 22:52:08', 130000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(39, 1, '2025-12-17 22:54:56', 120000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(40, 1, '2025-12-17 22:58:55', 398000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(41, 1, '2025-12-18 08:55:24', 600000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(42, 1, '2025-12-18 09:12:43', 324000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(43, 1, '2025-12-18 09:12:47', 443000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(44, 1, '2025-12-18 09:32:34', 115000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(45, 1, '2025-12-18 03:39:06', 215000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(46, 1, '2025-12-18 03:44:01', 145000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(47, 1, '2025-12-18 03:53:57', 86000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(48, 1, '2025-12-18 04:09:32', 105000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(49, 1, '2025-12-19 16:31:16', 49000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(50, 1, '2025-12-19 17:10:40', 75000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(51, 1, '2025-12-19 17:11:05', 109000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(52, 1, '2025-12-19 17:11:38', 40000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(53, 1, '2025-12-19 17:11:53', 39000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(54, 1, '2025-12-20 14:42:45', 825000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(55, 1, '2025-12-20 14:44:40', 750000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(56, 1, '2025-12-20 17:59:59', 144000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(57, 1, '2025-12-20 18:02:04', 259000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(58, 1, '2025-12-20 18:02:13', 120000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(59, 1, '2025-12-20 18:03:22', 102000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(60, 1, '2025-12-20 18:04:33', 495000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(63, 1, '2025-12-20 18:06:03', 816000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(64, 1, '2025-12-20 18:13:14', 2847000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(66, 1, '2025-12-20 18:13:38', 1560000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(67, 1, '2025-12-20 18:14:49', 990000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(68, 1, '2025-12-20 18:15:31', 2112000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(69, 1, '2025-12-20 18:16:26', 28909000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(70, 1, '2025-12-20 18:16:33', 34459000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(72, 1, '2025-12-20 18:16:42', 28942000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(73, 1, '2025-12-20 18:20:52', 120000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(74, 1, '2025-12-20 18:23:09', 480000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(75, 1, '2025-12-20 18:23:22', 120000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(76, 1, '2025-12-20 18:23:31', 160000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(77, 1, '2025-12-20 18:23:43', 9400000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(78, 1, '2025-12-21 06:06:04', 117000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(79, 2, '2025-12-21 06:12:26', 15425000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(80, 2, '2025-12-21 06:15:04', 55000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(81, 2, '2025-12-21 06:15:32', 1340000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(82, 2, '2025-12-21 06:18:11', 39000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(83, 2, '2025-12-21 06:23:08', 78000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(84, 1, '2025-12-21 06:24:41', 160000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(85, 2, '2025-12-21 06:30:22', 39000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(89, 2, '2025-12-21 15:22:27', 156000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(90, 2, '2025-12-21 15:28:53', 39000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(91, 2, '2025-12-21 15:29:30', 40000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(92, 2, '2025-12-21 15:30:50', 39000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(93, 2, '2025-12-21 15:31:07', 40000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(94, 2, '2025-12-21 15:33:48', 40000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(95, 2, '2025-12-21 15:33:58', 40000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(96, 2, '2025-12-21 15:34:17', 39000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(97, 2, '2025-12-21 15:38:59', 39000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(98, 2, '2025-12-21 15:39:16', 39000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(99, 2, '2025-12-21 15:44:38', 40000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(100, 2, '2025-12-21 15:44:56', 40000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(101, 2, '2025-12-21 15:48:33', 40000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(102, 2, '2025-12-21 15:52:08', 40000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(103, 1, '2025-12-21 15:53:25', 55000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(104, 1, '2025-12-21 15:54:05', 175000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(105, 1, '2025-12-21 16:09:00', 165000, 'cash', 'paid', NULL, NULL, 0.00, 0.00),
(106, 1, '2025-12-21 16:19:37', 275000, 'cash', 'paid', 2, NULL, 0.00, 0.00),
(107, 1, '2025-12-21 16:46:03', 40000, 'cash', 'paid', 3, 'ADMINVIP', 100.00, 0.00),
(108, 1, '2025-12-21 16:48:02', 55000, 'cash', 'paid', 3, 'WELCOME', 10.00, 49500.00),
(109, 1, '2025-12-21 16:48:44', 102000, 'cash', 'paid', 3, '', 0.00, 102000.00),
(110, 2, '2025-12-21 16:55:33', 220000, 'cash', 'paid', 4, 'WELCOME', 10.00, 198000.00),
(111, 2, '2025-12-21 17:00:45', 40000, 'cash', 'canceled', 4, '', 0.00, 40000.00),
(112, 2, '2025-12-21 17:01:13', 34000, 'cash', 'paid', 4, 'WELCOME', 10.00, 30600.00),
(113, 1, '2025-12-21 22:19:09', 144000, 'cash', 'canceled', 6, '', 0.00, 144000.00),
(116, 1, '2025-12-22 17:29:54', 78000, 'cash', 'paid', 7, '', 0.00, 78000.00),
(117, 1, '2025-12-22 19:13:49', 78000, 'cash', 'paid', 7, '', 0.00, 78000.00),
(118, 1, '2025-12-22 19:27:27', 60000, 'cash', 'paid', 7, '', 0.00, 60000.00),
(119, 1, '2025-12-23 14:45:02', 39000, 'cash', 'canceled', 13, '', 0.00, 39000.00),
(120, 1, '2025-12-23 15:59:06', 160000, 'cash', 'canceled', 14, '', 0.00, 160000.00),
(121, 1, '2025-12-23 16:01:00', 7800000, 'cash', 'canceled', 14, '', 0.00, 7800000.00),
(122, 1, '2025-12-23 16:01:23', 2769000, 'cash', 'canceled', 14, '', 0.00, 2769000.00),
(123, 1, '2025-12-23 16:02:22', 495000, 'cash', 'canceled', 14, '', 0.00, 495000.00),
(124, 1, '2025-12-23 16:02:52', 55000, 'cash', 'canceled', 14, '', 0.00, 55000.00),
(125, 1, '2025-12-23 16:16:26', 40000, 'cash', 'paid', 14, '', 0.00, 40000.00),
(126, 1, '2025-12-23 21:11:41', 40000, 'cash', 'paid', 15, 'ADMINVIP', 50.00, 20000.00),
(127, 1, '2025-12-23 21:30:18', 34000, 'cash', 'paid', 15, 'VIP69', 69.00, 10540.00),
(128, 1, '2025-12-23 21:30:41', 136000, 'cash', 'paid', 15, 'VIP69', 69.00, 42160.00),
(129, 1, '2025-12-24 21:46:17', 108000, 'transfer', 'paid', 16, '', 0.00, 108000.00),
(130, 1, '2025-12-25 00:59:41', 34000, 'transfer', 'paid', 17, 'ADMINVIP', 50.00, 17000.00);

-- --------------------------------------------------------

--
-- Table structure for table `order_items`
--

CREATE TABLE `order_items` (
  `id` int(11) NOT NULL,
  `order_id` int(11) NOT NULL,
  `product_id` int(11) NOT NULL,
  `quantity` int(11) NOT NULL,
  `note` varchar(255) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `order_items`
--

INSERT INTO `order_items` (`id`, `order_id`, `product_id`, `quantity`, `note`) VALUES
(1, 45, 5, 2, NULL),
(2, 45, 10, 1, NULL),
(3, 45, 4, 1, NULL),
(4, 45, 6, 1, NULL),
(5, 46, 6, 1, NULL),
(6, 46, 5, 2, NULL),
(7, 47, 1, 1, NULL),
(8, 47, 7, 1, NULL),
(9, 47, 8, 1, NULL),
(10, 48, 10, 2, NULL),
(11, 48, 2, 1, NULL),
(12, 49, 11, 1, NULL),
(13, 49, 6, 1, NULL),
(14, 50, 10, 1, NULL),
(15, 50, 9, 1, NULL),
(16, 51, 4, 1, NULL),
(17, 51, 3, 1, NULL),
(18, 51, 10, 1, NULL),
(19, 52, 4, 1, NULL),
(20, 53, 3, 1, NULL),
(21, 54, 5, 15, NULL),
(22, 55, 10, 25, NULL),
(23, 56, 6, 1, NULL),
(24, 56, 5, 2, NULL),
(25, 57, 6, 6, NULL),
(26, 57, 5, 1, NULL),
(27, 58, 10, 1, NULL),
(28, 58, 9, 2, NULL),
(29, 59, 6, 3, NULL),
(30, 60, 5, 9, NULL),
(33, 63, 6, 24, NULL),
(34, 64, 3, 73, NULL),
(36, 66, 4, 39, NULL),
(37, 67, 9, 22, NULL),
(38, 68, 8, 66, NULL),
(39, 69, 1, 1, NULL),
(40, 69, 7, 996, NULL),
(41, 70, 1, 223, NULL),
(42, 70, 7, 996, NULL),
(45, 72, 7, 998, NULL),
(46, 73, 4, 3, NULL),
(47, 74, 4, 12, NULL),
(48, 75, 4, 3, NULL),
(49, 76, 4, 4, NULL),
(50, 77, 4, 235, NULL),
(51, 78, 3, 3, NULL),
(52, 79, 4, 11, NULL),
(53, 79, 2, 333, NULL),
(54, 80, 5, 1, NULL),
(55, 81, 9, 4, NULL),
(56, 81, 7, 40, NULL),
(57, 82, 3, 1, NULL),
(58, 83, 3, 2, NULL),
(59, 84, 4, 4, NULL),
(60, 85, 3, 1, NULL),
(61, 89, 3, 4, 'Không đá'),
(62, 90, 3, 1, ''),
(63, 91, 4, 1, ''),
(64, 92, 3, 1, ''),
(65, 93, 4, 1, ''),
(66, 94, 4, 1, ''),
(67, 95, 4, 1, ''),
(68, 96, 3, 1, ''),
(69, 97, 3, 1, ''),
(70, 98, 3, 1, ''),
(71, 99, 4, 1, ''),
(72, 100, 4, 1, ''),
(73, 101, 4, 1, ''),
(74, 102, 4, 1, ''),
(75, 103, 5, 1, ''),
(76, 104, 4, 3, 'Ít đá, Mang về'),
(77, 104, 5, 1, ''),
(78, 105, 5, 3, ''),
(79, 106, 5, 5, ''),
(80, 107, 4, 1, ''),
(81, 108, 5, 1, ''),
(82, 109, 6, 3, ''),
(83, 110, 5, 4, ''),
(84, 111, 4, 1, ''),
(85, 112, 6, 1, ''),
(86, 113, 6, 1, ''),
(87, 113, 5, 2, ''),
(88, 116, 3, 2, ''),
(89, 117, 3, 2, ''),
(90, 118, 10, 2, ''),
(91, 119, 3, 1, ''),
(92, 120, 4, 4, ''),
(93, 121, 4, 195, ''),
(94, 122, 3, 71, ''),
(95, 123, 5, 9, ''),
(96, 124, 5, 1, ''),
(97, 125, 4, 1, ''),
(98, 126, 4, 1, ''),
(99, 127, 6, 1, ''),
(100, 128, 6, 4, ''),
(101, 129, 10, 1, ''),
(102, 129, 3, 2, ''),
(103, 130, 6, 1, '');

-- --------------------------------------------------------

--
-- Table structure for table `products`
--

CREATE TABLE `products` (
  `id` int(11) NOT NULL,
  `name` varchar(255) NOT NULL,
  `price` int(11) NOT NULL,
  `category_id` int(11) NOT NULL,
  `image_url` varchar(255) NOT NULL,
  `is_active` tinyint(1) NOT NULL DEFAULT 1,
  `status` tinyint(1) DEFAULT 1
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `products`
--

INSERT INTO `products` (`id`, `name`, `price`, `category_id`, `image_url`, `is_active`, `status`) VALUES
(1, 'Cà phê Đen', 25000, 1, '../assets/img/drink/ca-phe-den.jpg', 1, 1),
(2, 'Latte Đá', 45000, 1, '../assets/img/drink/latte-da.jpg', 1, 1),
(3, 'Trà Đào Cam Sả', 39000, 1, '../assets/img/drink/tra-dao-cam-sa.jpg', 1, 1),
(4, 'Nước Ép Cam', 40000, 1, '../assets/img/drink/nuoc-ep-cam.png', 1, 1),
(5, 'Sinh Tố Bơ', 55000, 1, '../assets/img/drink/sinh-to-bo.avif', 1, 1),
(6, 'Bánh Mousse ', 34000, 2, '../assets/img/food/banh-mousse-chanh-leo.png', 1, 1),
(7, 'Bánh Mì Bơ Tỏi', 29000, 2, '../assets/img/food/banh-mi-bo-toi.webp', 1, 1),
(8, 'Bánh Muffin Chocolate', 32000, 2, '../assets/img/food/banh-muffin-chocolate.jpg', 1, 1),
(9, 'Khoai Tây Chiên', 45000, 2, '../assets/img/food/khoai-tay-chien.jpg', 1, 1),
(10, 'Bánh Tiramisu', 30000, 2, '../assets/img/food/banh-tiramisu.png', 1, 1),
(11, 'banhmi', 15000, 1, 'uploads/1766027605.webp', 0, 0),
(12, 'coffe ', 30000, 1, 'uploads/1766337405_ca-phe-den.jpg', 0, 1),
(13, 'bánh mì bơ', 100000, 2, 'uploads/1766337497_pexels-photo-3915906.jpeg', 0, 1),
(14, 'vu hoang nghia', 1, 1, 'uploads/1766339255_hinh-cafe-kem-banh-quy.jpg', 0, 1),
(15, 'Test', 50000, 1, 'uploads/1766476283_images.jpg', 0, 1),
(16, 'TEst 2', 36000, 1, '/assets/img/drink/thumb_1766476678_images.jpg', 0, 1),
(17, 'abc test2', 53446, 1, '/assets/img/drink/thumb_1766476814_images.jpg', 0, 1),
(18, '312', 436, 1, '../../assets/img/drink/thumb_1766476924_images.jpg', 0, 1),
(19, 'r4feqa', 412, 1, 'C:\\xampp\\htdocs\\coffee/assets/img/drink/thumb_1766477190_images.jpg', 0, 1),
(20, 'fasd', 3123, 1, 'assets/img/drink/thumb_1766477234_images.jpg', 0, 1),
(21, 'đấ', 50000, 1, 'assets/img/drink/thumb_1766478190_images.jpg', 0, 1),
(22, 'da', 46777, 1, 'assets/img/no-image_url.png', 0, 1),
(23, 'ad', 43, 1, 'assets/img/no-image_url.png', 0, 1),
(24, '3213', 321332, 1, 'assets/img/drink/thumb_1766478903_ad.jpg', 0, 1),
(25, '312', 4214, 1, 'assets/img/drink/thumb_1766479105_ad.jpg', 0, 1),
(26, '43', 434, 1, 'assets/img/drink/thumb_1766479199_ad.jpg', 0, 1),
(27, '434', 4343, 1, 'assets/img/drink/1766479536_ad.jpg', 0, 1),
(28, '23', 323, 1, 'assets/img/drink/1766479597_ad.jpg', 0, 1),
(29, '55', 55, 2, 'assets/img/food/1766479673_ad.jpg', 0, 1),
(30, '324', 43, 1, 'assets/img/drink/1766479775_ad.jpg', 0, 1);

-- --------------------------------------------------------

--
-- Table structure for table `recipes`
--

CREATE TABLE `recipes` (
  `id` int(11) NOT NULL,
  `product_id` int(11) NOT NULL,
  `ingredient_id` int(11) NOT NULL,
  `quantity_required` float NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `recipes`
--

INSERT INTO `recipes` (`id`, `product_id`, `ingredient_id`, `quantity_required`) VALUES
(1, 1, 1, 20),
(2, 2, 1, 20),
(3, 2, 2, 150),
(4, 3, 3, 1),
(5, 3, 4, 0.5),
(9, 8, 6, 100),
(10, 8, 7, 30),
(11, 9, 8, 200),
(12, 6, 6, 50),
(13, 6, 2, 100),
(14, 10, 6, 50),
(15, 10, 2, 50),
(16, 10, 1, 20),
(17, 7, 9, 1),
(18, 7, 10, 25),
(19, 7, 11, 10),
(20, 7, 12, 1),
(21, 7, 13, 15),
(24, 12, 1, 100),
(25, 12, 2, 151),
(26, 13, 10, 100),
(27, 13, 9, 1),
(35, 14, 1, 5340),
(36, 14, 10, 3),
(37, 14, 5, 3),
(38, 5, 5, 2006),
(39, 4, 4, 100),
(40, 15, 4, 50),
(41, 16, 9, 6),
(42, 17, 9, 2),
(43, 18, 9, 245),
(44, 19, 9, 4),
(45, 20, 9, 434),
(46, 21, 9, 5),
(47, 22, 9, 3),
(48, 23, 9, 5),
(49, 24, 9, 45),
(50, 25, 10, 42),
(51, 26, 9, 4),
(52, 27, 9, 32),
(53, 28, 9, 23),
(54, 29, 9, 6),
(55, 30, 9, 32);

-- --------------------------------------------------------

--
-- Table structure for table `users`
--

CREATE TABLE `users` (
  `id` int(11) NOT NULL,
  `fullname` varchar(100) NOT NULL,
  `username` varchar(50) NOT NULL,
  `password` varchar(255) NOT NULL,
  `role` enum('admin','staff','wh-staff') NOT NULL DEFAULT 'staff',
  `status` tinyint(1) DEFAULT 1,
  `status_work` tinyint(1) DEFAULT 0 COMMENT '0: Off ca, 1: Đang trong ca',
  `created_at` timestamp NOT NULL DEFAULT current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `users`
--

INSERT INTO `users` (`id`, `fullname`, `username`, `password`, `role`, `status`, `status_work`, `created_at`) VALUES
(1, 'Admin', 'admin', '$2y$10$DxWZmJ0OdBN7Yp.HPXAUmusmf76YcwzMJjWF/QcIrBpqQnJtKpkPu', 'admin', 1, 0, '2025-12-18 03:32:02'),
(2, 'Staff test', 'staff', '$2y$10$DxWZmJ0OdBN7Yp.HPXAUmusmf76YcwzMJjWF/QcIrBpqQnJtKpkPu', 'staff', 1, 0, '2025-12-18 03:32:02'),
(3, 'Thủ kho', 'thukho', '$2y$10$DxWZmJ0OdBN7Yp.HPXAUmusmf76YcwzMJjWF/QcIrBpqQnJtKpkPu', 'wh-staff', 1, 0, '2025-12-20 11:06:00'),
(4, 'abc', 'test_admin', '$2y$10$BawJvubcJKWMB0MTj36TVeKdRCvl/CWXL17DqCq4WPDs4Ob0GJW4C', 'admin', 1, 0, '2025-12-23 07:48:30');

-- --------------------------------------------------------

--
-- Table structure for table `vouchers`
--

CREATE TABLE `vouchers` (
  `id` int(11) NOT NULL,
  `code` varchar(50) NOT NULL,
  `discount_percent` int(11) NOT NULL,
  `description` varchar(255) DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `vouchers`
--

INSERT INTO `vouchers` (`id`, `code`, `discount_percent`, `description`, `created_at`) VALUES
(1, 'WELCOME', 10, 'Giảm 10% cho khách mới', '2025-12-21 18:17:12'),
(2, 'VIP20', 20, 'Giảm 20% cho khách VIP', '2025-12-21 18:17:12'),
(3, 'ADMINVIP', 100, 'Miễn phí cho chủ quán', '2025-12-21 18:17:12'),
(4, 'VIP50', 50, '', '2025-12-23 14:22:36'),
(5, 'VIP69', 69, '', '2025-12-23 14:25:25');

-- --------------------------------------------------------

--
-- Table structure for table `work_schedules`
--

CREATE TABLE `work_schedules` (
  `id` int(11) NOT NULL,
  `user_id` int(11) NOT NULL,
  `shift_date` date NOT NULL,
  `shift_type` varchar(20) NOT NULL,
  `created_at` timestamp NOT NULL DEFAULT current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `work_schedules`
--

INSERT INTO `work_schedules` (`id`, `user_id`, `shift_date`, `shift_type`, `created_at`) VALUES
(3, 2, '2025-12-21', 'morning', '2025-12-23 09:52:11'),
(4, 3, '2025-12-22', 'morning', '2025-12-23 09:54:35'),
(6, 1, '2025-12-23', 'morning', '2025-12-23 09:57:21'),
(7, 3, '2025-12-23', 'evening', '2025-12-24 12:41:27'),
(8, 2, '2025-12-23', 'evening', '2025-12-24 12:45:34'),
(9, 2, '2025-12-24', 'afternoon', '2025-12-24 12:45:39'),
(10, 2, '2025-12-24', 'evening', '2025-12-24 12:45:42'),
(11, 3, '2025-12-24', 'evening', '2025-12-24 12:50:06');

-- --------------------------------------------------------

--
-- Table structure for table `work_sessions`
--

CREATE TABLE `work_sessions` (
  `id` int(11) NOT NULL,
  `user_id` int(11) NOT NULL,
  `start_time` datetime DEFAULT current_timestamp(),
  `end_time` datetime DEFAULT NULL,
  `start_cash` decimal(10,2) DEFAULT 0.00,
  `end_cash` decimal(10,2) DEFAULT 0.00,
  `total_sales` decimal(10,2) DEFAULT 0.00,
  `note` text DEFAULT NULL,
  `status` enum('open','closed') DEFAULT 'open'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- Dumping data for table `work_sessions`
--

INSERT INTO `work_sessions` (`id`, `user_id`, `start_time`, `end_time`, `start_cash`, `end_cash`, `total_sales`, `note`, `status`) VALUES
(1, 1, '2025-12-21 16:07:55', '2025-12-21 16:08:30', 500000.00, 50000.00, 0.00, '', 'closed'),
(2, 1, '2025-12-21 16:19:18', '2025-12-21 16:20:19', 500000.00, 1500000.00, 275000.00, '', 'closed'),
(3, 1, '2025-12-21 16:36:14', '2025-12-21 16:50:24', 500000.00, 50000.00, 197000.00, '', 'closed'),
(4, 2, '2025-12-21 16:50:38', '2025-12-21 21:44:33', 50000.00, 69000.00, 254000.00, 'Hệ thống tự chốt do nhân viên mới vào ca.', 'closed'),
(5, 1, '2025-12-21 21:44:33', '2025-12-21 22:09:31', 69000.00, 50000.00, 0.00, '', 'closed'),
(6, 1, '2025-12-21 22:19:05', '2025-12-22 17:19:46', 50000.00, 50000.00, 0.00, '[CHỐT CA]: TM:0 | CK:0 | Lệch:0. ', 'closed'),
(7, 1, '2025-12-22 17:28:57', '2025-12-22 19:34:26', 50000.00, 50000.00, 216000.00, '', 'closed'),
(8, 1, '2025-12-22 21:13:41', '2025-12-22 21:50:24', 50000.00, 50000.00, 0.00, '', 'closed'),
(9, 1, '2025-12-22 21:54:50', '2025-12-22 22:07:25', 50000.00, 50000.00, 0.00, '', 'closed'),
(10, 1, '2025-12-22 22:09:22', '2025-12-22 22:16:12', 50000.00, 50000.00, 0.00, 'Hệ thống tự chốt do nhân viên mới vào ca.', 'closed'),
(11, 2, '2025-12-22 22:16:12', '2025-12-22 22:25:24', 50000.00, 50000.00, 0.00, 'Hệ thống tự chốt do nhân viên mới vào ca.', 'closed'),
(12, 1, '2025-12-22 22:25:24', '2025-12-23 14:39:32', 50000.00, 50000.00, 0.00, '', 'closed'),
(13, 1, '2025-12-23 14:44:28', '2025-12-23 14:48:52', 50000.00, 50000.00, 0.00, '', 'closed'),
(14, 1, '2025-12-23 14:50:10', '2025-12-23 16:49:36', 50000.00, 0.00, 40000.00, '', 'closed'),
(15, 1, '2025-12-23 21:11:27', '2025-12-24 19:40:11', 50000.00, 50000.00, 210000.00, '', 'closed'),
(16, 1, '2025-12-24 19:54:41', '2025-12-24 21:50:09', 50000.00, 50000.00, 108000.00, '', 'closed'),
(17, 1, '2025-12-25 00:58:55', NULL, 50000.00, 0.00, 0.00, NULL, 'open');

--
-- Indexes for dumped tables
--

--
-- Indexes for table `categories`
--
ALTER TABLE `categories`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `ingredients`
--
ALTER TABLE `ingredients`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `inventory_log`
--
ALTER TABLE `inventory_log`
  ADD PRIMARY KEY (`id`),
  ADD KEY `ingredient_id` (`ingredient_id`);

--
-- Indexes for table `orders`
--
ALTER TABLE `orders`
  ADD PRIMARY KEY (`id`),
  ADD KEY `fk_order_session` (`session_id`);

--
-- Indexes for table `order_items`
--
ALTER TABLE `order_items`
  ADD PRIMARY KEY (`id`),
  ADD KEY `order_id` (`order_id`),
  ADD KEY `product_id` (`product_id`);

--
-- Indexes for table `products`
--
ALTER TABLE `products`
  ADD PRIMARY KEY (`id`),
  ADD KEY `category_id` (`category_id`);

--
-- Indexes for table `recipes`
--
ALTER TABLE `recipes`
  ADD PRIMARY KEY (`id`),
  ADD KEY `product_id` (`product_id`),
  ADD KEY `ingredient_id` (`ingredient_id`);

--
-- Indexes for table `users`
--
ALTER TABLE `users`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `username` (`username`);

--
-- Indexes for table `vouchers`
--
ALTER TABLE `vouchers`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `code` (`code`);

--
-- Indexes for table `work_schedules`
--
ALTER TABLE `work_schedules`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `unique_shift` (`user_id`,`shift_date`,`shift_type`);

--
-- Indexes for table `work_sessions`
--
ALTER TABLE `work_sessions`
  ADD PRIMARY KEY (`id`),
  ADD KEY `user_id` (`user_id`);

--
-- AUTO_INCREMENT for dumped tables
--

--
-- AUTO_INCREMENT for table `categories`
--
ALTER TABLE `categories`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=3;

--
-- AUTO_INCREMENT for table `ingredients`
--
ALTER TABLE `ingredients`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=15;

--
-- AUTO_INCREMENT for table `inventory_log`
--
ALTER TABLE `inventory_log`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=26;

--
-- AUTO_INCREMENT for table `orders`
--
ALTER TABLE `orders`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=131;

--
-- AUTO_INCREMENT for table `order_items`
--
ALTER TABLE `order_items`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=104;

--
-- AUTO_INCREMENT for table `products`
--
ALTER TABLE `products`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=31;

--
-- AUTO_INCREMENT for table `recipes`
--
ALTER TABLE `recipes`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=56;

--
-- AUTO_INCREMENT for table `users`
--
ALTER TABLE `users`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=12;

--
-- AUTO_INCREMENT for table `vouchers`
--
ALTER TABLE `vouchers`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=6;

--
-- AUTO_INCREMENT for table `work_schedules`
--
ALTER TABLE `work_schedules`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=12;

--
-- AUTO_INCREMENT for table `work_sessions`
--
ALTER TABLE `work_sessions`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=18;

--
-- Constraints for dumped tables
--

--
-- Constraints for table `inventory_log`
--
ALTER TABLE `inventory_log`
  ADD CONSTRAINT `inventory_log_ibfk_1` FOREIGN KEY (`ingredient_id`) REFERENCES `ingredients` (`id`) ON DELETE CASCADE;

--
-- Constraints for table `orders`
--
ALTER TABLE `orders`
  ADD CONSTRAINT `fk_order_session` FOREIGN KEY (`session_id`) REFERENCES `work_sessions` (`id`);

--
-- Constraints for table `order_items`
--
ALTER TABLE `order_items`
  ADD CONSTRAINT `order_id` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`),
  ADD CONSTRAINT `product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`);

--
-- Constraints for table `products`
--
ALTER TABLE `products`
  ADD CONSTRAINT `category_id` FOREIGN KEY (`category_id`) REFERENCES `categories` (`id`);

--
-- Constraints for table `recipes`
--
ALTER TABLE `recipes`
  ADD CONSTRAINT `recipes_ibfk_1` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  ADD CONSTRAINT `recipes_ibfk_2` FOREIGN KEY (`ingredient_id`) REFERENCES `ingredients` (`id`) ON DELETE CASCADE;

--
-- Constraints for table `work_schedules`
--
ALTER TABLE `work_schedules`
  ADD CONSTRAINT `work_schedules_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE;

--
-- Constraints for table `work_sessions`
--
ALTER TABLE `work_sessions`
  ADD CONSTRAINT `work_sessions_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`);
COMMIT;

/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;

---------------- END FILE ----------------

---------------- START FILE: config.inc.php ----------------
<?php
/*
 * This is needed for cookie based authentication to encrypt password in
 * cookie
 */
$cfg['blowfish_secret'] = 'xampp'; /* YOU SHOULD CHANGE THIS FOR A MORE SECURE COOKIE AUTH! */

/*
 * Servers configuration
 */
$i = 0;

/*
 * First server
 */
$i++;

/* Authentication type and info */
$cfg['Servers'][$i]['auth_type'] = 'cookie';
$cfg['Servers'][$i]['user'] = 'coffee';
$cfg['Servers'][$i]['password'] = '123456';
$cfg['Servers'][$i]['extension'] = 'mysqli';
$cfg['Servers'][$i]['AllowNoPassword'] = true;
$cfg['Lang'] = '';

/* Bind to the localhost ipv4 address and tcp */
$cfg['Servers'][$i]['host'] = '127.0.0.1';
$cfg['Servers'][$i]['connect_type'] = 'tcp';

/* User for advanced features */
$cfg['Servers'][$i]['controluser'] = 'pma';
$cfg['Servers'][$i]['controlpass'] = '';

/* Advanced phpMyAdmin features */
$cfg['Servers'][$i]['pmadb'] = 'phpmyadmin';
$cfg['Servers'][$i]['bookmarktable'] = 'pma__bookmark';
$cfg['Servers'][$i]['relation'] = 'pma__relation';
$cfg['Servers'][$i]['table_info'] = 'pma__table_info';
$cfg['Servers'][$i]['table_coords'] = 'pma__table_coords';
$cfg['Servers'][$i]['pdf_pages'] = 'pma__pdf_pages';
$cfg['Servers'][$i]['column_info'] = 'pma__column_info';
$cfg['Servers'][$i]['history'] = 'pma__history';
$cfg['Servers'][$i]['designer_coords'] = 'pma__designer_coords';
$cfg['Servers'][$i]['tracking'] = 'pma__tracking';
$cfg['Servers'][$i]['userconfig'] = 'pma__userconfig';
$cfg['Servers'][$i]['recent'] = 'pma__recent';
$cfg['Servers'][$i]['table_uiprefs'] = 'pma__table_uiprefs';
$cfg['Servers'][$i]['users'] = 'pma__users';
$cfg['Servers'][$i]['usergroups'] = 'pma__usergroups';
$cfg['Servers'][$i]['navigationhiding'] = 'pma__navigationhiding';
$cfg['Servers'][$i]['savedsearches'] = 'pma__savedsearches';
$cfg['Servers'][$i]['central_columns'] = 'pma__central_columns';
$cfg['Servers'][$i]['designer_settings'] = 'pma__designer_settings';
$cfg['Servers'][$i]['export_templates'] = 'pma__export_templates';
$cfg['Servers'][$i]['favorite'] = 'pma__favorite';

/*
 * End of servers configuration
 */

?>

---------------- END FILE ----------------

---------------- START FILE: create_hash.php ----------------
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>PHP Password Hash Generator</title>
    <style>
        body { font-family: sans-serif; margin: 40px; line-height: 1.6; }
        .result { background: #f4f4f4; padding: 15px; border-left: 5px solid #2ecc71; word-break: break-all; }
        input[type="text"] { padding: 8px; width: 300px; }
        button { padding: 8px 15px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>Tạo mã Hash cho mật khẩu</h2>

    <form method="POST" action="">
        <input type="text" name="password_string" placeholder="Nhập chuỗi cần hash..." required>
        <button type="submit" name="submit">Hash Password</button>
    </form>

    <br>

    <?php
    if (isset($_POST['submit'])) {
        // Lấy dữ liệu từ input
        $inputString = $_POST['password_string'];

        /**
         * password_hash() tạo ra một chuỗi hash bảo mật.
         * PASSWORD_DEFAULT: Sử dụng thuật toán mạnh nhất hiện tại (thường là Bcrypt).
         */
        $hashedPassword = password_hash($inputString, PASSWORD_DEFAULT);

        echo "<div class='result'>";
        echo "<strong>Chuỗi gốc:</strong> " . htmlspecialchars($inputString) . "<br>";
        echo "<strong>Kết quả password_hash():</strong><br> <code>" . $hashedPassword . "</code>";
        echo "</div>";
        
        echo "<p><small><em>Lưu ý: Mỗi lần bạn nhấn Submit, mã hash sẽ thay đổi (do cơ chế 'salt' tự động) nhưng đều hợp lệ khi kiểm tra bằng password_verify().</em></small></p>";
    }
    ?>

</body>
</html>
---------------- END FILE ----------------

---------------- START FILE: erp.py ----------------
import os
import datetime

# --- CẤU HÌNH LỌC ---
IGNORED_DIRS = {'.git', 'node_modules', 'vendor', 'fonts', '.idea', '.vscode', '__pycache__'}
BINARY_EXTS = {'.png', '.jpg', '.jpeg', '.gif', '.ico', '.pdf', '.zip', '.exe', '.woff', '.woff2'}
# Các file code Logic quan trọng cần AI đọc (PHP, SQL)
LOGIC_EXTS = {'.php', '.sql', '.py'} 
# Các file giao diện chỉ cần đếm, không cần đọc nội dung
VIEW_EXTS = {'.html', '.css', '.js'} 

def scan_and_export(root_folder, output_file="project_scan_output.txt"):
    """
    Quét folder dự án và xuất ra báo cáo TXT được format chuẩn.
    """
    print(f"Dang quet du an: {root_folder}...")
    
    # Khởi tạo dữ liệu
    summary = {
        'project_name': os.path.basename(os.path.normpath(root_folder)),
        'scan_time': datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        'structure': "",
        'code_content': "",
        'logs': [],
        'stats': {
            'total_files': 0,
            'php_files': 0,
            'view_files': 0, # HTML/CSS/JS
            'sql_files': 0,
            'images': 0,
            'logic_lines': 0
        }
    }

    # Bắt đầu duyệt cây thư mục
    for root, dirs, files in os.walk(root_folder):
        # 1. Loại bỏ folder rác (Sửa trực tiếp list dirs để không duyệt sâu vào)
        dirs[:] = [d for d in dirs if d not in IGNORED_DIRS]
        
        # Tạo cây thư mục (Structure)
        level = root.replace(root_folder, '').count(os.sep)
        indent = '    ' * level
        folder_name = os.path.basename(root)
        if level == 0: folder_name = summary['project_name'] # Root folder
        summary['structure'] += f"{indent}{folder_name}/\n"
        
        for f in files:
            file_path = os.path.join(root, f)
            ext = os.path.splitext(f)[1].lower()
            summary['stats']['total_files'] += 1
            
            # Ghi vào cây thư mục
            summary['structure'] += f"{indent}    {f}\n"

            # 2. Xử lý File Binary/Ảnh
            if ext in BINARY_EXTS:
                summary['stats']['images'] += 1
                summary['logs'].append(f"[SKIPPED BINARY] {os.path.join(root, f)}")
            
            # 3. Xử lý File View (HTML/CSS/JS) - Chỉ đếm
            elif ext in VIEW_EXTS:
                summary['stats']['view_files'] += 1
                # Không đọc nội dung để tiết kiệm token
            
            # 4. Xử lý File Logic (PHP/SQL) - Đọc nội dung cho AI
            elif ext in LOGIC_EXTS:
                if ext == '.php': summary['stats']['php_files'] += 1
                if ext == '.sql': summary['stats']['sql_files'] += 1
                
                try:
                    with open(file_path, 'r', encoding='utf-8', errors='ignore') as file:
                        content = file.read()
                        line_count = len(content.splitlines())
                        summary['stats']['logic_lines'] += line_count
                        
                        # Format nội dung để gửi AI
                        rel_path = os.path.relpath(file_path, root_folder)
                        summary['code_content'] += f"\n---------------- START FILE: {rel_path} ----------------\n"
                        summary['code_content'] += content
                        summary['code_content'] += f"\n---------------- END FILE ----------------\n"
                except Exception as e:
                    summary['logs'].append(f"[ERROR READING] {f}: {str(e)}")
            
            else:
                summary['logs'].append(f"[IGNORED TYPE] {f}")

    # --- GHI RA FILE TXT ---
    write_report_file(output_file, summary)
    print(f"Hoan tat! Da xuat file: {output_file}")


def write_report_file(filename, data):
    """Hàm phụ trợ để ghi file TXT theo format đẹp"""
    
    with open(filename, 'w', encoding='utf-8') as f:
        # PHẦN 1: THỐNG KÊ
        f.write("="*64 + "\n")
        f.write("PHẦN 1: THỐNG KÊ TỔNG QUAN (DÙNG CHO EXCEL REPORT)\n")
        f.write("="*64 + "\n")
        f.write(f"Project Name: {data['project_name']}\n")
        f.write(f"Scan Date:    {data['scan_time']}\n")
        f.write(f"Total Files:  {data['stats']['total_files']}\n")
        f.write("-" * 32 + "\n")
        f.write("[File Counts by Type]\n")
        f.write(f"- PHP Files (Logic):    {data['stats']['php_files']}\n")
        f.write(f"- HTML/CSS/JS (View):   {data['stats']['view_files']}\n")
        f.write(f"- SQL (Database):       {data['stats']['sql_files']}\n")
        f.write(f"- Images/Assets:        {data['stats']['images']} (Đã bỏ qua nội dung)\n")
        f.write("-" * 32 + "\n")
        f.write("[Code Volume]\n")
        f.write(f"- Total Lines of Logic: {data['stats']['logic_lines']} lines\n\n")

        # PHẦN 2: CẤU TRÚC
        f.write("="*64 + "\n")
        f.write("PHẦN 2: CẤU TRÚC THƯ MỤC (PROJECT TREE)\n")
        f.write("="*64 + "\n")
        f.write(data['structure'])
        f.write("\n")

        # PHẦN 3: NỘI DUNG CODE
        f.write("="*64 + "\n")
        f.write("PHẦN 3: NỘI DUNG CODE CỐT LÕI (CONTEXT CHO CLAUDE)\n")
        f.write("="*64 + "\n")
        f.write(">>> CHỈ DẪN CHO AI: Dưới đây là logic xử lý và CSDL.\n")
        f.write(">>> Hãy bỏ qua CSS/HTML. Hãy dùng thông tin này vẽ DFD và ERD.\n")
        f.write(data['code_content'])
        f.write("\n")

        # PHẦN 4: LOGS
        f.write("="*64 + "\n")
        f.write("PHẦN 4: LOG CÁC FILE ĐÃ BỎ QUA HOẶC LỖI (DEBUG)\n")
        f.write("="*64 + "\n")
        for log in data['logs']:
            f.write(log + "\n")

# --- CHẠY CHƯƠNG TRÌNH ---
if __name__ == "__main__":
    # Thay đổi đường dẫn này thành folder dự án của bạn
    PROJECT_PATH = r"C:\xampp\htdocs\coffee" 
    
    # Tên file xuất ra
    OUTPUT_FILE = "ket_qua_scan.txt"
    
    scan_and_export(PROJECT_PATH, OUTPUT_FILE)
---------------- END FILE ----------------

---------------- START FILE: index.php ----------------
<?php
session_start();

// 1. Kiểm tra đăng nhập
if (!isset($_SESSION['user_id'])|| !in_array($_SESSION['role'], ['admin'])) {
    header("Location: login.php");
    exit;
}

// Lấy thông tin
$fullname = $_SESSION['fullname'];
$role = $_SESSION['role']; 

// Xử lý hiển thị tên chức vụ cho đẹp
$role_label = 'Nhân viên';
if ($role === 'admin') $role_label = 'Quản lý cấp cao';
if ($role === 'wh-staff') $role_label = 'Thủ kho';
?>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Nguyễn Văn Coffee</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .dashboard-container { margin-top: 50px; }
        .welcome-banner { background: #6f4e37; color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        
        .feature-card {
            border: none;
            border-radius: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            height: 100%;
            text-decoration: none; 
            color: inherit;
            display: block; /* Đảm bảo thẻ a full block */
        }
        .feature-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card-icon { font-size: 3rem; margin-bottom: 15px; }
        
        /* Màu sắc cho từng role */
        .bg-pos { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; }
        .bg-admin { background: linear-gradient(135deg, #eb3349, #f45c43); color: white; }
        /* [MỚI] Màu cho kho (Xanh dương đậm) */
        .bg-warehouse { background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white; }
    </style>
</head>
<body>

<div class="container dashboard-container">
    <div class="welcome-banner d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-0">Xin chào, <?= htmlspecialchars($fullname) ?>!</h2>
            <small>Chức vụ: <strong><?= $role_label ?></strong></small>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div class="modal fade" id="modalEndShiftRoot" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fa-solid fa-door-closed"></i> KẾT THÚC CA & ĐĂNG XUẤT</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark">
                <div class="alert alert-warning">
                    <i class="fa-solid fa-triangle-exclamation"></i> Hệ thống phát hiện bạn đang trong ca làm việc. Vui lòng chốt tiền để đăng xuất.
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Tổng tiền mặt thực tế trong két:</label>
                    <input type="number" id="root-end-cash-input" class="form-control form-control-lg" placeholder="Nhập số tiền...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ghi chú (nếu lệch tiền):</label>
                    <textarea id="root-end-note-input" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="endShiftRoot()">Chốt ca & Đăng xuất</button>
            </div>
        </div>
    </div>
</div>

<script>


    function endShiftRoot() {
        const cashInput = document.getElementById('root-end-cash-input');
        const noteInput = document.getElementById('root-end-note-input');

        // Validate nhập tiền
        if (!cashInput || cashInput.value.trim() === "") {
            alert("Vui lòng nhập số tiền mặt thực tế trong két!");
            cashInput?.focus();
            return;
        }

        if (!confirm("Xác nhận chốt ca và đăng xuất khỏi hệ thống?")) return;

        const cash = cashInput.value;
        const note = noteInput ? noteInput.value : '';

        // Gọi API chốt ca (Lưu ý đường dẫn: đang ở root nên vào folder core/)
        fetch('core/session_manager.php?action=end_shift', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ end_cash: cash, note: note })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message); // Thông báo doanh thu
                window.location.href = 'login.php'; // Đá về trang login
            } else {
                alert("Lỗi Server: " + data.message);
            }
        })
        .catch(err => {
            console.error("Lỗi kết nối:", err);
            alert("Không thể kết nối đến Server. Vui lòng kiểm tra mạng.");
        });
    }
</script>

</body> 




<button class="btn btn-outline-danger btn-sm ms-2" onclick="confirmLogout()">
    <i class="fa-solid fa-right-from-bracket"></i> Thoát ca
</button>
    </div>

    <div class="row justify-content-center g-4">
        
        <?php if ($role === 'admin' || $role === 'staff'): ?>
        <div class="col-md-4 col-sm-6">
            <a href="pos/index.php" class="card feature-card bg-pos text-center p-5">
                <div class="card-body">
                    <i class="fa-solid fa-cash-register card-icon"></i>
                    <h3>Bán Hàng</h3>
                    <p>POS & Thu ngân</p>
                </div>
            </a>
        </div>
        <?php endif; ?>

        <?php if ($role === 'admin' || $role === 'wh-staff'): ?>
        <div class="col-md-4 col-sm-6">
            <a href="warehouse/index.php" class="card feature-card bg-warehouse text-center p-5">
                <div class="card-body">
                    <i class="fa-solid fa-boxes-stacked card-icon"></i>
                    <h3>Kho Hàng</h3>
                    <p>Nhập kho & Kiểm kê</p>
                </div>
            </a>
        </div>
        <?php endif; ?>

        <?php if ($role === 'admin'): ?>
        <div class="col-md-4 col-sm-6">
            <a href="admin/index.php" class="card feature-card bg-admin text-center p-5">
                <div class="card-body">
                    <i class="fa-solid fa-chart-line card-icon"></i>
                    <h3>Quản Trị</h3>
                    <p>Quản lý & Doanh thu</p>
                </div>
            </a>
        </div>
        <?php endif; ?>

    </div>
</div>
<script>
    function confirmLogout() {
    // 1. Kiểm tra xem user có đang trong ca làm việc không
    fetch('core/session_manager.php?action=check_status')
    .then(res => res.json())
    .then(data => {
        if (data.success && data.is_open) {
            // TRƯỜNG HỢP 1: ĐANG TRONG CA
            // Hiển thị modal bắt chốt tiền (id modal của bạn là modalEndShiftRoot)
            const modal = new bootstrap.Modal(document.getElementById('modalEndShiftRoot'));
            modal.show();
        } else {
            // TRƯỜNG HỢP 2: CHƯA VÀO CA (hoặc lỗi dữ liệu)
            // Đăng xuất thẳng luôn, không hiện modal lằng nhằng
            window.location.href = 'logout.php';
        }
    })
    .catch(err => {
        console.error("Lỗi kết nối:", err);
        // Nếu lỗi API, mặc định cho logout luôn để nhân viên không bị kẹt
        window.location.href = 'logout.php';
    });
}
</script>
<div id="origin-signature" 
     style="position: fixed; bottom: 30px; left: 0; width: 100%; text-align: center;
            font-family: 'Segoe UI', sans-serif; font-size: 14px; color: #888;
            opacity: 0; pointer-events: none; transition: opacity 1.5s ease-in-out; z-index: 99999;
            letter-spacing: 1px;">
    
    Built with <i class="fa-solid fa-heart" style="color: #ff4d6d; animation: heartbeat 1.5s infinite;"></i> for 
    
    <span style="color: #ebcade; font-weight: 700; text-shadow: 0 0 5px rgba(235, 202, 222, 0.5);">
        Elysia
    </span>
    
    <span style="margin: 0 5px;">&</span>
    
    <span style="color: #f7d1de; font-weight: 700; text-shadow: 0 0 8px rgba(247, 209, 222, 0.8);">
        Cyrene
    </span>
    <audio id="morse-audio" preload="auto" style="display: none;">
    <source src="./NewPage.mp3" type="audio/mpeg">
  </audio>
</div>

<style>
    @keyframes heartbeat {
        0% { transform: scale(1); }
        15% { transform: scale(1.3); }
        30% { transform: scale(1); }
        45% { transform: scale(1.15); }
        60% { transform: scale(1); }
    }
</style>

<script>
    (function() {
    const secretOrigin = "origin";
    const secretLoop = "loop";
    let input = "";
    
    const signature = document.getElementById('origin-signature');
    const audio = document.getElementById('morse-audio');
    
    let hideTimer;
    let isVisible = false;
    let isLooping = false;

    document.addEventListener('keydown', (e) => {
        if (e.key.length === 1 && e.key.match(/[a-z]/i)) {
            input += e.key.toLowerCase();
            
            // Giữ bộ nhớ đệm đủ dài cho cả "origin" và "loop"
            if (input.length > 10) input = input.slice(-10);

            // Kiểm tra lệnh ORIGIN
            if (input.endsWith(secretOrigin)) {
                toggleOrigin();
                input = ""; 
            }
            
            // Kiểm tra lệnh LOOP
            if (input.endsWith(secretLoop)) {
                toggleLoop();
                input = "";
            }
        }
    });

    function toggleOrigin() {
        if (!isVisible) {
            // HIỆN
            isVisible = true;
            signature.style.opacity = "1";
            signature.style.pointerEvents = "auto";
            
            if (audio) {
                audio.volume = 1;
                audio.currentTime = 0;
                audio.play();
                // Khi bật origin, mặc định sẽ tự tắt sau 46s TRỪ KHI đang bật loop
                startHideTimer();
            }
        } else {
            // TẮT NGAY LẬP TỨC
            fadeOutAndHide();
        }
    }

    function toggleLoop() {
        if (!isVisible) return; // Nếu chưa hiện chữ/nhạc thì lệnh loop không có tác dụng

        isLooping = !isLooping; // Đảo trạng thái loop
        
        if (audio) {
            audio.loop = isLooping;
        }

        if (isLooping) {
            console.log("Loop Enabled");
            if (hideTimer) clearTimeout(hideTimer); // Hủy đếm ngược tắt nhạc
            // Có thể thêm hiệu ứng nhẹ để biết loop đang bật (ví dụ: đổi màu tim)
            document.querySelector('.fa-heart').style.textShadow = "0 0 10px #ff4d6d";
        } else {
            console.log("Loop Disabled");
            document.querySelector('.fa-heart').style.textShadow = "none";
            startHideTimer(); // Bắt đầu lại đếm ngược để tắt sau khi bỏ loop
        }
    }

    function startHideTimer() {
        if (hideTimer) clearTimeout(hideTimer);
        // Chỉ chạy timer nếu KHÔNG ở chế độ loop
        if (!isLooping) {
            hideTimer = setTimeout(() => {
                fadeOutAndHide();
            }, 46000);
        }
    }

    function fadeOutAndHide() {
        isVisible = false;
        isLooping = false; // Reset luôn trạng thái loop
        if (audio) audio.loop = false;
        
        signature.style.opacity = "0";
        signature.style.pointerEvents = "none";
        
        if (hideTimer) clearTimeout(hideTimer);

        if (audio && !audio.paused) {
            let fadeInterval = setInterval(() => {
                if (audio.volume > 0.05) {
                    audio.volume -= 0.05;
                } else {
                    audio.pause();
                    audio.currentTime = 0;
                    audio.volume = 1;
                    clearInterval(fadeInterval);
                }
            }, 75);
        }
    }
})();
</script>
</body>
</html>
---------------- END FILE ----------------

---------------- START FILE: login.php ----------------
<?php
session_start();

// 1. Gọi file kết nối
require_once './includes/db_connection.php';

// 2. Khai báo sử dụng biến toàn cục $mysqli
global $mysqli;

// --- PHẦN TỰ ĐỘNG CẬP NHẬT TRẠNG THÁI CA LÀM VIỆC ---
if ($mysqli) {
    date_default_timezone_set('Asia/Ho_Chi_Minh'); 
    
    $cur_date = date('Y-m-d');
    $cur_hour = (int)date('H');
    $cur_min  = (int)date('i');
    $shift = '';

    // Xác định ca hiện tại
    if ($cur_hour >= 7 && $cur_hour < 12) {
        $shift = 'morning';
    } elseif ($cur_hour >= 12 && $cur_hour < 17) {
        $shift = 'afternoon';
    } elseif ($cur_hour >= 17) {
        // Ca tối: 17h -> 23h30
        if ($cur_hour < 23 || ($cur_hour == 23 && $cur_min <= 30)) {
            $shift = 'evening';
        }
    }

    // Reset và cập nhật trạng thái làm việc
    $mysqli->query("UPDATE users SET status_work = 0");

    if ($shift) {
        $stmt_update = $mysqli->prepare("
            UPDATE users u
            JOIN work_schedules ws ON u.id = ws.user_id
            SET u.status_work = 1
            WHERE ws.shift_date = ? AND ws.shift_type = ? AND u.status = 1
        ");
        if ($stmt_update) {
            $stmt_update->bind_param("ss", $cur_date, $shift);
            $stmt_update->execute();
            $stmt_update->close();
        }
    }
}
// --------------------------------------------------------------------------

$error = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = trim($_POST['username']);
    $password = $_POST['password'];

    if (!$mysqli) {
        die("Lỗi: Biến kết nối CSDL (\$mysqli) bị null.");
    }

    // Lấy thông tin user
    $stmt = $mysqli->prepare("SELECT id, fullname, password, role, status_work FROM users WHERE username = ? AND status = 1");
    
    if ($stmt) {
        $stmt->bind_param("s", $username);
        $stmt->execute();
        $result = $stmt->get_result();

        if ($result->num_rows === 1) {
            $user = $result->fetch_assoc();
            
            // Kiểm tra mật khẩu
            if (password_verify($password, $user['password'])) {
                
                // --- KIỂM TRA LỊCH LÀM VIỆC (ĐÃ SỬA) ---
                // Điều kiện chặn:
                // 1. Không phải Admin
                // 2. VÀ Không phải Thủ kho (wh-staff)
                // 3. VÀ Không có lịch (status_work = 0)
                
                if ($user['role'] !== 'admin' && $user['role'] !== 'wh-staff' && $user['status_work'] == 0) {
                    $error = "Bạn KHÔNG CÓ LỊCH làm việc vào giờ này (" . date('H:i') . ")!";
                } else {
                    // Đăng nhập thành công -> Lưu session
                    $_SESSION['user_id'] = $user['id'];
                    $_SESSION['fullname'] = $user['fullname'];
                    $_SESSION['role'] = $user['role'];
                    
                    // --- PHÂN QUYỀN CHUYỂN HƯỚNG ---
                    if ($user['role'] == 'admin') {
                        header("Location: index.php");
                    } elseif ($user['role'] == 'wh-staff') {
                        // Thủ kho vào trang kho
                        header("Location: warehouse/index.php");
                    } else {
                        // Nhân viên bán hàng vào POS
                        header("Location: pos/index.php");
                    }
                    exit;
                }

            } else {
                $error = "Mật khẩu không đúng!";
            }
        } else {
            $error = "Tài khoản không tồn tại hoặc bị khóa!";
        }
        $stmt->close();
    } else {
        $error = "Lỗi hệ thống: " . $mysqli->error;
    }
}
?>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập Coffee Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f1ea; display: flex; align-items: center; justify-content: center; height: 100vh; }
        .login-card { width: 100%; max-width: 400px; padding: 2rem; border-radius: 15px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-coffee { background-color: #6f4e37; color: white; }
        .btn-coffee:hover { background-color: #5a3e2b; color: white; }
    </style>
</head>
<body>
    <div class="login-card">
        <h3 class="text-center mb-4 text-uppercase fw-bold" style="color: #6f4e37;">Coffee Login</h3>
        
        <?php if ($error): ?>
            <div class="alert alert-danger text-center"><?= $error ?></div>
        <?php endif; ?>

        <form action="login.php" method="POST" id="loginForm">
            <div class="mb-3">
                <label class="form-label">Tên đăng nhập</label>
                <input type="text" name="username" class="form-control" required autofocus 
                       value="<?= isset($username) ? htmlspecialchars($username) : '' ?>">
            </div>
            <div class="mb-3">
                <label class="form-label">Mật khẩu</label>
                <input type="password" name="password" class="form-control" required id="passwordField">
            </div>
            
            <button type="submit" name="login_btn" id="loginBtn" class="btn btn-coffee w-100 py-2">Đăng Nhập</button>
        </form>
    </div>

<script>
    // Lắng nghe sự kiện phím bấm trên ô Mật khẩu
    document.getElementById('passwordField').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Ngăn hành vi Enter mặc định
            document.getElementById('loginBtn').click(); // Kích hoạt nút bấm
        }
    });
</script>
</body>
</html>
---------------- END FILE ----------------

---------------- START FILE: logout.php ----------------
<?php
session_start();
session_unset();
session_destroy();
header("Location: login.php");
exit;
?>
---------------- END FILE ----------------

---------------- START FILE: admin\index.php ----------------
<?php
session_start();
require_once '../includes/db_connection.php';

// 1. Chặn truy cập trái phép
if (!isset($_SESSION['user_id']) || ($_SESSION['role'] !== 'admin')) {
    header("Location: ../login.php");
    exit;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quản lý Cửa Hàng Cafe</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="assets/plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="assets/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="tinh-nang/display-item.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      .modal-backdrop { z-index: 1040 !important; }
      .modal { z-index: 1050 !important; }
      .mode-section { display: none; }
      
      /* CSS cho bảng lịch */
      .table-schedule th { text-align: center; vertical-align: middle; background-color: #343a40; color: white; }
      .table-schedule td { height: 100px; vertical-align: top; position: relative; }
      .shift-item { background: #e8f5e9; border: 1px solid #4caf50; padding: 2px 5px; margin-bottom: 2px; border-radius: 3px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
      .shift-item .btn-del-shift { color: #dc3545; cursor: pointer; margin-left: 5px; }
      .btn-add-shift { position: absolute; bottom: 5px; right: 5px; font-size: 0.7rem; }

      /* CSS cho nút chọn danh mục */
      .category-selector { display: flex; gap: 15px; margin-bottom: 10px; }
      .btn-category {
          flex: 1; padding: 15px; border: none; border-radius: 12px; background: white; color: #555; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; border: 2px solid transparent;
      }
      .btn-category i { margin-right: 10px; font-size: 1.4rem; }
      .btn-category:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
      .btn-category.active[data-type="drink"] { background: linear-gradient(135deg, #3c8dbc, #2980b9); color: white; box-shadow: 0 4px 10px rgba(60, 141, 188, 0.4); }
      .btn-category.active[data-type="food"] { background: linear-gradient(135deg, #e67e22, #d35400); color: white; box-shadow: 0 4px 10px rgba(230, 126, 34, 0.4); }
  </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
  
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav"><li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a></li></ul>
    <ul class="navbar-nav ml-auto">       
      <li class="nav-item">
          <form class="form-inline" id="searchForm" onsubmit="return false;">
            <div class="input-group input-group-sm">
              <input class="form-control form-control-navbar" id="searchInput" type="search" placeholder="Tìm kiếm...">
              <div class="input-group-append"><button class="btn btn-navbar" type="button" onclick="taiNoiDung()"><i class="fas fa-search"></i></button></div>
            </div>
          </form>
      </li>
    </ul>
  </nav>

  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="index.php" class="brand-link">
      <img src="assets/dist/img/logo.png" alt="Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light font-weight-bold">Coffee Ng Văn</span>
    </a>

    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
          <li class="nav-item menu-open">
            <ul class="nav nav-treeview">
              <li class="nav-item"><a href="javascript:void(0)" class="nav-link active" id="link-menu" onclick="chuyenCheDo('menu')"><i class="fas fa-coffee nav-icon"></i><p>Danh sách món</p></a></li>
              <li class="nav-item"><a href="javascript:void(0)" class="nav-link" id="link-order" onclick="chuyenCheDo('order')"><i class="fas fa-file-invoice-dollar nav-icon"></i><p>Quản lý Đơn hàng</p></a></li>
              <li class="nav-item"><a href="javascript:void(0)" class="nav-link" id="link-voucher" onclick="chuyenCheDo('voucher')"><i class="fas fa-ticket-alt nav-icon"></i><p>Mã giảm giá</p></a></li>
              <li class="nav-item"><a href="javascript:void(0)" class="nav-link" id="link-schedule" onclick="chuyenCheDo('schedule')"><i class="fas fa-calendar-alt nav-icon"></i><p>Quản lý Phân ca</p></a></li>
              <li class="nav-item"><a href="javascript:void(0)" class="nav-link" id="link-report" onclick="chuyenCheDo('report')"><i class="fas fa-chart-bar nav-icon"></i><p>Báo cáo doanh thu</p></a></li>
              
              <li class="nav-item">
                <a href="javascript:void(0)" class="nav-link" id="link-stock" onclick="chuyenCheDo('stock')">
                    <i class="fas fa-exclamation-triangle nav-icon"></i>
                    <p>Cảnh báo kho <span class="badge badge-danger right" id="badge-stock-sidebar" style="display:none">0</span></p>
                </a>
              </li>

              <li class="nav-item"><a href="javascript:void(0)" class="nav-link" id="link-user" onclick="chuyenCheDo('user')"><i class="fas fa-users-cog nav-icon"></i><p>Quản lý nhân viên</p></a></li>
               <li class="nav-item"><a href="../pos/index.php" class="nav-link"><i class="fas fa-cash-register nav-icon"></i><p>Về trang bán hàng</p></a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <div class="content-wrapper">
    <div class="content-header">
        
      <div class="container-fluid">
        
        <div class="row mb-2 align-items-center">
          <div class="col-sm-6 d-flex align-items-center">
            
              <h1 class="m-0 mr-3" id="page-title">Danh sách món</h1>
              
              <span id="btn-group-menu" class="mode-section"><button class="btn btn-success btn-sm shadow-sm" data-toggle="modal" data-target="#modalAddItem"><i class="fas fa-plus-circle"></i> Thêm món mới</button></span>
              <span id="btn-group-user" class="mode-section"><button class="btn btn-primary btn-sm shadow-sm" data-toggle="modal" data-target="#modalAddUser"><i class="fas fa-user-plus"></i> Thêm nhân viên</button></span>
              <span id="btn-group-voucher" class="mode-section"><button class="btn btn-info btn-sm shadow-sm" data-toggle="modal" data-target="#modalAddVoucher"><i class="fas fa-ticket-alt"></i> Tạo mã</button></span>
              
              <span id="btn-group-schedule" class="mode-section">
                  <button class="btn btn-outline-secondary btn-sm" onclick="doiTuan(-1)"><i class="fas fa-chevron-left"></i> Tuần trước</button>
                  <span id="schedule-range" class="mx-2 font-weight-bold">...</span>
                  <button class="btn btn-outline-secondary btn-sm" onclick="doiTuan(1)">Tuần sau <i class="fas fa-chevron-right"></i></button>
              </span>
          </div>

          <div class="col-sm-6">
            <div class="mode-section" id="cat-selector-group">
                <div class="category-selector float-sm-right" style="width: 100%; max-width: 400px;">
                    <button class="btn-category active" data-type="drink" onclick="chuyenDanhMuc(1, 'Đồ uống')"><i class="fas fa-coffee"></i> Đồ uống</button>
                    <button class="btn-category" data-type="food" onclick="chuyenDanhMuc(2, 'Đồ ăn')"><i class="fas fa-hamburger"></i> Đồ ăn</button>
                </div>
            </div>
            
            <div class="mode-section" id="report-controls">
                <form class="form-inline float-sm-right" onsubmit="locBaoCao(event)">
                    <input type="date" id="report_start" class="form-control form-control-sm mr-2" required>
                    <input type="date" id="report_end" class="form-control form-control-sm mr-2" required>
                    <button type="submit" class="btn btn-sm btn-primary mr-2">Xem</button>
                    <button type="button" class="btn btn-sm btn-success" onclick="xuatExcel()">Excel</button>
                </form>
            </div>
          </div>
        </div>
        
        <div id="hienthi-sanpham"></div>

        <div id="hienthi-warehouse" class="mode-section" style="display:none">
            <div class="card card-warning card-outline">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-clipboard-list"></i> Cấu hình mức cảnh báo tồn kho
                    </h3>
                    <div class="card-tools">
                        <button class="btn btn-primary btn-sm" onclick="luuCauHinhKho()">
                            <i class="fas fa-save"></i> Lưu thay đổi
                        </button>
                    </div>
                </div>
                <div class="card-body table-responsive p-0">
                    <div class="alert alert-light m-2">
                        <i class="fas fa-info-circle text-info"></i> Nhập số lượng tối thiểu vào cột <b>"Mức báo động"</b>. Nếu tồn kho thực tế thấp hơn mức này, hệ thống sẽ báo đỏ.
                    </div>
                    <table class="table table-hover table-striped text-nowrap">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Nguyên liệu</th>
                                <th class="text-center" style="width: 20%;">Tồn hiện tại</th>
                                <th class="text-center" style="width: 20%;">Mức báo động (Min)</th>
                                <th class="text-center" style="width: 15%;">Đơn vị</th>
                                <th class="text-center" style="width: 15%;">Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="tbl-stock-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="hienthi-baocao" class="mode-section">
            <div class="row">
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="info-box">
                        <span class="info-box-icon bg-info elevation-1"><i class="fas fa-coins"></i></span>
                        <div class="info-box-content"><span class="info-box-text">Doanh thu</span><span class="info-box-number" id="rpt-revenue">0 đ</span></div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="info-box mb-3">
                        <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-box-open"></i></span>
                        <div class="info-box-content"><span class="info-box-text">Tiền nguyên liệu</span><span class="info-box-number text-danger" id="rpt-cogs">0 đ</span></div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="info-box mb-3">
                        <span class="info-box-icon bg-success elevation-1"><i class="fas fa-piggy-bank"></i></span>
                        <div class="info-box-content"><span class="info-box-text">Lợi nhuận thực</span><span class="info-box-number text-success" id="rpt-profit">0 đ</span></div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="info-box mb-3">
                        <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-shopping-cart"></i></span>
                        <div class="info-box-content"><span class="info-box-text">Tổng đơn</span><span class="info-box-number" id="rpt-orders">0</span></div>
                    </div>
                </div>
            </div>
            <div class="row"><div class="col-md-12"><div class="card"><div class="card-body"><canvas id="revenue-chart" height="250"></canvas></div></div></div></div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body table-responsive p-0" style="height: 300px;">
                            <table class="table table-head-fixed text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Mã đơn</th>
                                        <th>Thời gian</th>
                                        <th>Nhân viên</th>
                                        <th class="text-right">Doanh thu</th>
                                        <th class="text-right">Giá vốn (Est)</th>
                                        <th class="text-right">Lợi nhuận</th>
                                    </tr>
                                </thead>
                                <tbody id="rpt-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="hienthi-schedule" class="mode-section">
            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-bordered table-schedule">
                        <thead>
                            <tr>
                                <th style="width: 10%">Ca</th>
                                <th style="width: 12%">Thứ 2<br><small id="d-0"></small></th>
                                <th style="width: 12%">Thứ 3<br><small id="d-1"></small></th>
                                <th style="width: 12%">Thứ 4<br><small id="d-2"></small></th>
                                <th style="width: 12%">Thứ 5<br><small id="d-3"></small></th>
                                <th style="width: 12%">Thứ 6<br><small id="d-4"></small></th>
                                <th style="width: 12%">Thứ 7<br><small id="d-5"></small></th>
                                <th style="width: 12%">CN<br><small id="d-6"></small></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th><strong>SÁNG</strong><br>(7h - 12h)</th>
                                <td id="cell-morning-0"></td><td id="cell-morning-1"></td><td id="cell-morning-2"></td>
                                <td id="cell-morning-3"></td><td id="cell-morning-4"></td><td id="cell-morning-5"></td><td id="cell-morning-6"></td>
                            </tr>
                            <tr>
                                <th><strong>CHIỀU</strong><br>(12h - 17h)</th>
                                <td id="cell-afternoon-0"></td><td id="cell-afternoon-1"></td><td id="cell-afternoon-2"></td>
                                <td id="cell-afternoon-3"></td><td id="cell-afternoon-4"></td><td id="cell-afternoon-5"></td><td id="cell-afternoon-6"></td>
                            </tr>
                            <tr>
                                <th><strong>TỐI</strong><br>(17h - 23h30)</th>
                                <td id="cell-evening-0"></td><td id="cell-evening-1"></td><td id="cell-evening-2"></td>
                                <td id="cell-evening-3"></td><td id="cell-evening-4"></td><td id="cell-evening-5"></td><td id="cell-evening-6"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

      </div>
    </div>
  </div>

  <footer class="main-footer"><strong>Coffee Nguyễn Văn</strong></footer>
</div>

<div class="modal fade" id="modalAddSchedule"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header bg-primary"><h5 class="modal-title text-white">Xếp nhân viên</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><form id="formSchedule" onsubmit="luuPhanCa(event)"><div class="modal-body"><input type="hidden" name="shift_date" id="sch_date"><input type="hidden" name="shift_type" id="sch_type"><p>Ngày: <b id="lbl_date"></b> - Ca: <b id="lbl_type"></b></p><div class="form-group"><label>Chọn nhân viên:</label><select class="form-control" name="user_id" id="sch_users"></select></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary btn-block">Thêm vào ca</button></div></form></div></div></div>
<div class="modal fade" id="modalAddVoucher"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-info"><h5 class="modal-title text-white">Tạo Mã Giảm Giá</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><form id="formAddVoucher" onsubmit="themVoucher(event)"><div class="modal-body"><div class="form-group"><label>Mã Voucher</label><input type="text" class="form-control" name="code" style="text-transform: uppercase;" required></div><div class="form-group"><label>Giảm (%)</label><input type="number" class="form-control" name="percent" min="1" max="100" required></div><div class="form-group"><label>Mô tả</label><input type="text" class="form-control" name="description"></div></div><div class="modal-footer"><button type="submit" class="btn btn-info">Tạo mã</button></div></form></div></div></div>
<div class="modal fade" id="modalOrderDetail"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-info"><h5 class="modal-title text-white">Chi tiết đơn hàng</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><div class="modal-body" id="order-detail-content"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button></div></div></div></div>
<div class="modal fade" id="modalDelete"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger"><h5 class="modal-title text-white">Xác nhận xóa</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><div class="modal-body"><p>Xác nhận xóa?</p><input type="hidden" id="idDelete"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button><button type="button" class="btn btn-danger" onclick="xacNhanXoa()">Xóa</button></div></div></div></div>
<div class="modal fade" id="modalAddItem"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-success"><h5 class="modal-title text-white">Thêm món mới</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><form id="formAdd" onsubmit="themMon(event)"><div class="modal-body"><div class="row"><div class="col-md-6"><div class="form-group"><label>Tên món</label><input type="text" class="form-control" name="name" required></div><div class="form-group"><label>Giá tiền</label><input type="number" class="form-control" name="price" required></div><div class="form-group"><label>Danh mục</label><select class="form-control" name="category"><option value="1">Đồ uống</option><option value="2">Đồ ăn</option></select></div><div class="form-group"><label>Ảnh</label><input type="file" class="form-control-file" name="image"></div></div><div class="col-md-6 border-left"><label>Công thức</label><div id="recipe-container-add" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px;"></div><button type="button" class="btn btn-sm btn-info mt-2" onclick="addIngredientRow('recipe-container-add')"><i class="fas fa-plus"></i> Thêm NL</button></div></div></div><div class="modal-footer"><button type="submit" class="btn btn-success">Lưu</button></div></form></div></div></div>
<div class="modal fade" id="modalEdit"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">Sửa món</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><form id="formEdit" onsubmit="luuSua(event)"><div class="modal-body"><input type="hidden" name="edit_id" id="edit_id"><div class="row"><div class="col-md-6"><div class="form-group"><label>Tên món</label><input type="text" class="form-control" name="edit_name" id="edit_name" required></div><div class="form-group"><label>Giá tiền</label><input type="number" class="form-control" name="edit_price" id="edit_price" required></div><div class="form-group"><label>Danh mục</label><select class="form-control" name="edit_category" id="edit_category"><option value="1">Đồ uống</option><option value="2">Đồ ăn</option></select></div><div class="form-group"><label>Ảnh</label><br><img id="preview_img" src="" style="width: 80px; height: 80px; object-fit: cover;"><input type="file" class="form-control-file" name="edit_image"></div></div><div class="col-md-6 border-left"><label>Công thức</label><div id="recipe-container-edit" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px;"></div><button type="button" class="btn btn-sm btn-info mt-2" onclick="addIngredientRow('recipe-container-edit')"><i class="fas fa-plus"></i> Thêm NL</button></div></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Lưu</button></div></form></div></div></div>
<div class="modal fade" id="modalAddUser"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary"><h5 class="modal-title text-white">Thêm nhân viên</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><form id="formAddUser" onsubmit="xuLyThemUser(event)"><div class="modal-body"><div class="form-group"><label>Họ và tên</label><input type="text" class="form-control" name="fullname" required></div><div class="form-group"><label>Username</label><input type="text" class="form-control" name="username" required></div><div class="form-group"><label>Password</label><input type="password" class="form-control" name="password" required></div><div class="form-group"><label>Chức vụ</label><select class="form-control" name="role"><option value="staff">Nhân viên</option><option value="wh-staff">Thủ kho</option><option value="admin">Admin</option></select></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Lưu</button></div></form></div></div></div>
<div class="modal fade" id="modalEditUser"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">Sửa user</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><form id="formEditUser" onsubmit="xuLySuaUser(event)"><div class="modal-body"><input type="hidden" name="user_id" id="edit_user_id"><div class="form-group"><label>Họ tên</label><input type="text" class="form-control" name="fullname" id="edit_user_fullname" required></div><div class="form-group"><label>Username</label><input type="text" class="form-control" id="edit_user_username" disabled></div><div class="form-group"><label>Pass mới</label><input type="password" class="form-control" name="password"></div><div class="form-group"><label>Chức vụ</label><select class="form-control" name="role" id="edit_user_role"><option value="staff">Nhân viên</option><option value="wh-staff">Thủ kho</option><option value="admin">Admin</option></select></div><div class="form-group"><label>Trạng thái</label><select class="form-control" name="status" id="edit_user_status"><option value="1">Đang làm</option><option value="0">Khóa</option></select></div></div><div class="modal-footer"><button type="submit" class="btn btn-warning">Lưu</button></div></form></div></div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

<script>
    var currentMode = 'menu';
    var currentCategory = 1;
    var ingredientsList = [];
    var usersList = [];
    var currentWeekStart = '';
    var myChart = null;

    // --- HÀM XỬ LÝ NGÀY THÁNG ĐỊA PHƯƠNG (Fix lỗi lệch ngày) ---
    function getLocalDateString(date) {
        var year = date.getFullYear();
        var month = (date.getMonth() + 1).toString().padStart(2, '0');
        var day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    $(document).ready(function(){
        autoUpdateStatus();
        
        // Tính ngày đầu tuần (Thứ 2) dựa trên giờ địa phương
        var today = new Date();
        var day = today.getDay(); // 0 (CN) -> 6 (T7)
        var currentDay = (day === 0) ? 7 : day; // Đổi CN thành 7
        
        // Lùi về Thứ 2
        var monday = new Date(today);
        monday.setDate(today.getDate() - (currentDay - 1));
        
        currentWeekStart = getLocalDateString(monday);

        // Set ngày mặc định cho báo cáo (Đầu tháng -> Hôm nay)
        var rptEnd = getLocalDateString(today);
        var rptStart = getLocalDateString(new Date(today.getFullYear(), today.getMonth(), 1));
        $('#report_end').val(rptEnd);
        $('#report_start').val(rptStart);

        taiNoiDung();
        loadIngredients(); // Tải danh sách nguyên liệu để dùng cho Modal thêm món
        loadStockData();   // Tải dữ liệu kho để cập nhật badge cảnh báo
        updateSelectUsers(); 
        $('#searchInput').on('keyup', function(){ taiNoiDung(); });
    });

    function autoUpdateStatus() {
        $.ajax({ url: 'api/auto_update_status.php', type: 'GET', success: function(res) { console.log("Auto Update Status: " + res.message); } });
    }

    // --- CHUYỂN CHẾ ĐỘ ---
    window.chuyenCheDo = function(mode) {
        currentMode = mode;
        $('#searchInput').val('');
        $('.nav-link').removeClass('active');
        $('.mode-section').hide();
        $('#hienthi-sanpham, #hienthi-baocao, #hienthi-schedule, #hienthi-warehouse').hide();
        $('#searchForm').show();

        if(mode == 'menu') {
            $('#link-menu').addClass('active'); $('#page-title').text('Danh sách món'); 
            $('#btn-group-menu').show(); $('#cat-selector-group').show();
            $('#hienthi-sanpham').show(); taiNoiDung();
        } else if(mode == 'user') {
            $('#link-user').addClass('active'); $('#page-title').text('Quản lý nhân viên'); $('#btn-group-user').show(); $('#hienthi-sanpham').show(); taiNoiDung();
        } else if(mode == 'order') {
            $('#link-order').addClass('active'); $('#page-title').text('Quản lý Đơn hàng'); $('#hienthi-sanpham').show(); taiNoiDung();
        } else if(mode == 'voucher') {
            $('#link-voucher').addClass('active'); $('#page-title').text('Mã giảm giá'); $('#btn-group-voucher').show(); $('#hienthi-sanpham').show(); taiNoiDung();
        } else if(mode == 'report') {
            $('#link-report').addClass('active'); $('#page-title').text('Báo cáo doanh thu'); $('#searchForm').hide(); $('#report-controls').show(); $('#hienthi-baocao').show(); taiBaoCao();
        } else if(mode == 'schedule') {
            $('#link-schedule').addClass('active'); $('#page-title').text('Lịch làm việc'); $('#searchForm').hide(); $('#btn-group-schedule').show(); $('#hienthi-schedule').show(); taiLichLamViec();
        
        // --- CHẾ ĐỘ KHO MỚI ---
        } else if(mode == 'stock') {
            $('#link-stock').addClass('active'); 
            $('#page-title').text('Cảnh báo & Cấu hình kho'); 
            $('#searchForm').hide(); // Ẩn thanh tìm kiếm nếu không dùng
            $('#hienthi-warehouse').show(); 
            loadStockData(); // Gọi hàm tải dữ liệu kho
        }
    };

    window.chuyenDanhMuc = function(catId, title) {
        currentCategory = catId;
        $('.btn-category').removeClass('active');
        if (catId == 1) { $('.btn-category[data-type="drink"]').addClass('active'); } 
        else { $('.btn-category[data-type="food"]').addClass('active'); }
        $('#page-title').text('Danh sách ' + title);
        $('#searchInput').val('');
        taiNoiDung();
    };

    // --- LOGIC QUẢN LÝ KHO (NEW) ---
    function loadStockData() {
        $('#tbl-stock-body').html('<tr><td colspan="5" class="text-center">Đang tải dữ liệu...</td></tr>');
        
        $.ajax({
            url: 'api/get_ingredients.php', 
            dataType: 'json',
            success: function(data) {
                var html = '';
                var warningCount = 0;
                
                data.forEach(function(item) {
                    var qty = parseFloat(item.quantity);
                    var min = parseFloat(item.min_quantity) || 0; // Mặc định là 0 nếu chưa cài
                    var isLow = qty <= min; // Kiểm tra xem có thấp hơn mức tối thiểu không
                    
                    if (isLow) warningCount++;

                    // Tạo giao diện từng dòng
                    var statusHtml = isLow 
                        ? '<span class="badge badge-danger">Sắp hết hàng</span>' 
                        : '<span class="badge badge-success">Ổn định</span>';
                    
                    // Tô màu nền nhẹ cho dòng cảnh báo
                    var rowStyle = isLow ? 'background-color: #fff3cd;' : '';

                    html += `<tr style="${rowStyle}">
                        <td class="align-middle font-weight-bold">${item.name}</td>
                        <td class="text-center align-middle ${isLow ? 'text-danger font-weight-bold' : ''}">${qty}</td>
                        <td class="text-center">
                            <input type="number" class="form-control form-control-sm text-center input-min-qty mx-auto" 
                                   style="max-width: 100px; border-color: ${isLow ? '#dc3545' : '#ced4da'}"
                                   data-id="${item.id}" value="${min}" step="0.1" min="0">
                        </td>
                        <td class="text-center align-middle">${item.unit}</td>
                        <td class="text-center align-middle">${statusHtml}</td>
                    </tr>`;
                });

                $('#tbl-stock-body').html(html);
                
                // Cập nhật số lượng cảnh báo lên Menu bên trái
                if (warningCount > 0) {
                    $('#badge-stock-sidebar').text(warningCount).show();
                } else {
                    $('#badge-stock-sidebar').hide();
                }
            },
            error: function() {
                $('#tbl-stock-body').html('<tr><td colspan="5" class="text-center text-danger">Lỗi kết nối server!</td></tr>');
            }
        });
    }

    window.luuCauHinhKho = function() {
        var updates = [];
        // Quét tất cả các ô input để lấy giá trị mới
        $('.input-min-qty').each(function() {
            updates.push({
                id: $(this).data('id'),
                min_quantity: $(this).val()
            });
        });

        // Gửi lên server
        $.ajax({
            url: 'api/update_min_stock.php',
            type: 'POST',
            data: { data: JSON.stringify(updates) },
            dataType: 'json',
            success: function(res) {
                if(res.status == 'success') {
                    alert('Đã cập nhật mức cảnh báo thành công!');
                    loadStockData(); // Tải lại bảng để cập nhật màu sắc/trạng thái
                } else {
                    alert('Lỗi: ' + res.message);
                }
            },
            error: function() {
                alert('Lỗi kết nối khi lưu dữ liệu! Hãy kiểm tra file update_min_stock.php');
            }
        });
    }

    // --- LOGIC BÁO CÁO ---
    window.locBaoCao = function(e) { 
        if(e) e.preventDefault(); 
        taiBaoCao(); 
    }

    window.taiBaoCao = function() {
        var start = $('#report_start').val();
        var end = $('#report_end').val();
        
        $('#rpt-table-body').html('<tr><td colspan="6" class="text-center">Đang tải dữ liệu...</td></tr>');

        $.ajax({
            url: 'api/get_report_stats.php',
            type: 'GET',
            data: {start: start, end: end},
            dataType: 'json',
            success: function(res) {
                if (res.status === 'error') {
                    alert(res.message); 
                    $('#rpt-table-body').html('<tr><td colspan="6" class="text-center text-danger">Có lỗi xảy ra.</td></tr>');
                    return;
                }

                var fmt = new Intl.NumberFormat('vi-VN');
                
                $('#rpt-revenue').text(fmt.format(res.summary.revenue) + ' đ');
                $('#rpt-cogs').text(fmt.format(res.summary.cogs) + ' đ');
                $('#rpt-profit').text(fmt.format(res.summary.profit) + ' đ');
                $('#rpt-orders').text(res.summary.orders);
                
                $('#rpt-table-body').html(res.html);
                
                if(res.chart) {
                    renderChart(res.chart.labels, res.chart.data);
                } else {
                    if(myChart) { myChart.destroy(); }
                }
            },
            error: function(xhr, status, error) {
                console.error(xhr.responseText);
                alert('Lỗi khi tải báo cáo.');
            }
        });
    }

    // --- LOGIC LỊCH LÀM VIỆC ---
    function taiLichLamViec() {
        $.ajax({
            url: 'api/get_schedules.php', type: 'GET', data: {start_date: currentWeekStart}, dataType: 'json',
            success: function(res) { renderScheduleTable(res.data, res.start_date); }
        });
    }
    
    function renderScheduleTable(data, startDate) {
        $('.table-schedule td').html(''); $('.btn-add-shift').remove();
        
        var parts = startDate.split('-');
        var start = new Date(parts[0], parts[1] - 1, parts[2]); 
        
        var endDate = new Date(start); 
        endDate.setDate(start.getDate() + 6);
        
        $('#schedule-range').text(formatDate(start) + ' - ' + formatDate(endDate));
        
        for(var i=0; i<7; i++) {
            var d = new Date(start); 
            d.setDate(start.getDate() + i); 
            
            $('#d-'+i).text(formatDate(d));
            var dateStr = getLocalDateString(d); 
            
            $('#cell-morning-'+i).append(`<button class="btn btn-outline-primary btn-xs btn-add-shift" onclick="openAddShift('${dateStr}', 'morning')">+ Thêm</button>`);
            $('#cell-afternoon-'+i).append(`<button class="btn btn-outline-primary btn-xs btn-add-shift" onclick="openAddShift('${dateStr}', 'afternoon')">+ Thêm</button>`);
            $('#cell-evening-'+i).append(`<button class="btn btn-outline-primary btn-xs btn-add-shift" onclick="openAddShift('${dateStr}', 'evening')">+ Thêm</button>`);
        }
        
        data.forEach(function(item){
            var itemDateParts = item.shift_date.split('-');
            var itemDate = new Date(itemDateParts[0], itemDateParts[1] - 1, itemDateParts[2]);
            
            var diffTime = itemDate - start;
            var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            if (diffDays >= 0 && diffDays <= 6) {
                var cellId = '#cell-' + item.shift_type + '-' + diffDays;
                $(cellId).prepend(`<div class="shift-item"><span>${item.fullname}</span><i class="fas fa-times btn-del-shift" onclick="xoaCa(${item.id})"></i></div>`);
            }
        });
    }

    function doiTuan(dir) { 
        var parts = currentWeekStart.split('-');
        var d = new Date(parts[0], parts[1] - 1, parts[2]);
        d.setDate(d.getDate() + dir*7); 
        currentWeekStart = getLocalDateString(d); 
        taiLichLamViec(); 
    }

    function updateSelectUsers() { $.get('api/get_users.php', function(data){ var h=$(data), o=''; h.find('.btn-edit-user').each(function(){o+=`<option value="${$(this).data('id')}">${$(this).data('fullname')}</option>`}); $('#sch_users').html(o); }); }
    
    function openAddShift(d, t) { 
        $('#sch_date').val(d); $('#sch_type').val(t); 
        var parts = d.split('-');
        var displayDate = parts[2] + '/' + parts[1] + '/' + parts[0];
        $('#lbl_date').text(displayDate); 
        
        var shiftName = (t=='morning') ? 'Sáng' : (t=='afternoon' ? 'Chiều' : 'Tối');
        $('#lbl_type').text(shiftName); 
        $('#modalAddSchedule').modal('show'); 
    }
    
    function luuPhanCa(e, forceUnlock = false) {
        if(e) e.preventDefault(); 
        var formData = $('#formSchedule').serializeArray();
        if (forceUnlock) { formData.push({name: 'force_unlock', value: 'true'}); }
        $.ajax({
            url: 'api/add_schedule.php', type: 'POST', data: formData, dataType: 'json',
            success: function(res) {
                if(res.status == 'success') { $('#modalAddSchedule').modal('hide'); alert(res.message); taiLichLamViec(); } 
                else if (res.status == 'locked_user') {
                    if (confirm(res.message)) { luuPhanCa(null, true); }
                } 
                else { alert(res.message); }
            },
            error: function() { alert('Lỗi kết nối server.'); }
        });
    }
    function xoaCa(id) { if(confirm("Xóa?")) $.ajax({ url: 'api/delete_schedule.php', type: 'POST', data: {id: id}, success: function(){ taiLichLamViec(); } }); }
    function formatDate(d) { return d.getDate()+'/'+(d.getMonth()+1); }
    window.taiNoiDung = function() {
        if(currentMode == 'report' || currentMode == 'schedule' || currentMode == 'stock') return;
        var k = $('#searchInput').val(); var url='', d={search: k};
        if (currentMode == 'menu') { url='api/get_items.php'; d.category=currentCategory; } 
        else if (currentMode == 'user') url='api/get_users.php';
        else if (currentMode == 'order') url='api/get_orders.php';
        else if (currentMode == 'voucher') url='api/get_vouchers.php';
        $.ajax({ url: url, type: 'GET', data: d, success: function(data) { $('#hienthi-sanpham').html(data); } });
    };
    function renderChart(l, d) { var ctx = document.getElementById('revenue-chart').getContext('2d'); if (myChart) myChart.destroy(); myChart = new Chart(ctx, { type: 'bar', data: { labels: l, datasets: [{ label: 'Doanh thu', data: d, backgroundColor: 'rgba(60,141,188,0.9)' }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); }
    window.xuatExcel = function() { window.location.href = 'api/export_excel.php?start='+$('#report_start').val()+'&end='+$('#report_end').val(); }
    window.themVoucher = function(e) { e.preventDefault(); $.ajax({ url: 'api/add_voucher.php', type: 'POST', data: $('#formAddVoucher').serialize(), dataType: 'json', success: function(res) { if(res.status == 'success') { alert(res.message); $('#modalAddVoucher').modal('hide'); $('#formAddVoucher')[0].reset(); taiNoiDung(); } else { alert(res.message); } } }); }
    window.xoaVoucher = function(id) { if(!confirm("Xóa mã này?")) return; $.ajax({ url: 'api/delete_voucher.php', type: 'POST', data: {id: id}, dataType: 'json', success: function(res) { taiNoiDung(); } }); }
    window.xuLyThemUser = function(e) { e.preventDefault(); $.ajax({ url: 'api/add_user.php', type: 'POST', data: $('#formAddUser').serialize(), dataType: 'json', success: function(res) { if(res.status=='success'){ alert(res.message); $('#modalAddUser').modal('hide'); taiNoiDung(); } else alert(res.message); } }); };
    window.xuLySuaUser = function(e) { e.preventDefault(); $.ajax({ url: 'api/update_user.php', type: 'POST', data: $('#formEditUser').serialize(), dataType: 'json', success: function(res) { if(res.status=='success'){ alert(res.message); $('#modalEditUser').modal('hide'); taiNoiDung(); } else alert(res.message); } }); };
    $(document).on('click', '.btn-edit-user', function(){ $('#edit_user_id').val($(this).data('id')); $('#edit_user_fullname').val($(this).data('fullname')); $('#edit_user_username').val($(this).data('username')); $('#edit_user_role').val($(this).data('role')); $('#edit_user_status').val($(this).data('status')); $('#modalEditUser').modal('show'); });
    window.loadIngredients = function() { $.ajax({ url: 'api/get_ingredients.php', dataType: 'json', success: function(data) { ingredientsList = data; } }); }
    window.addIngredientRow = function(containerId, ingId = null, qty = '') { var options = '<option value="">-- Chọn NL --</option>'; if(ingredientsList.length > 0) ingredientsList.forEach(function(ing) { var selected = (ing.id == ingId) ? 'selected' : ''; options += `<option value="${ing.id}" ${selected}>${ing.name} (${ing.unit})</option>`; }); var html = `<div class="d-flex mb-2 align-items-center"><select name="ing_id[]" class="form-control form-control-sm mr-2" style="width:60%">${options}</select><input type="number" step="0.01" name="ing_qty[]" class="form-control form-control-sm mr-2" style="width:25%" value="${qty}"><button type="button" class="btn btn-sm btn-danger" onclick="$(this).parent().remove()">X</button></div>`; $('#' + containerId).append(html); };
    window.themMon = function(e) { e.preventDefault(); var fd = new FormData(document.getElementById('formAdd')); $.ajax({ url: 'api/add_item.php', type: 'POST', data: fd, contentType: false, processData: false, dataType: 'json', success: function(res) { if(res.status=='success'){ $('#modalAddItem').modal('hide'); alert(res.message); $('#formAdd')[0].reset(); $('#recipe-container-add').html(''); taiNoiDung(); } else alert(res.message); } }); };
    $(document).on('click', '.btn-edit', function(e){ e.preventDefault(); var id = $(this).data('id'); $('#edit_id').val(id); $('#edit_name').val($(this).data('name')); $('#edit_price').val($(this).data('price').toString().replace(/\./g, '')); $('#edit_category').val($(this).data('category')); $('#preview_img').attr('src', $(this).data('img')); $('#recipe-container-edit').html(''); $.ajax({ url: 'api/get_recipe_detail.php', data: {product_id: id}, dataType: 'json', success: function(recipes) { if(recipes && recipes.length > 0) recipes.forEach(r => addIngredientRow('recipe-container-edit', r.ingredient_id, r.quantity_required)); else addIngredientRow('recipe-container-edit'); } }); $('#modalEdit').modal('show'); });
    window.luuSua = function(e) { e.preventDefault(); var fd = new FormData(document.getElementById('formEdit')); $.ajax({ url: 'api/update_item.php', type: 'POST', data: fd, contentType: false, processData: false, dataType: 'json', success: function(res){ if(res.status=='success'){ $('#modalEdit').modal('hide'); alert('Cập nhật xong!'); taiNoiDung(); } else alert(res.message); } }); };
    $(document).on('click', '.btn-delete', function(){ $('#idDelete').val($(this).data('id')); $('#modalDelete').modal('show'); });
    window.xacNhanXoa = function() { $.ajax({ url: 'api/delete_item.php', type: 'POST', data: {id: $('#idDelete').val()}, dataType: 'json', success: function(res){ $('#modalDelete').modal('hide'); if(res.status=='success') taiNoiDung(); else alert(res.message); } }); };
    window.xemChiTietDon = function(orderId) { $.ajax({ url: 'api/get_order_detail.php', type: 'GET', data: { id: orderId }, success: function(data) { $('#order-detail-content').html(data); $('#modalOrderDetail').modal('show'); }, error: function() { alert('Lỗi: Không thể tải chi tiết đơn hàng.'); } }); };
    window.xacNhanHuy = function(orderId) { if (!confirm('Bạn có chắc chắn muốn HỦY đơn hàng #' + orderId + '?\nNguyên liệu sẽ được hoàn lại kho và doanh thu ca làm việc sẽ bị trừ.')) { return; } $.ajax({ url: 'api/cancel_order.php', type: 'POST', data: { id: orderId }, dataType: 'json', success: function(res) { if (res.status == 'success') { alert(res.message); taiNoiDung(); } else { alert('Lỗi: ' + res.message); } }, error: function() { alert('Lỗi kết nối server khi thực hiện hủy đơn.'); } }); };
</script>
</body>
</html>
---------------- END FILE ----------------

---------------- START FILE: admin\api\add_item.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $name = $_POST['name'];
    $price = $_POST['price'];
    $category = $_POST['category'];
    
    // 1. Cấu hình đường dẫn
    // $_SERVER['DOCUMENT_ROOT'] trỏ thẳng về thư mục gốc của website (thư mục chứa toàn bộ dự án)
$root_path = dirname(__DIR__, 2); // Nhảy ngược ra 2 cấp từ file hiện tại để về root    $image_path = "assets/dist/img/default.jpg"; // Giá trị mặc định để lưu vào DB

    if (!empty($_FILES['image']['name'])) {
        // Xác định thư mục con dựa trên category
        $sub_folder = ($category == 1) ? "drink/" : "food/";
        
        // Đường dẫn vật lý trên ổ đĩa để upload file (Dùng để mkdir và move_uploaded_file)
        $target_dir = $root_path . "/assets/img/" . $sub_folder;
        
        // Tạo thư mục nếu chưa tồn tại
        if (!file_exists($target_dir)) {
            mkdir($target_dir, 0777, true);
        }
        
        $filename = time() . "_" . basename($_FILES["image"]["name"]);
        $target_file = $target_dir . $filename;

        if (move_uploaded_file($_FILES["image"]["tmp_name"], $target_file)) {
            // Đường dẫn tương đối để lưu vào Database (để hiển thị lên web sau này)
            $image_path = "assets/img/" . $sub_folder . $filename;
        }
    }

    // 2. Insert món mới vào bảng products
    $sql = "INSERT INTO products (name, price, category_id, image_url, is_active) VALUES (?, ?, ?, ?, 1)";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("siis", $name, $price, $category, $image_path);
    
    if ($stmt->execute()) {
        $product_id = $conn->insert_id; 

        // 3. Insert công thức (Mapping nguyên liệu)
        if (isset($_POST['ing_id']) && isset($_POST['ing_qty'])) {
            $ing_ids = $_POST['ing_id'];
            $ing_qtys = $_POST['ing_qty'];
            
            $sql_recipe = "INSERT INTO recipes (product_id, ingredient_id, quantity_required) VALUES (?, ?, ?)";
            $stmt_recipe = $conn->prepare($sql_recipe);

            for ($i = 0; $i < count($ing_ids); $i++) {
                if (!empty($ing_ids[$i]) && $ing_qtys[$i] > 0) {
                    $stmt_recipe->bind_param("iid", $product_id, $ing_ids[$i], $ing_qtys[$i]);
                    $stmt_recipe->execute();
                }
            }
        }
        echo json_encode(['status' => 'success', 'message' => 'Thêm món và công thức thành công!']);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Lỗi SQL: ' . $conn->error]);
    }
}
?>

---------------- END FILE ----------------

---------------- START FILE: admin\api\add_schedule.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $user_id = $_POST['user_id'];
    $shift_date = $_POST['shift_date'];
    $shift_type = $_POST['shift_type'];
    
    // Nhận cờ force_unlock từ client gửi lên
    $force_unlock = isset($_POST['force_unlock']) && $_POST['force_unlock'] == 'true';

    // 1. KIỂM TRA TRẠNG THÁI TÀI KHOẢN (status)
    $user_check = $conn->query("SELECT status, fullname FROM users WHERE id = $user_id");
    $user_data = $user_check->fetch_assoc();

    if ($user_data && $user_data['status'] == 0) {
        // Nếu chưa có lệnh mở khóa, trả về yêu cầu xác nhận
        if (!$force_unlock) {
            echo json_encode([
                'status' => 'locked_user', 
                'message' => "Nhân viên " . $user_data['fullname'] . " đang bị KHÓA (Nghỉ việc).\nBạn có muốn KÍCH HOẠT LẠI nhân viên này để xếp lịch không?"
            ]);
            exit;
        } else {
            // Nếu Admin đồng ý -> Cập nhật status = 1 (Mở khóa tài khoản)
            $conn->query("UPDATE users SET status = 1 WHERE id = $user_id");
        }
    }

    // 2. KIỂM TRA TRÙNG LỊCH
    $check = $conn->query("SELECT id FROM work_schedules WHERE user_id = $user_id AND shift_date = '$shift_date' AND shift_type = '$shift_type'");
    if ($check->num_rows > 0) {
        echo json_encode(['status' => 'error', 'message' => 'Nhân viên này đã được phân công vào ca này rồi!']);
        exit;
    }

    // 3. THÊM LỊCH VÀO DATABASE
    $sql = "INSERT INTO work_schedules (user_id, shift_date, shift_type) VALUES (?, ?, ?)";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("iss", $user_id, $shift_date, $shift_type);

    if ($stmt->execute()) {
        $msg = 'Phân ca thành công!';
        if ($force_unlock) {
            $msg .= ' (Tài khoản nhân viên đã được mở khóa)';
        }
        echo json_encode(['status' => 'success', 'message' => $msg]);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Lỗi hệ thống: ' . $conn->error]);
    }
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\add_user.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $fullname = $_POST['fullname'];
    $username = $_POST['username'];
    $password = password_hash($_POST['password'], PASSWORD_DEFAULT);
    $role = $_POST['role'];

    $sql = "INSERT INTO users (fullname, username, password, role, status) VALUES (?, ?, ?, ?, 1)";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("ssss", $fullname, $username, $password, $role);

    if ($stmt->execute()) {
        echo json_encode(['status' => 'success', 'message' => 'Thêm nhân viên thành công!']);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Lỗi: Tên đăng nhập có thể đã tồn tại.']);
    }
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\add_voucher.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $code = strtoupper(trim($_POST['code'])); // Chuyển thành chữ hoa
    $percent = (int)$_POST['percent'];
    $desc = $_POST['description'];

    // Validate
    if(empty($code)) {
        echo json_encode(['status' => 'error', 'message' => 'Mã không được để trống']);
        exit;
    }

    // Kiểm tra trùng
    $check = $conn->query("SELECT id FROM vouchers WHERE code = '$code'");
    if($check->num_rows > 0){
        echo json_encode(['status' => 'error', 'message' => 'Mã này đã tồn tại!']);
        exit;
    }

    $sql = "INSERT INTO vouchers (code, discount_percent, description) VALUES (?, ?, ?)";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("sis", $code, $percent, $desc);

    if ($stmt->execute()) {
        echo json_encode(['status' => 'success', 'message' => 'Thêm mã thành công!']);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Lỗi hệ thống!']);
    }
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\auto_update_status.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

// --- QUAN TRỌNG: Cài đặt múi giờ Việt Nam ---
date_default_timezone_set('Asia/Ho_Chi_Minh'); 

// Lấy giờ hiện tại
$current_date = date('Y-m-d');
$current_hour = (int)date('H');
$current_minute = (int)date('i');
$current_shift = '';

// Debug: Ghi log để kiểm tra giờ hệ thống đang hiểu là mấy giờ (xem trong F12 Network nếu cần)
// echo json_encode(['server_time' => date('H:i:s')]); exit; 

// --- LOGIC CA LÀM VIỆC ---
// Ca Sáng: 7h - 12h
if ($current_hour >= 7 && $current_hour < 12) {
    $current_shift = 'morning';
} 
// Ca Chiều: 12h - 17h
elseif ($current_hour >= 12 && $current_hour < 17) {
    $current_shift = 'afternoon';
}
// Ca Tối: 17h - 23h30
elseif ($current_hour >= 17) {
    if ($current_hour < 23) {
        $current_shift = 'evening';
    } 
    elseif ($current_hour == 23 && $current_minute <= 30) {
        $current_shift = 'evening';
    }
}

// BƯỚC 1: Reset toàn bộ nhân viên về trạng thái nghỉ
$conn->query("UPDATE users SET status_work = 0");

// BƯỚC 2: Nếu đang trong khung giờ làm việc thì bật status_work = 1 cho ai có lịch
if ($current_shift != '') {
    $sql = "UPDATE users u
            JOIN work_schedules ws ON u.id = ws.user_id
            SET u.status_work = 1
            WHERE ws.shift_date = '$current_date' 
            AND ws.shift_type = '$current_shift'
            AND u.status = 1"; // Chỉ bật nếu tài khoản không bị khóa vĩnh viễn
    
    $conn->query($sql);
    $msg = "Đã cập nhật (Giờ Server: " . date('H:i') . "): Ca $current_shift. Nhân viên có lịch -> ON.";
} else {
    $msg = "Ngoài giờ làm việc (Giờ Server: " . date('H:i') . "). Tất cả -> OFF.";
}

echo json_encode(['status' => 'success', 'message' => $msg]);
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\cancel_order.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['id'])) {
    $order_id = $_POST['id'];
    $user_id = 1; // ID của Admin đang thao tác (tạm thời để 1)

    // Bắt đầu Transaction để đảm bảo an toàn dữ liệu
    $conn->begin_transaction();

    try {
        // 1. Kiểm tra đơn hàng
        $check = $conn->query("SELECT status, final_amount, session_id FROM orders WHERE id = $order_id");
        $order = $check->fetch_assoc();

        if (!$order) throw new Exception("Đơn hàng không tồn tại.");
        if ($order['status'] == 'canceled') throw new Exception("Đơn này đã hủy rồi.");

        // 2. Cập nhật trạng thái đơn -> Đã hủy
        $conn->query("UPDATE orders SET status = 'canceled' WHERE id = $order_id");

        // 3. HOÀN KHO (RESTOCK) - Cộng lại nguyên liệu
        $items = $conn->query("SELECT product_id, quantity FROM order_items WHERE order_id = $order_id");
        while ($item = $items->fetch_assoc()) {
            $pid = $item['product_id'];
            $qty = $item['quantity'];

            // Lấy công thức món
            $recipes = $conn->query("SELECT ingredient_id, quantity_required FROM recipes WHERE product_id = $pid");
            while ($r = $recipes->fetch_assoc()) {
                $ing_id = $r['ingredient_id'];
                $amount = $r['quantity_required'] * $qty;

                // Cộng lại vào kho
                $conn->query("UPDATE ingredients SET quantity = quantity + $amount WHERE id = $ing_id");
                
                // Ghi log
                $conn->query("INSERT INTO inventory_log (ingredient_id, type, quantity, note, user_id) 
                              VALUES ($ing_id, 'import', $amount, 'Hoàn kho hủy đơn #$order_id', $user_id)");
            }
        }

        // 4. TRỪ DOANH THU CA LÀM VIỆC (Nếu ca đang mở)
        if ($order['session_id']) {
            $sess_id = $order['session_id'];
            $ss = $conn->query("SELECT status FROM work_sessions WHERE id = $sess_id")->fetch_assoc();
            if ($ss && $ss['status'] == 'open') {
                $money = $order['final_amount'];
                $conn->query("UPDATE work_sessions SET total_sales = total_sales - $money WHERE id = $sess_id");
            }
        }

        $conn->commit();
        echo json_encode(['status' => 'success', 'message' => 'Đã hủy đơn hàng thành công!']);

    } catch (Exception $e) {
        $conn->rollback();
        echo json_encode(['status' => 'error', 'message' => $e->getMessage()]);
    }
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\delete_item.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();

header('Content-Type: application/json'); // Thêm dòng này

if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['id'])) {
    $id = $_POST['id'];

    $sql = "UPDATE products SET is_active = 0 WHERE id = ?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("i", $id);

    if ($stmt->execute()) {
        echo json_encode(['status' => 'success', 'message' => 'Đã xóa thành công!']);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Lỗi hệ thống!']);
    }
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\delete_schedule.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $id = $_POST['id'];
    $conn->query("DELETE FROM work_schedules WHERE id = $id");
    echo json_encode(['status' => 'success']);
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\delete_voucher.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $id = $_POST['id'];
    $sql = "DELETE FROM vouchers WHERE id = ?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("i", $id);

    if ($stmt->execute()) {
        echo json_encode(['status' => 'success', 'message' => 'Đã xóa mã giảm giá!']);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Lỗi không thể xóa!']);
    }
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\export_excel.php ----------------
<?php
// Load thư viện PhpSpreadsheet
require '../vendor/autoload.php'; 
require '../../includes/db_connection.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
use PhpOffice\PhpSpreadsheet\Style\Alignment;
use PhpOffice\PhpSpreadsheet\Style\Border;

$conn = connect_db();

// Lấy tham số ngày
$end_date = isset($_GET['end']) ? $_GET['end'] : date('Y-m-d');
$start_date = isset($_GET['start']) ? $_GET['start'] : date('Y-m-d', strtotime('-6 days'));
$start_sql = "$start_date 00:00:00";
$end_sql = "$end_date 23:59:59";

// Tạo Spreadsheet mới
$spreadsheet = new Spreadsheet();
$sheet = $spreadsheet->getActiveSheet();

// 1. Tiêu đề báo cáo
$sheet->setCellValue('A1', "BÁO CÁO DOANH THU");
$sheet->mergeCells('A1:D1');
$sheet->getStyle('A1')->getFont()->setBold(true)->setSize(14);
$sheet->getStyle('A1')->getAlignment()->setHorizontal(Alignment::HORIZONTAL_CENTER);

$sheet->setCellValue('A2', "Từ ngày: $start_date đến $end_date");
$sheet->mergeCells('A2:D2');
$sheet->getStyle('A2')->getAlignment()->setHorizontal(Alignment::HORIZONTAL_CENTER);

// 2. Header cột
$headers = ['A3' => 'Mã Đơn', 'B3' => 'Thời gian', 'C3' => 'Nhân viên', 'D3' => 'Thành tiền'];
foreach ($headers as $cell => $val) {
    $sheet->setCellValue($cell, $val);
    $sheet->getStyle($cell)->getFont()->setBold(true);
    $sheet->getStyle($cell)->getBorders()->getAllBorders()->setBorderStyle(Border::BORDER_THIN);
    $sheet->getStyle($cell)->getFill()->setFillType(\PhpOffice\PhpSpreadsheet\Style\Fill::FILL_SOLID)->getStartColor()->setARGB('FFEEEEEE');
}
$sheet->getColumnDimension('B')->setWidth(20);
$sheet->getColumnDimension('C')->setWidth(20);
$sheet->getColumnDimension('D')->setWidth(15);

// 3. Lấy dữ liệu
$sql = "SELECT o.id, o.order_date, o.final_amount, u.fullname 
        FROM orders o 
        JOIN users u ON o.user_id = u.id 
        WHERE o.status = 'paid' 
        AND o.order_date BETWEEN '$start_sql' AND '$end_sql' 
        ORDER BY o.order_date ASC";
$query = mysqli_query($conn, $sql);

$rowNum = 4;
$totalRevenue = 0;

while ($row = mysqli_fetch_assoc($query)) {
    $sheet->setCellValue('A' . $rowNum, '#' . $row['id']);
    $sheet->setCellValue('B' . $rowNum, date('H:i d/m/Y', strtotime($row['order_date'])));
    $sheet->setCellValue('C' . $rowNum, $row['fullname']);
    $sheet->setCellValue('D' . $rowNum, $row['final_amount']);
    $sheet->getStyle('D' . $rowNum)->getNumberFormat()->setFormatCode('#,##0');
    
    $totalRevenue += $row['final_amount'];
    $rowNum++;
}

// 4. Dòng tổng cộng
$sheet->setCellValue('A' . $rowNum, 'TỔNG CỘNG');
$sheet->mergeCells('A' . $rowNum . ':C' . $rowNum);
$sheet->setCellValue('D' . $rowNum, $totalRevenue);
$sheet->getStyle('A' . $rowNum . ':D' . $rowNum)->getFont()->setBold(true);
$sheet->getStyle('D' . $rowNum)->getNumberFormat()->setFormatCode('#,##0');

// 5. Xuất file
$filename = "Bao_cao_doanh_thu_" . time() . ".xlsx";

header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
header('Content-Disposition: attachment;filename="' . $filename . '"');
header('Cache-Control: max-age=0');

$writer = new Xlsx($spreadsheet);
$writer->save('php://output');
exit;
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\get_ingredients.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

// Lấy danh sách nguyên liệu
$sql = "SELECT * FROM ingredients ORDER BY name ASC";
$result = $conn->query($sql);

$ingredients = [];
if ($result->num_rows > 0) {
    while($row = $result->fetch_assoc()) {
        $ingredients[] = $row;
    }
}

echo json_encode($ingredients);
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\get_items.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();

$category_id = isset($_GET['category']) ? (int)$_GET['category'] : 0; 
$search = isset($_GET['search']) ? mysqli_real_escape_string($conn, $_GET['search']) : '';

$sql = "SELECT * FROM products WHERE is_active = 1";
if ($category_id > 0) $sql .= " AND category_id = $category_id";
if (!empty($search)) $sql .= " AND name LIKE '%$search%'";
$sql .= " ORDER BY id DESC";

$query = mysqli_query($conn, $sql);

if (mysqli_num_rows($query) > 0) {
    echo '<div class="row">';
    while ($row = mysqli_fetch_assoc($query)) {
        $img_url = $row['image_url'];

        // --- LOGIC XỬ LÝ ĐƯỜNG DẪN ẢNH (QUAN TRỌNG) ---
        
        // Trường hợp 1: Ảnh Upload (DB lưu "uploads/...") 
        // -> Thêm "../" để lùi ra root lấy ảnh
        if (strpos($img_url, 'uploads') === 0) {
            $img_url = '../' . $img_url; 
        }
        // Trường hợp 2: Ảnh trong Assets (DB lưu "assets/..." mà thiếu "../")
        // -> Thêm "../" để lùi ra root rồi mới vào assets (vì assets nằm ngang hàng admin)
        elseif (strpos($img_url, 'assets') === 0) {
             $img_url = '../' . $img_url;
        }
        // Trường hợp 3: DB đã lưu đúng "../assets/..." 
        // -> Giữ nguyên (Đây là trường hợp chuẩn trong file SQL của bạn)

        $price = number_format($row['price'], 0, ',', '.');
        
        echo '
        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
            <div class="card h-100 shadow-sm">
                <div style="height: 120px; overflow: hidden; border-bottom: 1px solid #eee;">
                    <img src="'.$img_url.'" class="card-img-top" alt="'.$row['name'].'" 
                         style="width: 100%; height: 100%; object-fit: cover;"
                         onerror="this.src=\'assets/dist/img/logo coffee.png\'">
                </div>
                <div class="card-body p-2">
                    <h5 class="card-title font-weight-bold" style="font-size: 1rem; height: 35px; overflow: hidden; margin-bottom: 5px;">'.$row['name'].'</h5>
                    <p class="card-text text-danger font-weight-bold mb-2" style="font-size: 0.95rem;">'.$price.' đ</p>
                    
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-sm btn-warning w-45 btn-edit" style="font-size: 0.85rem;"
                            data-id="'.$row['id'].'"
                            data-name="'.$row['name'].'"
                            data-price="'.$row['price'].'"
                            data-category="'.$row['category_id'].'"
                            data-img="'.$img_url.'">
                            <i class="fas fa-edit"></i> Sửa
                        </button>
                        <button type="button" class="btn btn-sm btn-danger w-45 btn-delete" style="font-size: 0.85rem;"
                            data-id="'.$row['id'].'">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                </div>
            </div>
        </div>';
    }
    echo '</div>';
} else {
    echo '<div class="col-12 text-center text-muted p-5"><h4>Không tìm thấy món nào.</h4></div>';
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\get_orders.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();

$search = isset($_GET['search']) ? mysqli_real_escape_string($conn, $_GET['search']) : '';

// Lấy đơn hàng kèm tên nhân viên
$sql = "SELECT o.*, u.fullname as staff_name 
        FROM orders o 
        LEFT JOIN users u ON o.user_id = u.id 
        WHERE o.id LIKE '%$search%' OR u.fullname LIKE '%$search%'
        ORDER BY o.order_date DESC LIMIT 50";

$query = mysqli_query($conn, $sql);

if (mysqli_num_rows($query) > 0) {
    echo '<div class="table-responsive"><table class="table table-hover table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>Mã Đơn</th>
                    <th>Thời gian</th>
                    <th>Người bán</th>
                    <th>Tổng tiền</th>
                    <th>Trạng thái</th>
                    <th class="text-center">Hành động</th>
                </tr>
            </thead>
            <tbody>';
    
    while ($row = mysqli_fetch_assoc($query)) {
        // Hiển thị trạng thái
        $status_badge = '';
        if($row['status'] == 'paid') $status_badge = '<span class="badge badge-success">Đã thanh toán</span>';
        elseif($row['status'] == 'canceled') $status_badge = '<span class="badge badge-danger">Đã hủy</span>';
        else $status_badge = '<span class="badge badge-warning">Chưa thanh toán</span>';

        // Format tiền
        $final_price = number_format($row['final_amount'], 0, ',', '.');
        
        // Nút Hủy chỉ hiện khi đơn chưa hủy
        $btn_cancel = ($row['status'] != 'canceled') ? 
            '<button class="btn btn-sm btn-danger ml-1" onclick="xacNhanHuy('.$row['id'].')">
                <i class="fas fa-ban"></i> Hủy
            </button>' : '';

        echo '<tr>
                <td><strong>#'.$row['id'].'</strong></td>
                <td>'.date('H:i d/m/Y', strtotime($row['order_date'])).'</td>
                <td>'.$row['staff_name'].'</td>
                <td class="font-weight-bold text-success">'.$final_price.' đ</td>
                <td>'.$status_badge.'</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-info" onclick="xemChiTietDon('.$row['id'].')">
                        <i class="fas fa-eye"></i> Xem
                    </button>
                    '.$btn_cancel.'
                </td>
              </tr>';
    }
    echo '</tbody></table></div>';
} else {
    echo '<div class="alert alert-info text-center">Chưa có đơn hàng nào.</div>';
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\get_order_detail.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();

if (isset($_GET['id'])) {
    $order_id = $_GET['id'];
    
    $sql = "SELECT oi.*, p.name as product_name 
            FROM order_items oi 
            JOIN products p ON oi.product_id = p.id 
            WHERE oi.order_id = $order_id";
            
    $query = mysqli_query($conn, $sql);
    
    echo '<table class="table table-bordered">
            <thead class="bg-light">
                <tr>
                    <th>Tên món</th>
                    <th>Số lượng</th>
                    <th>Ghi chú</th>
                </tr>
            </thead>
            <tbody>';
            
    while ($row = mysqli_fetch_assoc($query)) {
        echo '<tr>
                <td>'.$row['product_name'].'</td>
                <td class="font-weight-bold text-center">'.$row['quantity'].'</td>
                <td><small class="text-muted">'.$row['note'].'</small></td>
              </tr>';
    }
    echo '</tbody></table>';
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\get_recipe_detail.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if (isset($_GET['product_id'])) {
    $id = $_GET['product_id'];
    $sql = "SELECT ingredient_id, quantity_required FROM recipes WHERE product_id = ?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("i", $id);
    $stmt->execute();
    $result = $stmt->get_result();
    
    $recipes = [];
    while($row = $result->fetch_assoc()){
        $recipes[] = $row;
    }
    echo json_encode($recipes);
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\get_report_stats.php ----------------
<?php
// admin/api/get_report_stats.php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

// 1. Nhận tham số ngày tháng từ Client
$start_date = isset($_GET['start']) ? $_GET['start'] : date('Y-m-01');
$end_date   = isset($_GET['end'])   ? $_GET['end']   : date('Y-m-d');

$start_datetime = $start_date . " 00:00:00";
$end_datetime   = $end_date . " 23:59:59";

// =================================================================================
// BƯỚC 1: TÍNH GIÁ VỐN TRUNG BÌNH CỦA TỪNG NGUYÊN LIỆU (Dựa trên inventory_log)
// =================================================================================
// Logic: Tổng tiền nhập / Tổng số lượng nhập (Weighted Average Cost)
// Chỉ lấy các log có type = 'import'

$ing_costs = []; // Mảng [ingredient_id => price_per_unit]

$sql_avg_cost = "SELECT 
                    ingredient_id, 
                    SUM(cost) as total_import_cost, 
                    SUM(quantity) as total_import_qty
                 FROM inventory_log 
                 WHERE type = 'import' 
                 GROUP BY ingredient_id";

$result_avg = mysqli_query($conn, $sql_avg_cost);
while ($row = mysqli_fetch_assoc($result_avg)) {
    if ($row['total_import_qty'] > 0) {
        $ing_costs[$row['ingredient_id']] = $row['total_import_cost'] / $row['total_import_qty'];
    }
}

// Fallback: Nếu nguyên liệu chưa từng nhập trong log, lấy giá từ bảng ingredients (nếu bạn đã thêm cột avg_price)
// Hoặc mặc định là 0 nếu không tìm thấy.

// =================================================================================
// BƯỚC 2: TÍNH GIÁ VỐN CỦA TỪNG SẢN PHẨM (PRODUCT BASE COST)
// =================================================================================
// Dựa vào bảng recipes và giá vốn nguyên liệu vừa tính ở trên

$product_base_cost = []; // Mảng [product_id => cost]

$sql_recipes = "SELECT product_id, ingredient_id, quantity_required FROM recipes";
$result_recipes = mysqli_query($conn, $sql_recipes);

while ($row = mysqli_fetch_assoc($result_recipes)) {
    $pid = $row['product_id'];
    $iid = $row['ingredient_id'];
    $qty = $row['quantity_required'];
    
    // Lấy giá vốn nguyên liệu, nếu không có thì bằng 0
    $unit_cost = isset($ing_costs[$iid]) ? $ing_costs[$iid] : 0;
    
    if (!isset($product_base_cost[$pid])) {
        $product_base_cost[$pid] = 0;
    }
    $product_base_cost[$pid] += ($qty * $unit_cost);
}

// =================================================================================
// BƯỚC 3: LẤY DANH SÁCH ĐƠN HÀNG VÀ TÍNH TOÁN
// =================================================================================

$total_revenue = 0;
$total_cogs    = 0; // Cost of Goods Sold (Giá vốn hàng bán)
$total_orders  = 0;
$report_table  = '';

// Chỉ lấy đơn hàng đã thanh toán ('paid')
$sql_orders = "SELECT o.id, o.order_date, o.total_price, o.final_amount, o.payment_method, u.fullname as staff_name 
               FROM orders o
               LEFT JOIN users u ON o.user_id = u.id
               WHERE o.status = 'paid' 
               AND o.order_date BETWEEN '$start_datetime' AND '$end_datetime'
               ORDER BY o.order_date DESC";

$query_orders = mysqli_query($conn, $sql_orders);

if (mysqli_num_rows($query_orders) > 0) {
    while ($order = mysqli_fetch_assoc($query_orders)) {
        $order_id = $order['id'];
        
        // 1. Tính doanh thu thực tế (Ưu tiên final_amount nếu có discount)
        $revenue = ($order['final_amount'] > 0) ? $order['final_amount'] : $order['total_price'];
        $total_revenue += $revenue;
        $total_orders++;

        // 2. Tính giá vốn của đơn hàng này
        $order_cogs = 0;
        
        // Lấy chi tiết món trong đơn
        $sql_items = "SELECT product_id, quantity FROM order_items WHERE order_id = $order_id";
        $query_items = mysqli_query($conn, $sql_items);
        
        while ($item = mysqli_fetch_assoc($query_items)) {
            $pid = $item['product_id'];
            $qty_sold = $item['quantity'];
            
            // Nếu sản phẩm có công thức, cộng dồn giá vốn
            if (isset($product_base_cost[$pid])) {
                $order_cogs += $product_base_cost[$pid] * $qty_sold;
            }
        }
        $total_cogs += $order_cogs;
        
        // Tính lợi nhuận đơn lẻ
        $order_profit = $revenue - $order_cogs;

        // Tạo dòng HTML cho bảng báo cáo chi tiết
        $report_table .= '<tr>
            <td>#' . $order_id . '</td>
            <td>' . date('H:i d/m/Y', strtotime($order['order_date'])) . '</td>
            <td>' . htmlspecialchars($order['staff_name']) . '</td>
            <td class="text-right">' . number_format($revenue) . ' đ</td>
            <td class="text-right text-danger">' . number_format($order_cogs) . ' đ</td>
            <td class="text-right text-success font-weight-bold">' . number_format($order_profit) . ' đ</td>
        </tr>';
    }
} else {
    $report_table = '<tr><td colspan="6" class="text-center text-muted">Không có đơn hàng đã thanh toán trong khoảng thời gian này.</td></tr>';
}

// =================================================================================
// BƯỚC 4: TRẢ VỀ JSON
// =================================================================================

$response = [
    'status' => 'success',
    'summary' => [
        'revenue' => $total_revenue,
        'cogs'    => $total_cogs,
        'profit'  => $total_revenue - $total_cogs,
        'orders'  => $total_orders
    ],
    'html' => $report_table
];

echo json_encode($response);
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\get_schedules.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

// Lấy ngày bắt đầu tuần (Monday) từ tham số hoặc mặc định là tuần này
$start_date = isset($_GET['start_date']) ? $_GET['start_date'] : date('Y-m-d', strtotime('monday this week'));
$end_date = date('Y-m-d', strtotime($start_date . ' +6 days'));

$sql = "SELECT ws.id, ws.user_id, ws.shift_date, ws.shift_type, u.fullname 
        FROM work_schedules ws
        JOIN users u ON ws.user_id = u.id
        WHERE ws.shift_date BETWEEN '$start_date' AND '$end_date'";

$query = mysqli_query($conn, $sql);
$schedules = [];
while ($row = mysqli_fetch_assoc($query)) {
    $schedules[] = $row;
}

echo json_encode(['status' => 'success', 'data' => $schedules, 'start_date' => $start_date]);
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\get_users.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();

// 1. Nhận từ khóa tìm kiếm
$search = isset($_GET['search']) ? mysqli_real_escape_string($conn, $_GET['search']) : '';

// 2. Viết câu SQL có điều kiện tìm kiếm
$sql = "SELECT id, fullname, username, role, status FROM users";
if (!empty($search)) {
    $sql .= " WHERE fullname LIKE '%$search%' OR username LIKE '%$search%'";
}
$sql .= " ORDER BY id DESC";

$query = mysqli_query($conn, $sql);

// 3. Nút thêm nhân viên sẽ được xử lý ở main.php, file này chỉ trả về danh sách thẻ (Card)
if (mysqli_num_rows($query) > 0) {
    echo '<div class="row">';
    while ($user = mysqli_fetch_assoc($query)) {
        $status_badge = $user['status'] == 1 ? '<span class="badge badge-success">Đang làm việc</span>' : '<span class="badge badge-danger">Đã khóa</span>';
        
        $role_text = '';
        if ($user['role'] == 'admin') $role_text = 'Quản trị viên';
        elseif ($user['role'] == 'staff') $role_text = 'Nhân viên phục vụ';
        else $role_text = 'Thủ kho';
        
        echo '
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm border-0" style="border-radius: 15px;">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-light p-3 rounded-circle mr-3"><i class="fas fa-user-tie fa-2x text-info"></i></div>
                        <div>
                            <h5 class="card-title mb-0 font-weight-bold">'.$user['fullname'].'</h5>
                            <small class="text-muted">@'.$user['username'].'</small>
                        </div>
                    </div>
                    <p class="mb-1"><strong>Chức vụ:</strong> '.$role_text.'</p>
                    <p class="mb-3"><strong>Trạng thái:</strong> '.$status_badge.'</p>
                    <button class="btn btn-sm btn-warning btn-block btn-edit-user" 
                        data-id="'.$user['id'].'" 
                        data-fullname="'.$user['fullname'].'" 
                        data-username="'.$user['username'].'" 
                        data-role="'.$user['role'].'" 
                        data-status="'.$user['status'].'">
                        <i class="fas fa-key"></i> Sửa / Đổi mật khẩu
                    </button>
                </div>
            </div>
        </div>';
    }
    echo '</div>';
} else {
    echo '<div class="alert alert-warning text-center">Không tìm thấy nhân viên nào phù hợp.</div>';
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\get_vouchers.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();

$sql = "SELECT * FROM vouchers ORDER BY id DESC";
$query = mysqli_query($conn, $sql);

if (mysqli_num_rows($query) > 0) {
    echo '<div class="row">';
    while ($row = mysqli_fetch_assoc($query)) {
        echo '
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm border-left-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="font-weight-bold text-primary mb-1">'.$row['code'].'</h4>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">Giảm: '.$row['discount_percent'].'%</div>
                            <small class="text-muted">'.$row['description'].'</small>
                        </div>
                        <div class="text-right">
                             <i class="fas fa-ticket-alt fa-2x text-gray-300"></i>
                             <button class="btn btn-sm btn-danger mt-2 d-block" onclick="xoaVoucher('.$row['id'].')">
                                <i class="fas fa-trash"></i> Xóa
                             </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>';
    }
    echo '</div>';
} else {
    echo '<div class="alert alert-info text-center">Chưa có mã giảm giá nào.</div>';
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\update_ingredient_min.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $id = $_POST['id'];
    $min_qty = $_POST['min_quantity'];

    $sql = "UPDATE ingredients SET min_quantity = ? WHERE id = ?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("di", $min_qty, $id);

    if ($stmt->execute()) {
        echo json_encode(['status' => 'success', 'message' => 'Đã cập nhật mức cảnh báo!']);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Lỗi: ' . $conn->error]);
    }
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\update_item.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $id = $_POST['edit_id'];
    $name = $_POST['edit_name'];
    $price = $_POST['edit_price'];
    $category = $_POST['edit_category'];

    // 1. Giữ ảnh cũ hoặc upload ảnh mới
    $sql_get = "SELECT image_url FROM products WHERE id = ?";
    $stmt_get = $conn->prepare($sql_get);
    $stmt_get->bind_param("i", $id);
    $stmt_get->execute();
    $result = $stmt_get->get_result();
    $row = $result->fetch_assoc();
    $image_path = $row['image_url'];

    if (!empty($_FILES['edit_image']['name'])) {
        $target_dir = "../../uploads/";
        $filename = time() . "_" . basename($_FILES["edit_image"]["name"]);
        $target_file = $target_dir . $filename;
        if (move_uploaded_file($_FILES["edit_image"]["tmp_name"], $target_file)) {
            $image_path = "uploads/" . $filename;
        }
    }

    // 2. Cập nhật bảng products
    $sql = "UPDATE products SET name=?, price=?, category_id=?, image_url=? WHERE id=?";
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("siisi", $name, $price, $category, $image_path, $id);

    if ($stmt->execute()) {
        // 3. Cập nhật công thức: XÓA CŨ -> THÊM MỚI (Cách đơn giản nhất để tránh trùng lặp)
        $conn->query("DELETE FROM recipes WHERE product_id = $id");

        if (isset($_POST['ing_id']) && isset($_POST['ing_qty'])) {
            $ing_ids = $_POST['ing_id'];
            $ing_qtys = $_POST['ing_qty'];
            
            $sql_recipe = "INSERT INTO recipes (product_id, ingredient_id, quantity_required) VALUES (?, ?, ?)";
            $stmt_recipe = $conn->prepare($sql_recipe);

            for ($i = 0; $i < count($ing_ids); $i++) {
                if (!empty($ing_ids[$i]) && $ing_qtys[$i] > 0) {
                    $stmt_recipe->bind_param("iid", $id, $ing_ids[$i], $ing_qtys[$i]);
                    $stmt_recipe->execute();
                }
            }
        }
        echo json_encode(['status' => 'success', 'message' => 'Cập nhật thành công!']);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Lỗi SQL: ' . $conn->error]);
    }
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\update_min_stock.php ----------------
<?php
// admin/api/update_min_stock.php
require_once '../../includes/db_connection.php';
header('Content-Type: application/json');

// Xử lý biến kết nối (hỗ trợ cả $conn và $mysqli để tránh lỗi)
if (!isset($conn) && isset($mysqli)) {
    $conn = $mysqli;
}
if (!isset($conn) && function_exists('connect_db')) {
    $conn = connect_db();
}

// Kiểm tra kết nối
if (!$conn || $conn->connect_error) {
    echo json_encode(['status' => 'error', 'message' => 'Lỗi kết nối Database']);
    exit;
}

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_POST['data'])) {
        $data = json_decode($_POST['data'], true);
        
        if (is_array($data)) {
            // Chuẩn bị câu lệnh SQL cập nhật
            $stmt = $conn->prepare("UPDATE ingredients SET min_quantity = ? WHERE id = ?");
            
            $successCount = 0;
            foreach ($data as $item) {
                $id = intval($item['id']);
                $min = floatval($item['min_quantity']);
                
                $stmt->bind_param("di", $min, $id);
                if ($stmt->execute()) {
                    $successCount++;
                }
            }
            $stmt->close();
            
            echo json_encode(['status' => 'success', 'message' => "Đã cập nhật $successCount nguyên liệu"]);
        } else {
            echo json_encode(['status' => 'error', 'message' => 'Dữ liệu không đúng định dạng']);
        }
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Không nhận được dữ liệu']);
    }
}
?>
---------------- END FILE ----------------

---------------- START FILE: admin\api\update_user.php ----------------
<?php
require '../../includes/db_connection.php';
$conn = connect_db();
header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $id = $_POST['user_id'];
    $fullname = $_POST['fullname'];
    $role = $_POST['role'];
    $status = $_POST['status'];

    // Nếu có nhập mật khẩu mới thì cập nhật, không thì giữ nguyên
    if (!empty($_POST['password'])) {
        $password = password_hash($_POST['password'], PASSWORD_DEFAULT);
        $sql = "UPDATE users SET fullname=?, role=?, status=?, password=? WHERE id=?";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("ssisi", $fullname, $role, $status, $password, $id);
    } else {
        $sql = "UPDATE users SET fullname=?, role=?, status=? WHERE id=?";
        $stmt = $conn->prepare($sql);
        $stmt->bind_param("ssii", $fullname, $role, $status, $id);
    }

    if ($stmt->execute()) {
        echo json_encode(['status' => 'success', 'message' => 'Cập nhật tài khoản thành công!']);
    } else {
        echo json_encode(['status' => 'error', 'message' => 'Lỗi cập nhật!']);
    }
}
?>
---------------- END FILE ----------------

---------------- START FILE: assets\img\drink\index.php ----------------

---------------- END FILE ----------------

---------------- START FILE: assets\img\food\index.php ----------------

---------------- END FILE ----------------

---------------- START FILE: core\index.php ----------------

---------------- END FILE ----------------

---------------- START FILE: core\order_processor.php ----------------
<?php
session_start();
error_reporting(0);
ini_set('display_errors', 0);
header('Content-Type: application/json; charset=utf-8');
require_once '../includes/db_connection.php';

try {
    // 1. Check Login & Ca làm việc
    if (!isset($_SESSION['user_id'])) throw new Exception("Chưa đăng nhập!");
    $current_session_id = getActiveSessionId($mysqli, $_SESSION['user_id']);
    if (!$current_session_id) throw new Exception("Chưa vào ca làm việc!");

    // 2. Nhận dữ liệu từ Client
    $input = json_decode(file_get_contents("php://input"), true);
    if (!$input || empty($input['items'])) throw new Exception("Giỏ hàng rỗng.");
    // --- [THÊM DÒNG NÀY] ---
    // Mặc định là 'cash' nếu không có dữ liệu gửi lên
    $payment_method = isset($input['payment_method']) ? $input['payment_method'] : 'cash'; 
    // -----------------------
    // --- [XỬ LÝ VOUCHER & GIẢM GIÁ (ĐÃ FIX CHECK DB)] ---
    $voucher_code = isset($input['voucher_code']) ? strtoupper(trim($input['voucher_code'])) : '';
    // $requested_percent chỉ dùng cho ADMINVIP, các mã khác phải lấy từ DB để bảo mật
    $requested_percent = isset($input['discount_percent']) ? (float)$input['discount_percent'] : 0;
    
    $applied_discount_percent = 0; // Mặc định không giảm

    // TRƯỜNG HỢP 1: ADMINVIP (Quyền lực tối cao - Tự nhập %)
    if ($voucher_code === 'ADMINVIP') {
        // Check quyền: Phải là admin mới được dùng
        $stmt_role = $mysqli->prepare("SELECT role FROM users WHERE id = ?");
        $stmt_role->bind_param("i", $_SESSION['user_id']);
        $stmt_role->execute();
        $user_role = $stmt_role->get_result()->fetch_assoc()['role'] ?? 'staff';

        if ($user_role === 'admin') {
            if ($requested_percent < 0 || $requested_percent > 100) {
                throw new Exception("Phần trăm giảm giá không hợp lệ (0-100).");
            }
            $applied_discount_percent = $requested_percent;
        } else {
            throw new Exception("Mã ADMINVIP chỉ dành cho Quản lý!");
        }
    }
    // TRƯỜNG HỢP 2: CÁC MÃ KHÁC (Check trong Database)
    elseif (!empty($voucher_code)) {
        // Truy vấn bảng vouchers để lấy % chính xác
        $stmt_v = $mysqli->prepare("SELECT discount_percent FROM vouchers WHERE code = ?");
        $stmt_v->bind_param("s", $voucher_code);
        $stmt_v->execute();
        $res_v = $stmt_v->get_result();
        
        if ($row_v = $res_v->fetch_assoc()) {
            // Lấy % từ DB (không tin client gửi lên để tránh hack F12 sửa %)
            $applied_discount_percent = (float)$row_v['discount_percent'];
        } else {
            // Mã có gửi lên nhưng không tìm thấy trong DB
            throw new Exception("Mã giảm giá '$voucher_code' không tồn tại hoặc hết hạn!");
        }
    }

    // 3. Tính tổng tiền (Server tự tính từ DB)
    $server_total_amount = 0;
    $clean_items = [];
    $stmt_get_price = $mysqli->prepare("SELECT price FROM products WHERE id = ?");

    foreach ($input['items'] as $item) {
        $p_id = (int)$item['product_id'];
        $qty = (int)$item['quantity'];
        if ($qty <= 0) continue;

        $stmt_get_price->bind_param("i", $p_id);
        $stmt_get_price->execute();
        $res = $stmt_get_price->get_result();
        
        if ($row = $res->fetch_assoc()) {
            $real_price = (float)$row['price'];
            $server_total_amount += ($real_price * $qty);
            $clean_items[] = [
                'product_id' => $p_id,
                'quantity' => $qty,
                'note' => $item['note'] ?? ''
            ];
        }
    }

    // 4. Áp dụng giảm giá
    $discount_amount = $server_total_amount * ($applied_discount_percent / 100);
    $final_amount = $server_total_amount - $discount_amount;

    // ... (Phần trên giữ nguyên) ...

    // 5. Lưu vào DB
    $mysqli->begin_transaction();

    // --- [ĐOẠN CODE ĐÃ SỬA] ---
    $sql_order = "INSERT INTO orders (user_id, total_price, final_amount, discount_percent, voucher_code, payment_method, order_date, status, session_id) VALUES (?, ?, ?, ?, ?, ?, NOW(), 'paid', ?)";
    $stmt_order = $mysqli->prepare($sql_order);
    
    // Chú ý: "idddssi" tương ứng với các kiểu dữ liệu bên dưới
    $stmt_order->bind_param("idddssi", 
        $_SESSION['user_id'], 
        $server_total_amount, 
        $final_amount, 
        $applied_discount_percent, 
        $voucher_code,
        $payment_method,      // <-- BIẾN MỚI
        $current_session_id
    );
    // --------------------------
    
    if (!$stmt_order->execute()) throw new Exception("Lỗi tạo đơn: " . $stmt_order->error);
    $new_order_id = $mysqli->insert_id;

    // ... (Phần dưới giữ nguyên) ...

    
    // Insert Items & Trừ kho (Giữ nguyên logic cũ)
    $sql_item = "INSERT INTO order_items (order_id, product_id, quantity, note) VALUES (?, ?, ?, ?)";
    $stmt_item = $mysqli->prepare($sql_item);
    
    $sql_recipe = "SELECT ingredient_id, quantity_required FROM recipes WHERE product_id = ?";
    $stmt_recipe = $mysqli->prepare($sql_recipe);
    
    $sql_stock = "UPDATE ingredients SET quantity = quantity - ? WHERE id = ?";
    $stmt_stock = $mysqli->prepare($sql_stock);
    
    $sql_log = "INSERT INTO inventory_log (ingredient_id, type, quantity, note, user_id, created_at) VALUES (?, 'export', ?, ?, ?, NOW())";
    $stmt_log = $mysqli->prepare($sql_log);
    $log_note = "Bán đơn #$new_order_id";

    foreach ($clean_items as $item) {
        $stmt_item->bind_param("iiis", $new_order_id, $item['product_id'], $item['quantity'], $item['note']);
        $stmt_item->execute();

        // Trừ kho
        $stmt_recipe->bind_param("i", $item['product_id']);
        $stmt_recipe->execute();
        $res_recipe = $stmt_recipe->get_result();
        while ($r = $res_recipe->fetch_assoc()) {
            $ing_id = $r['ingredient_id'];
            $need = $r['quantity_required'] * $item['quantity'];
            
            $stmt_stock->bind_param("di", $need, $ing_id);
            $stmt_stock->execute();
            
            $stmt_log->bind_param("idsi", $ing_id, $need, $log_note, $_SESSION['user_id']);
            $stmt_log->execute();
        }
    }

    $mysqli->commit();

    echo json_encode([
        'success' => true, 
        'order_id' => $new_order_id,
        'total_original' => $server_total_amount,
        'discount_percent' => $applied_discount_percent,
        'final_amount' => $final_amount
    ]);

} catch (Exception $e) {
    $mysqli->rollback();
    echo json_encode(['success' => false, 'message' => $e->getMessage()]);
}
?>
---------------- END FILE ----------------

---------------- START FILE: core\products-list.php ----------------
<?php
    require_once '../includes/db_connection.php';
    $sql = "SELECT * FROM products 
WHERE is_active = 1 
ORDER BY name ASC;";
    $stmt = $mysqli->prepare($sql);
    if ($stmt === false) {
        die("Lỗi chuẩn bị: " . $mysqli->error);
    }
    $stmt->execute();
    $result_products= $stmt->get_result();
    
    $sql = "SELECT * FROM categories;";
    $stmt = $mysqli->prepare($sql);
    if ($stmt === false) {
        die("Lỗi chuẩn bị: " . $mysqli->error);
    }
    $stmt->execute();
    $result_categories= $stmt->get_result();

    $sql = "SELECT * FROM products WHERE is_active = 1 ORDER BY name ASC;";
    $stmt = $mysqli->prepare($sql);
    if ($stmt === false) {
        die("Lỗi chuẩn bị: " . $mysqli->error);
    }

?>
---------------- END FILE ----------------

---------------- START FILE: core\session_manager.php ----------------
<?php
session_start();
require_once '../includes/db_connection.php';
header('Content-Type: application/json');

$action = $_GET['action'] ?? '';
$user_id = $_SESSION['user_id'] ?? 0;

if ($user_id == 0) {
    echo json_encode(['success' => false, 'message' => 'Chưa đăng nhập']);
    require_once '../logout.php';
    exit;
}

try {
    // 1. Kiểm tra trạng thái hiện tại
    if ($action === 'check_status') {
        $stmt = $mysqli->prepare("SELECT id, start_time, start_cash FROM work_sessions WHERE user_id = ? AND status = 'open' LIMIT 1");
        $stmt->bind_param("i", $user_id);
        $stmt->execute();
        $res = $stmt->get_result();
        
        if ($row = $res->fetch_assoc()) {
            echo json_encode(['success' => true, 'is_open' => true, 'data' => $row]);
        } else {
            echo json_encode(['success' => true, 'is_open' => false]);
        }
    }

    // 2. Vào ca (Start Shift)
    // ... (Phần check login giữ nguyên)

    // 2. Vào ca (Start Shift) - CÓ LOGIC TỰ ĐỘNG CHỐT CA CŨ
    elseif ($action === 'start_shift') {
        $input = json_decode(file_get_contents("php://input"), true);
        $start_cash = isset($input['start_cash']) ? (float)$input['start_cash'] : 0;

        // BẮT ĐẦU TRANSACTION ĐỂ ĐẢM BẢO DỮ LIỆU
        $mysqli->begin_transaction();

        try {
            // BƯỚC 1: Kiểm tra xem chính User này có đang mở ca không?
            $check_self = $mysqli->prepare("SELECT id FROM work_sessions WHERE user_id = ? AND status = 'open'");
            $check_self->bind_param("i", $user_id);
            $check_self->execute();
            if ($check_self->get_result()->num_rows > 0) {
                throw new Exception("Bạn đang trong một ca làm việc khác rồi! Hãy F5 lại.");
            }

            // BƯỚC 2: Kiểm tra xem có AI KHÁC đang mở ca không? (Trường hợp A bỏ về)
            // Lưu ý: Chỉ áp dụng nếu quán chỉ có 1 máy POS/1 ngăn kéo tiền.
            // Nếu nhiều máy thì logic sẽ phức tạp hơn (phải check theo device_id).
            // Ở đây giả định quy mô 1 quầy thu ngân.
            
            $check_others = $mysqli->query("SELECT id, user_id, start_time FROM work_sessions WHERE status = 'open' LIMIT 1");
            
            if ($row_other = $check_others->fetch_assoc()) {
                // PHÁT HIỆN CA CŨ CHƯA ĐÓNG!
                $old_session_id = $row_other['id'];
                $old_user_id = $row_other['user_id'];
                $old_start_time = $row_other['start_time'];

                // A. Tính doanh thu của ca cũ đó
                $stmt_sales = $mysqli->prepare("SELECT SUM(total_price) as total FROM orders WHERE user_id = ? AND order_date >= ? AND status = 'paid'");
                $stmt_sales->bind_param("is", $old_user_id, $old_start_time);
                $stmt_sales->execute();
                $total_sales_old = $stmt_sales->get_result()->fetch_assoc()['total'] ?? 0;

                // B. Cưỡng chế đóng ca cũ (FORCE CLOSE)
                // Lấy tiền đầu ca của B gán cho tiền cuối ca của A
                // Ghi chú tự động
                $auto_note = "Hệ thống tự chốt do nhân viên mới vào ca.";
                
                $stmt_close_old = $mysqli->prepare("UPDATE work_sessions SET end_time = NOW(), end_cash = ?, total_sales = ?, note = ?, status = 'closed' WHERE id = ?");
                $stmt_close_old->bind_param("ddsi", $start_cash, $total_sales_old, $auto_note, $old_session_id);
                
                if (!$stmt_close_old->execute()) {
                    throw new Exception("Lỗi hệ thống khi chốt ca cũ.");
                }
            }

            // BƯỚC 3: Mở ca mới cho nhân viên B (Bình thường)
            $stmt_new = $mysqli->prepare("INSERT INTO work_sessions (user_id, start_cash, start_time, status) VALUES (?, ?, NOW(), 'open')");
            $stmt_new->bind_param("id", $user_id, $start_cash);
            
            if ($stmt_new->execute()) {
                $mysqli->commit();
                echo json_encode([
                    'success' => true, 
                    'message' => 'Đã chốt ca cũ (nếu có) và bắt đầu ca mới thành công!'
                ]);
            } else {
                throw new Exception("Lỗi mở ca mới: " . $stmt_new->error);
            }

        } catch (Exception $e) {
            $mysqli->rollback();
            echo json_encode(['success' => false, 'message' => $e->getMessage()]);
        }
    }

    // 3. Thoát ca (End Shift)
    elseif ($action === 'end_shift') {
        $input = json_decode(file_get_contents("php://input"), true);
        $end_cash = $input['end_cash'] ?? 0;
        $note = $input['note'] ?? '';

        // Tính tổng doanh thu trong phiên này (Query từ bảng orders)
        // Lấy session ID đang mở
        $stmt_get = $mysqli->prepare("SELECT id, start_time FROM work_sessions WHERE user_id = ? AND status = 'open'");
        $stmt_get->bind_param("i", $user_id);
        $stmt_get->execute();
        $session = $stmt_get->get_result()->fetch_assoc();

        // --- [SỬA ĐOẠN NÀY] ---
        if (!$session) {
            // Không tìm thấy ca mở -> Hủy session đăng nhập luôn -> Trả về success để JS chuyển hướng
            session_destroy(); 
            echo json_encode([
                'success' => true, 
                'message' => 'Đăng xuất thành công (Bạn chưa vào ca).'
            ]);
            exit; // Dừng code tại đây
        }
        // ----------------------

        $session_id = $session['id'];
        $start_time = $session['start_time'];

        // Tính doanh thu từ lúc start_time đến giờ
        $stmt_sales = $mysqli->prepare("SELECT SUM(total_price) as total FROM orders WHERE user_id = ? AND order_date >= ? AND status = 'paid'");
        $stmt_sales->bind_param("is", $user_id, $start_time);
        $stmt_sales->execute();
        $sales_data = $stmt_sales->get_result()->fetch_assoc();
        $total_sales = $sales_data['total'] ?? 0;

        // Update đóng ca
        $stmt_update = $mysqli->prepare("UPDATE work_sessions SET end_time = NOW(), end_cash = ?, total_sales = ?, note = ?, status = 'closed' WHERE id = ?");
        $stmt_update->bind_param("ddsi", $end_cash, $total_sales, $note, $session_id);
        
        if ($stmt_update->execute()) {
            // Logout luôn cho an toàn
            session_destroy();
            echo json_encode(['success' => true, 'message' => 'Đã chốt ca thành công! Doanh thu: ' . number_format($total_sales)]);
        } else {
            throw new Exception("Lỗi đóng ca.");
        }
    }

} catch (Exception $e) {
    echo json_encode(['success' => false, 'message' => $e->getMessage()]);
    require_once '../logout.php';
}
?>
---------------- END FILE ----------------

---------------- START FILE: core\warehouse_logic.php ----------------

---------------- END FILE ----------------

---------------- START FILE: includes\config.php ----------------
<?php

define('DB_HOST', 'localhost');
define('DB_USER', 'root');
define('DB_PASS', ''); 
define('DB_NAME', 'coffee');



// Ngăn truy cập trực tiếp qua URL
if (basename($_SERVER['PHP_SELF']) == basename(__FILE__)) {
    die('Truy cập trực tiếp bị từ chối.');
}
?>
---------------- END FILE ----------------

---------------- START FILE: includes\db_connection.php ----------------
<?php
    require_once 'config.php';
    global $mysqli;
    function connect_db(){
        global $mysqli;
        $mysqli = new mysqli(DB_HOST,DB_USER,DB_PASS,DB_NAME);
        if ($mysqli->connect_errno) {
            die("Kết nối cơ sở dữ liệu thất bại: " . $mysqli->connect_error);
        }
        $mysqli->set_charset("utf8mb4");
        return $mysqli;
    };
    connect_db();
    // Hàm kiểm tra xem User có đang trong ca làm việc không
function getActiveSessionId($conn, $user_id) {
    $stmt = $conn->prepare("SELECT id FROM work_sessions WHERE user_id = ? AND status = 'open' LIMIT 1");
    $stmt->bind_param("i", $user_id);
    $stmt->execute();
    $result = $stmt->get_result();
    
    if ($row = $result->fetch_assoc()) {
        return $row['id']; // Trả về ID phiên làm việc
    }
    return false; // Không có ca nào mở
}
?>
---------------- END FILE ----------------

---------------- START FILE: includes\index.php ----------------

---------------- END FILE ----------------

---------------- START FILE: pos\check_voucher.php ----------------
<?php
session_start();
require_once '../includes/db_connection.php'; // Đảm bảo đúng đường dẫn
header('Content-Type: application/json; charset=utf-8');

try {
    // 1. Kiểm tra đăng nhập
    if (!isset($_SESSION['user_id'])) {
        throw new Exception("Unauthorized");
    }

    // 2. Nhận dữ liệu JSON
    $input = json_decode(file_get_contents("php://input"), true);
    $code = isset($input['code']) ? strtoupper(trim($input['code'])) : '';

    if (empty($code)) {
        throw new Exception("Mã giảm giá trống.");
    }

    // 3. Query Database tìm voucher
    // Giả sử bảng vouchers có cột: id, code, discount_percent, description
    $stmt = $mysqli->prepare("SELECT code, discount_percent, description FROM vouchers WHERE code = ?");
    $stmt->bind_param("s", $code);
    $stmt->execute();
    $result = $stmt->get_result();
    $voucher = $result->fetch_assoc();

    if ($voucher) {
        echo json_encode([
            'success' => true,
            'code' => $voucher['code'],
            'percent' => (float)$voucher['discount_percent'],
            'message' => $voucher['description']
        ]);
    } else {
        echo json_encode([
            'success' => false,
            'message' => 'Mã giảm giá không tồn tại!'
        ]);
    }

} catch (Exception $e) {
    echo json_encode([
        'success' => false,
        'message' => $e->getMessage()
    ]);
}
?>
---------------- END FILE ----------------

---------------- START FILE: pos\customer_view.php ----------------
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Màn hình Khách hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; height: 100vh; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* CỘT TRÁI: Trạng thái (Welcome/QR) */
        .left-panel { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; border-right: 1px solid #ddd; background: white; transition: all 0.3s; }
        
        .welcome-screen img { width: 180px; margin-bottom: 20px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .welcome-title { font-weight: 800; color: #2c3e50; text-transform: uppercase; letter-spacing: 2px; }
        
        .payment-screen { display: none; text-align: center; width: 100%; }
        .qr-img { max-width: 350px; width: 100%; border-radius: 15px; border: 2px solid #eee; }
        
        .success-screen { display: none; text-align: center; }
        .success-icon { font-size: 8rem; color: #198754; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* CỘT PHẢI: Giỏ hàng */
        .right-panel { height: 100vh; display: flex; flex-direction: column; background-color: #fff; }
        .cart-header { padding: 20px; background: #2c3e50; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .cart-body { flex: 1; overflow-y: auto; padding: 0; }
        .cart-item { border-bottom: 1px dashed #eee; padding: 15px 20px; display: flex; align-items: center; }
        .item-img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; margin-right: 15px; }
        .item-info { flex: 1; }
        .item-name { font-weight: 600; font-size: 1.1rem; color: #333; margin-bottom: 2px; }
        .item-meta { font-size: 0.95rem; color: #666; }
        .item-total { font-weight: bold; color: #2c3e50; font-size: 1.1rem; }
        
        .cart-footer { padding: 20px; background: #f8f9fa; border-top: 2px solid #e9ecef; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1.1rem; }
        .total-row { font-size: 1.8rem; font-weight: 800; color: #d63384; margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px; }

        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="row g-0 h-100">
    <div class="col-md-7 left-panel">
        
        <div id="screen-welcome" class="welcome-screen text-center">
            <img src="../admin/assets/dist/img/logo coffee.png" alt="Logo">
            <h1 class="welcome-title display-5">Nguyễn Văn Coffee</h1>
            <p class="fs-4 text-muted mt-2">Xin chào quý khách!</p>
            <div class="mt-4">
                <span class="badge bg-light text-dark border p-2">Wifi: nguyenvan_coffee / Pass: 12345678</span>
            </div>
        </div>

        <div id="screen-payment" class="payment-screen">
            <h3 class="text-primary fw-bold mb-3"><i class="fa-solid fa-qrcode"></i> QUÉT MÃ THANH TOÁN</h3>
            <img id="customer-qr" src="" class="qr-img shadow-sm">
            <div class="mt-3">
                <div class="fs-5 text-muted">Số tiền cần thanh toán:</div>
                <div id="qr-total-display" class="display-4 fw-bold text-danger">0 đ</div>
            </div>
        </div>

        <div id="screen-success" class="success-screen">
            <div class="success-icon mb-3"><i class="fa-solid fa-circle-check"></i></div>
            <h2 class="fw-bold">Thanh toán thành công!</h2>
            <p class="fs-4 text-muted">Cảm ơn và hẹn gặp lại.</p>
        </div>
    </div>

    <div class="col-md-5 right-panel shadow-lg">
        <div class="cart-header">
            <i class="fa-solid fa-receipt me-2"></i> Thông tin đơn hàng
        </div>
        
        <div id="cart-container" class="cart-body">
            <div class="text-center text-muted mt-5 pt-5">
                <i class="fa-solid fa-basket-shopping fa-3x mb-3 opacity-25"></i>
                <p>Chưa có món nào được chọn</p>
            </div>
        </div>

        <div class="cart-footer">
            <div class="summary-row">
                <span class="text-muted">Tạm tính:</span>
                <span class="fw-bold" id="bill-subtotal">0 đ</span>
            </div>
            <div class="summary-row text-success">
                <span><i class="fa-solid fa-ticket me-1"></i> Giảm giá:</span>
                <span class="fw-bold" id="bill-discount">-0 đ</span>
            </div>
            <div class="summary-row total-row">
                <span>TỔNG CỘNG:</span>
                <span id="bill-total">0 đ</span>
            </div>
        </div>
    </div>
</div>

<script>
    const channel = new BroadcastChannel('pos_customer_display');

    // UI Elements
    const views = {
        welcome: document.getElementById('screen-welcome'),
        payment: document.getElementById('screen-payment'),
        success: document.getElementById('screen-success')
    };
    const qrImg = document.getElementById('customer-qr');
    const qrTotal = document.getElementById('qr-total-display');
    
    // Cart Elements
    const cartContainer = document.getElementById('cart-container');
    const elSubtotal = document.getElementById('bill-subtotal');
    const elDiscount = document.getElementById('bill-discount');
    const elTotal = document.getElementById('bill-total');

    function switchView(viewName) {
        Object.values(views).forEach(el => el.style.display = 'none');
        if (views[viewName]) views[viewName].style.display = 'block';
    }

    // Lắng nghe tín hiệu từ POS
    channel.onmessage = (event) => {
        const data = event.data;

        // 1. Cập nhật Giỏ hàng (Real-time)
        if (data.type === 'UPDATE_CART') {
            renderCart(data.items, data.subtotal, data.discount_amt, data.total);
            
            // Nếu đang ở màn hình QR mà giỏ hàng thay đổi -> Quay về Welcome để tránh QR sai tiền
            if (views.payment.style.display === 'block') {
                switchView('welcome');
            }
        }
        
        // 2. Hiện QR Code
        else if (data.type === 'SHOW_QR') {
            switchView('payment');
            qrImg.src = data.url;
            qrTotal.textContent = parseInt(data.amount).toLocaleString('vi-VN') + ' đ';
        } 
        
        // 3. Thanh toán thành công
        else if (data.type === 'SUCCESS') {
            switchView('success');
            setTimeout(() => {
                switchView('welcome');
                // Xóa giỏ hàng hiển thị
                renderCart([], 0, 0, 0); 
            }, 5000);
        }
        
        // 4. Reset
        else if (data.type === 'RESET') {
            switchView('welcome');
        }
    };

    function renderCart(items, subtotal, discountAmt, total) {
        // Cập nhật số tiền
        elSubtotal.textContent = subtotal.toLocaleString('vi-VN') + ' đ';
        elDiscount.textContent = '-' + discountAmt.toLocaleString('vi-VN') + ' đ';
        elTotal.textContent = total.toLocaleString('vi-VN') + ' đ';

        // Render danh sách món
        cartContainer.innerHTML = '';
        
        if (!items || items.length === 0) {
            cartContainer.innerHTML = `
                <div class="text-center text-muted mt-5 pt-5">
                    <i class="fa-solid fa-basket-shopping fa-3x mb-3 opacity-25"></i>
                    <p>Mời quý khách gọi món</p>
                </div>`;
            return;
        }

        items.forEach(item => {
            const itemTotal = item.price * item.quantity;
            const html = `
                <div class="cart-item">
                    <img src="${item.img}" class="item-img" onerror="this.src='https://placehold.co/60'">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-meta">
                            ${item.quantity} x ${parseInt(item.price).toLocaleString('vi-VN')}
                        </div>
                    </div>
                    <div class="item-total">
                        ${itemTotal.toLocaleString('vi-VN')} đ
                    </div>
                </div>
            `;
            cartContainer.insertAdjacentHTML('beforeend', html);
        });
    }
</script>
</body>
</html>
---------------- END FILE ----------------

---------------- START FILE: pos\get_order_details.php ----------------
<?php
// pos/get_order_details.php
require_once '../includes/db_connection.php';

// Kiểm tra xem có ID được gửi lên không
if (isset($_GET['id'])) {
    $order_id = intval($_GET['id']);

    // SQL UPDATE: Lấy giá (price) từ bảng products (p) thay vì order_items (oi)
    $sql = "SELECT 
                oi.quantity, 
                p.name, 
                p.price, 
                p.image_url 
            FROM order_items oi 
            JOIN products p ON oi.product_id = p.id 
            WHERE oi.order_id = ?";

    $stmt = $mysqli->prepare($sql);
    
    if ($stmt) {
        $stmt->bind_param("i", $order_id);
        $stmt->execute();
        $result = $stmt->get_result();

        $items = [];
        while ($row = $result->fetch_assoc()) {
            $items[] = $row;
        }

        // Trả về JSON
        header('Content-Type: application/json');
        echo json_encode($items);
        
        $stmt->close();
    } else {
        // Trả về lỗi nếu SQL sai
        http_response_code(500);
        echo json_encode(['error' => 'Lỗi truy vấn Database']);
    }
} else {
    echo json_encode([]);
}
?>
---------------- END FILE ----------------

---------------- START FILE: pos\history.php ----------------
<?php
session_start();
require_once '../includes/db_connection.php';
global $mysqli;

if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit;
}

$user_id = $_SESSION['user_id'];
$fullname = $_SESSION['fullname'];

// Xử lý bộ lọc ngày (nếu khách muốn xem theo ngày cụ thể)
$filter_date = isset($_GET['date']) ? $_GET['date'] : '';
$where_clause = "WHERE user_id = $user_id";
if ($filter_date) {
    $where_clause .= " AND DATE(order_date) = '$filter_date'";
}

// Truy vấn danh sách đơn hàng
$query = "SELECT * FROM orders $where_clause ORDER BY order_date DESC";
$result = $mysqli->query($query);
?>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Lịch sử đơn hàng cá nhân</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f1ea; }
        .table-container { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="fa-solid fa-clock-rotate-left me-2"></i>Lịch sử đơn hàng của bạn</h4>
        <a href="index.php" class="btn btn-secondary btn-sm"><i class="fa-solid fa-arrow-left"></i> Quay lại</a>
    </div>

    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <form class="row g-3" method="GET">
                <div class="col-auto">
                    <label class="form-label">Xem theo ngày:</label>
                    <input type="date" name="date" class="form-control form-control-sm" value="<?= $filter_date ?>">
                </div>
                <div class="col-auto d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-sm me-2">Lọc</button>
                    <a href="history.php" class="btn btn-outline-secondary btn-sm">Tất cả</a>
                </div>
            </form>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Mã đơn</th>
                    <th>Ngày giờ</th>
                    <th>Tổng tiền</th>
                    <th>Trạng thái</th>
                    <th>Chi tiết</th>
                </tr>
            </thead>
            <tbody>
                <?php if ($result->num_rows > 0): ?>
                    <?php while($row = $result->fetch_assoc()): ?>
                    <tr>
                        <td>#<?= $row['id'] ?></td>
                        <td><?= date('d/m/Y H:i', strtotime($row['order_date'])) ?></td>
                        <td class="fw-bold"><?= number_format($row['total_price']) ?>đ</td>
                        <td>
                            <?php
                            switch ($row['status']) {
                                case 'not_paid':
                                    echo '<span class="badge bg-warning text-dark">Chờ xử lý</span>';
                                    break;
                                case 'paid':
                                    echo '<span class="badge bg-success">Hoàn thành</span>';
                                    break;
                                case 'canceled':
                                    echo '<span class="badge bg-danger">Đã hủy</span>';
                                    break;
                                default:
                                    echo '<span class="badge bg-secondary">Không xác định</span>';
                            }
                            ?>
                        <td>
                            <td class="text-center">
    <button class="btn btn-sm btn-outline-primary btn-view-detail" 
            data-id="<?= $row['id'] ?>">
        <i class="fa-solid fa-eye"></i> Xem món
    </button>
</td>
                        </td>
                    </tr>
                    <?php endwhile; ?>
                <?php else: ?>
                    <tr><td colspan="5" class="text-center text-muted">Bạn chưa có đơn hàng nào trong ngày này.</td></tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Chi tiết đơn hàng #<span id="modal-order-id"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-striped mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-3">Món</th>
                            <th class="text-center">SL</th>
                            <th class="text-end pe-3">Giá</th>
                        </tr>
                    </thead>
                    <tbody id="modal-items-body">
                        </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<script src="js/bootstrap.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const detailModal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
    const modalBody = document.getElementById('modal-items-body');
    const modalOrderId = document.getElementById('modal-order-id');

    // Bắt sự kiện click vào các nút "Xem món"
    document.querySelectorAll('.btn-view-detail').forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.getAttribute('data-id');
            
            // 1. Cập nhật tiêu đề modal
            modalOrderId.textContent = orderId;
            
            // 2. Hiển thị loading trong lúc chờ
            modalBody.innerHTML = '<tr><td colspan="3" class="text-center py-3"><i class="fa-solid fa-spinner fa-spin"></i> Đang tải...</td></tr>';
            detailModal.show();

            // 3. Gọi AJAX lấy dữ liệu
            fetch('get_order_details.php?id=' + orderId)
                .then(response => response.json())
                .then(data => {
                    modalBody.innerHTML = ''; // Xóa loading

                    if (data.length > 0) {
                        let total = 0;
                        data.forEach(item => {
                            // Xử lý ảnh (nếu ko có ảnh thì dùng ảnh placeholder)
                            let imgPath = item.image_url ? item.image_url : 'https://placehold.co/50';
                            
                            // Tính tổng dòng
                            let lineTotal = item.quantity * item.price;
                            total += lineTotal;

                            let row = `
                                <tr>
                                    <td class="ps-3 align-middle">
                                        <div class="d-flex align-items-center">
                                            <img src="${imgPath}" class="rounded me-2" width="40" height="40" style="object-fit:cover;">
                                            <span class="fw-bold text-dark">${item.name}</span>
                                        </div>
                                    </td>
                                    <td class="text-center align-middle fw-bold">${item.quantity}</td>
                                    <td class="text-end pe-3 align-middle">
                                        ${parseInt(item.price).toLocaleString('vi-VN')} đ
                                    </td>
                                </tr>
                            `;
                            modalBody.innerHTML += row;
                        });
                        
                        // Thêm dòng tổng tiền vào cuối (tùy chọn)
                        modalBody.innerHTML += `
                            <tr class="table-primary border-top border-dark">
                                <td colspan="2" class="text-end fw-bold pt-3">TỔNG CỘNG:</td>
                                <td class="text-end fw-bold text-danger pe-3 pt-3 fs-5">${total.toLocaleString('vi-VN')} đ</td>
                            </tr>
                        `;

                    } else {
                        modalBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Không tìm thấy chi tiết món.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Lỗi:', error);
                    modalBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger py-3">Lỗi tải dữ liệu!</td></tr>';
                });
        });
    });
});
</script>
</body>
</html>
---------------- END FILE ----------------

---------------- START FILE: pos\index.php ----------------
<?php
session_start();
require_once '../includes/db_connection.php';
global $mysqli;

// Bảo vệ trang: Chỉ nhân viên hoặc admin đã đăng nhập mới vào được
if (!isset($_SESSION['user_id'])|| ($_SESSION['role'] !== 'staff' && $_SESSION['role'] !== 'admin')) {
    header("Location: ../login.php");
    exit;
}

$user_id = $_SESSION['user_id'];
$fullname = $_SESSION['fullname'];

// 1. Thống kê nhanh trong ngày của nhân viên này
$today = date('Y-m-d');
$stats_query = "SELECT COUNT(id) as total_orders, SUM(total_price) as total_revenue 
                FROM orders 
                WHERE user_id = $user_id AND DATE(order_date) = '$today' AND status = 'paid'";
$stats_result = $mysqli->query($stats_query);
$stats = $stats_result->fetch_assoc();

// 2. Lấy danh sách nguyên liệu sắp hết để cảnh báo nhân viên
$low_stock_query = "SELECT name, quantity, unit FROM ingredients WHERE quantity <= min_quantity LIMIT 5";
$low_stock_result = $mysqli->query($low_stock_query);
?>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhân viên bán hàng | Coffee Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --coffee-dark: #6f4e37; --coffee-light: #f4f1ea; }
        body { background-color: var(--coffee-light); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar-user { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-card { border: none; border-radius: 15 shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .btn-main { background: var(--coffee-dark); color: white; border-radius: 10px; padding: 15px; font-weight: bold; border: none; width: 100%; transition: 0.3s; text-decoration: none; display: block; text-align: center; }
        .btn-main:hover { background: #5a3e2b; color: white; box-shadow: 0 5px 15px rgba(111, 78, 55, 0.3); }
        .alert-stock { border-left: 5px solid #ffc107; background: white; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-brown"><i class="fa-solid fa-mug-hot me-2"></i> STAFF DASHBOARD</h3>
        <a href="../index.php" class="btn btn-outline-secondary"><i class="fa-solid fa-arrow-left me-2"></i>Quay lại</a>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="sidebar-user mb-4 text-center">
                <img src="https://ui-avatars.com/api/?name=<?= urlencode($fullname) ?>&background=6f4e37&color=fff" class="rounded-circle mb-3" width="80">
                <h5 class="fw-bold"><?= $fullname ?></h5>
                <span class="badge bg-success mb-3">Đang trong ca làm việc</span>
                <hr>
                <div class="row text-start mt-3">
                    <div class="col-6 border-end">
                        <small class="text-muted d-block">Đơn hôm nay</small>
                        <span class="fw-bold fs-5"><?= $stats['total_orders'] ?? 0 ?></span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">Doanh thu cá nhân</small>
                        <span class="fw-bold fs-5 text-success"><?= number_format($stats['total_revenue'] ?? 0) ?>đ</span>
                    </div>
                </div>
            </div>

            <h6 class="fw-bold mb-3"><i class="fa-solid fa-triangle-exclamation text-warning me-2"></i>CẢNH BÁO KHO</h6>
            <?php if ($low_stock_result->num_rows > 0): ?>
                <?php while($item = $low_stock_result->fetch_assoc()): ?>
                    <div class="alert alert-stock p-2 mb-2 shadow-sm">
                        <small class="d-block fw-bold"><?= $item['name'] ?></small>
                        <small class="text-danger">Còn lại: <?= $item['quantity'] ?> <?= $item['unit'] ?></small>
                    </div>
                <?php endwhile; ?>
            <?php else: ?>
                <p class="text-muted small">Nguyên liệu đầy đủ.</p>
            <?php endif; ?>
        </div>

        <div class="col-lg-8">
            <div class="row g-3">
                <div class="col-md-12">
                    <a href="menu.php" class="btn-main fs-4 shadow-sm">
                        <i class="fa-solid fa-cart-plus me-2"></i> BẮT ĐẦU BÁN HÀNG MỚI
                    </a>
                </div>

                <div class="col-md-12">
                    <div class="card stat-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold mb-0">Đơn hàng gần đây của bạn</h5>
<a href="history.php" class="btn btn-sm btn-link text-decoration-none">Xem tất cả</a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Mã đơn</th>
                                        <th>Thời gian</th>
                                        <th>Tổng tiền</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php
$recent_orders = $mysqli->query("SELECT id, order_date, total_price, status 
                                FROM orders WHERE user_id = $user_id 
                                ORDER BY order_date DESC LIMIT 5");
while($row = $recent_orders->fetch_assoc()):
?>
<tr>
    <td>#<?= $row['id'] ?></td>
    <td><?= date('H:i', strtotime($row['order_date'])) ?></td>
    <td class="fw-bold"><?= number_format($row['total_price']) ?>đ</td>
    <td>
        <?php if ($row['status'] == 'paid'): ?>
<span class="badge bg-success">Đã trả</span>
        <?php elseif ($row['status'] == 'canceled'): ?>
<span class="badge bg-danger">Đã hủy</span>
        <?php else: ?>
<span class="badge bg-warning text-dark">Đang xử lý</span>
        <?php endif; ?>
    </td>
</tr>
<?php endwhile; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
---------------- END FILE ----------------

---------------- START FILE: pos\menu.php ----------------
<?php
session_start();
require_once '../includes/db_connection.php';
global $mysqli;

// --- [THÊM MỚI: HÀM XỬ LÝ ĐƯỜNG DẪN ẢNH THÔNG MINH] ---
function getProductImage($dbPath) {
    // 1. Nếu không có dữ liệu -> Trả về ảnh rỗng
    if (empty($dbPath)) {
        return 'https://placehold.co/150x150?text=No+Img';
    }

    // 2. Nếu là link online (http) -> Giữ nguyên
    if (strpos($dbPath, 'http') === 0) {
        return $dbPath;
    }

    // 3. Chuẩn hóa đường dẫn (Xóa ../ hoặc / ở đầu để xử lý thống nhất)
    $cleanPath = ltrim($dbPath, './'); 
    // Lúc này $cleanPath sẽ sạch, ví dụ: "assets/img/drink/cafe.jpg"

    // 4. Kiểm tra nguồn ảnh và tạo đường dẫn tương đối từ thư mục /pos/
    
    // Trường hợp A: Ảnh nằm trong thư mục uploads của Admin (Admin mới)
    if (strpos($cleanPath, 'uploads/') === 0) {
        // Nếu DB lưu "uploads/abc.jpg" -> POS gọi "../admin/uploads/abc.jpg"
        return '../admin/' . $cleanPath;
    }
    
    // Trường hợp B: Ảnh nằm trong thư mục assets (Code cũ của Nam)
    if (strpos($cleanPath, 'assets/') === 0) {
        // Nếu DB lưu "assets/img/..." -> POS gọi "../assets/img/..."
        return '../' . $cleanPath;
    }

    // Trường hợp C: Admin chỉ lưu tên file (Ví dụ: "cafe.jpg") -> Mặc định tìm trong assets/img/drink hoặc food?
    // Để an toàn, trỏ vào uploads của admin
    return '../admin/uploads/' . $cleanPath;
}
// -----------------------------------------------------------

// 1. Bảo vệ trang
if (!isset($_SESSION['user_id'])|| ($_SESSION['role'] !== 'staff' && $_SESSION['role'] !== 'admin')) {
    header("Location: ../login.php");
    exit;
}
// ... (Phần code còn lại giữ nguyên) ...

// 2. Lấy danh mục
$categories = $mysqli->query("SELECT * FROM categories");

// 3. Lấy sản phẩm (Lọc is_active = 1 để chỉ hiện món đang bán)
$products = $mysqli->query("SELECT * FROM products WHERE is_active = 1 ORDER BY category_id ASC");
$next_order_id = 1; // Mặc định là 1 nếu chưa có đơn nào
$query_max_id = "SELECT MAX(id) as max_id FROM orders";
$result_max_id = $mysqli->query($query_max_id);

if ($result_max_id && $row_max = $result_max_id->fetch_assoc()) {
    $next_order_id = $row_max['max_id'] + 1;
}
?>

<?php
// ... (Các phần session và kết nối DB giữ nguyên) ...

// 1. Lấy Tồn kho Nguyên liệu (Gửi cho JS)
$ingredients_data = [];
$ing_result = $mysqli->query("SELECT id, quantity FROM ingredients");
while ($row = $ing_result->fetch_assoc()) {
    // Lưu dạng: { "1": 5000, "2": 200 } (ID => Số lượng)
    $ingredients_data[$row['id']] = (float)$row['quantity']; 
}

// 2. Lấy Công thức (Recipes) (Gửi cho JS)
$recipes_data = [];
$recipe_result = $mysqli->query("SELECT product_id, ingredient_id, quantity_required FROM recipes");
while ($row = $recipe_result->fetch_assoc()) {
    $pid = $row['product_id'];
    if (!isset($recipes_data[$pid])) {
        $recipes_data[$pid] = [];
    }
    // Lưu dạng: ProductID => [ {ing_id: 1, qty: 20}, ... ]
    $recipes_data[$pid][] = [
        'id' => $row['ingredient_id'],
        'qty' => (float)$row['quantity_required']
    ];
}
?>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Menu | Coffee Shop</title>
    <script>
    // Truyền dữ liệu từ PHP sang JS
    let SERVER_INGREDIENTS = <?php echo json_encode($ingredients_data); ?>;
    const SERVER_RECIPES = <?php echo json_encode($recipes_data); ?>;
</script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="css/pos_style.css">

    <style>
        :root { --primary-color: #6f4e37; --bg-color: #f8f9fa; --sidebar-width: 350px; }
        body { background-color: var(--bg-color); height: 100vh; overflow: hidden; font-family: 'Segoe UI', sans-serif; }

        /* Navbar */
        .pos-navbar { height: 60px; background: white; border-bottom: 1px solid #ddd; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
        .back-btn { text-decoration: none; color: var(--primary-color); font-weight: bold; transition: 0.3s; }
        .back-btn:hover { color: #4a332a; transform: translateX(-5px); }

        /* Layout chính */
        .pos-container { display: flex; height: calc(100vh - 60px); }
        
        /* Cột TRÁI: Menu */
        .menu-area { flex: 1; padding: 20px; overflow-y: auto; overflow-x: hidden; }
        
        /* Thanh tìm kiếm & Filter */
        .filter-bar { background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .category-scroll::-webkit-scrollbar { height: 4px; }
        .category-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        
        /* Nút filter (Custom lại class filter-btn của bạn) */
        .filter-btn { white-space: nowrap; border-radius: 20px; padding: 8px 20px; border: 1px solid #ddd; background: white; color: #333; transition: 0.2s; }
        .filter-btn:hover { background: #eee; }
        .filter-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        /* Card sản phẩm */
        .product-card-wrapper { transition: 0.3s; }
        .product-item { 
            border: none; border-radius: 15px; overflow: hidden; background: white; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; height: 100%;
        }
        .product-item:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); border: 1px solid var(--primary-color); }
        .card-img-top { height: 140px; object-fit: cover; }
        .card-title { font-size: 0.95rem; font-weight: bold; margin-bottom: 5px; color: #333; }
        .price-tag { color: var(--primary-color); font-weight: 800; font-size: 1.1rem; }
        
        /* Xử lý món hết hàng */
        .product-item.disabled { opacity: 0.6; pointer-events: none; filter: grayscale(1); }
        .badge-stock { position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.75rem; font-weight: bold; }

        /* Cột PHẢI: Giỏ hàng (Fixed) */
        .cart-sidebar { width: var(--sidebar-width); background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; height: 100%; box-shadow: -5px 0 15px rgba(0,0,0,0.05); }
        .cart-header { padding: 15px; background: var(--primary-color); color: white; text-align: center; }
        .cart-items-container { flex: 1; overflow-y: auto; padding: 0; }
        .cart-footer { padding: 20px; background: #f8f9fa; border-top: 1px dashed #ccc; }
        
        /* Tùy chỉnh List Group Item trong giỏ hàng (Override Bootstrap) */
        .list-group-item { border: none; border-bottom: 1px solid #eee; padding: 15px; }
        .btn-qty { width: 28px; height: 28px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

    <header class="pos-navbar">
        <a href="index.php" class="back-btn"><i class="fa-solid fa-arrow-left me-2"></i>Dashboard</a>
        <h5 class="m-0 fw-bold text-uppercase">Bán Hàng</h5>
        <div class="user-info">
            <span class="text-muted small">Thu ngân:</span> 
            <strong><?= htmlspecialchars($_SESSION['fullname']) ?></strong>
            <button class="btn btn-outline-primary btn-sm ms-2" onclick="openCustomerScreen()">
    <i class="fa-solid fa-desktop"></i> Màn hình khách
</button>
            <button class="btn btn-outline-danger btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#modalEndShift">
    <i class="fa-solid fa-right-from-bracket"></i> Thoát ca
</button>
        </div>
        
    </header>

    <div class="pos-container">
        
        <div class="menu-area">
            <div class="filter-bar">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-search text-muted"></i></span>
                            <input type="text" id="search-input" class="form-control border-start-0 ps-0" placeholder="Tìm tên món...">
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="category-scroll">
                            <button class="filter-btn active" data-filter="all">Tất cả</button>
                            <?php while($cat = $categories->fetch_assoc()): ?>
                                <button class="filter-btn" data-filter="<?= $cat['id'] ?>"><?= $cat['name'] ?></button>
                            <?php endwhile; ?>
                        </div>
                    </div>
                </div>
            </div>

            <div id="product-list-container" class="row g-3">
                <?php while($row = $products->fetch_assoc()): ?>
                    <?php 
                        // Logic ẩn hiện món hết hàng
                        $is_out_of_stock = ($row['status'] == 0);
                        $class_disabled = $is_out_of_stock ? 'disabled' : '';
                    ?>
                    <div class="col-6 col-md-3 col-lg-2 product-column product-card-wrapper mb-3">
                        <div class="card product-item text-center p-2 h-100 <?= $class_disabled ?>"
     data-id="<?= $row['id'] ?>" 
     data-price="<?= $row['price'] ?>"
     data-category-id="<?= $row['category_id'] ?>">
     
    <div class="stock-remaining" id="stock-<?= $row['id'] ?>">
        Còn: <span class="qty-val">--</span>
    </div>
    <?php if($is_out_of_stock): ?>
        <div class="badge-stock">Tạm hết</div>
    <?php endif; ?>
    
    <img src="<?= getProductImage($row['image_url']) ?>" 
     class="card-img-top rounded-3 mb-2" 
     alt="<?= htmlspecialchars($row['name']) ?>"
     onerror="this.src='https://placehold.co/150x150?text=Anh+Loi'">
    
    <div class="card-body p-1 d-flex flex-column justify-content-between">
        <h6 class="card-title text-truncate" title="<?= htmlspecialchars($row['name']) ?>">
            <?= $row['name'] ?>
        </h6>
        <div class="price-tag"><?= number_format($row['price']) ?></div>
    </div>
</div>
                    </div>
                <?php endwhile; ?>
            </div>
        </div>

        <div class="cart-sidebar">
            <div class="cart-header">
                <h5 class="mb-0">Hóa Đơn</h5>
            </div>
            
            <ul id="cart-list" class="list-group list-group-flush cart-items-container">
                </ul>

            <div class="cart-footer">
                <div class="input-group mb-3">
    <span class="input-group-text"><i class="fa-solid fa-ticket"></i></span>
    <input type="text" id="voucher-code" class="form-control" placeholder="Mã giảm giá (Nếu có)">
    <button class="btn btn-outline-secondary" type="button" onclick="checkVoucher()">Áp dụng</button>
</div>

<div class="d-flex justify-content-between mb-2">
    <span>Giảm giá:</span>
    <span class="text-danger fw-bold" id="discount-display">0%</span>
</div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted fw-bold">Tổng tiền:</span>
                    <span id="total-amount" class="fs-3 fw-bold text-danger">0 đ</span>
                </div>
                
                <div class="d-grid gap-2">
                    
                    <button id="checkout-btn" class="btn btn-success btn-lg fw-bold">
                        <i class="fa-regular fa-credit-card me-2"></i> THANH TOÁN
                    </button>
                    <button id="cancel-btn" class="btn btn-outline-danger">
                        <i class="fa-solid fa-trash me-2"></i> Hủy đơn
                    </button>
                </div>
                <div class="text-center mt-2 small text-muted">
                    Order ID: <span class="text-warning">#<span id="order-id" class="text-warning"><?= $next_order_id ?></span></span>
                </div>
            </div>
        </div>

    </div>

<div id="invoice-pos" class="d-none">
    <div class="invoice-content">
        <div class="invoice-header text-center mb-2">
            <h4 class="store-name fw-bold text-uppercase mb-1">NGUYỄN VĂN COFFEE</h4>
            <p class="store-info mb-0 small">ĐC: 36 Văn Cao, Hải Phòng</p>
            <p class="store-info mb-1 small">Hotline: 090.123.4567</p>
            <div class="dashed-line my-2"></div>
            <h5 class="invoice-title fw-bold">PHIẾU THANH TOÁN</h5>
        </div>

        <div class="invoice-meta small mb-2">
            <div class="d-flex justify-content-between">
                <span>Số phiếu:</span>
                <span class="fw-bold">#<span id="print-order-id">000</span></span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Thời gian:</span>
                <span id="print-date">--/--/----</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Thu ngân:</span>
                <span id="print-staff"><?= $_SESSION['fullname'] ?></span>
            </div>
        </div>

        <div class="dashed-line my-2"></div>

        <table class="table table-borderless table-sm mb-2 w-100 receipt-table small">
            <thead>
                <tr class="text-uppercase border-bottom border-dark">
                    <th class="text-start" style="width: 40%">Món</th>
                    <th class="text-center" style="width: 15%">SL</th>
                    <th class="text-end" style="width: 20%">Đ.Giá</th>
                    <th class="text-end" style="width: 25%">T.Tiền</th>
                </tr>
            </thead>
            <tbody id="print-items-body">
                </tbody>
        </table>

        <div class="dashed-line my-2"></div>

        <div class="invoice-footer">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="fw-bold fs-6">TỔNG CỘNG:</span>
                <span class="total-amount fw-bold fs-5" id="print-total">0 đ</span>
            </div>
            
            <div class="dashed-line my-3"></div>
            
            <div class="thank-you text-center small fst-italic">
                <p class="mb-1">Cảm ơn quý khách & Hẹn gặp lại!</p>
                <p class="mb-0 fw-bold">Wifi: nguyenvan_coffee / Pass: 12345678</p>
            </div>
        </div>
    </div>
</div>
<div id="sticker-container" class="d-none">
    </div>

<div class="modal fade" id="modalStartShift" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fa-solid fa-clock"></i> BẮT ĐẦU CA LÀM VIỆC</h5>
            </div>
            <div class="modal-body">
                <p>Chào <strong><?= $_SESSION['fullname'] ?></strong>! Vui lòng kiểm đếm tiền trong két (tiền lẻ/tiền mặt có sẵn) để bắt đầu.</p>
                <div class="mb-3">
                    <label class="form-label fw-bold">Tiền đầu ca (VNĐ):</label>
                    <input type="number" id="start-cash-input" class="form-control form-control-lg" value="0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="startShift()">Xác nhận & Mở bán</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEndShift" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fa-solid fa-door-closed"></i> KẾT THÚC CA & ĐĂNG XUẤT</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    Sau khi kết thúc, hệ thống sẽ tự động đăng xuất.
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Tổng tiền mặt thực tế trong két:</label>
                    <input type="number" id="end-cash-input" class="form-control form-control-lg" placeholder="Nhập số tiền đếm được...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Ghi chú (nếu lệch tiền):</label>
                    <textarea id="end-note-input" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" onclick="endShift()">Chốt ca</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalPayment" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fa-solid fa-cash-register"></i> THANH TOÁN ĐƠN HÀNG</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0 h-100">
                    <div class="col-md-4 bg-light border-end">
                        <div class="list-group list-group-flush pt-3" id="payment-methods" role="tablist">
                            <a class="list-group-item list-group-item-action active py-3" id="method-cash" data-bs-toggle="list" href="#tab-cash" role="tab" onclick="setPaymentMethod('cash')">
                                <i class="fa-solid fa-money-bill-1 me-2 text-success"></i> Tiền mặt (Cash)
                            </a>
                            <a class="list-group-item list-group-item-action py-3" id="method-transfer" data-bs-toggle="list" href="#tab-transfer" role="tab" onclick="setPaymentMethod('transfer')">
                                <i class="fa-solid fa-qrcode me-2 text-primary" style="color: #000;"></i> Chuyển khoản (QR)
                            </a>
                        </div>
                        <div class="p-3 mt-auto text-center">
                            <small class="text-muted fw-bold">TỔNG THANH TOÁN</small>
                            <div class="display-6 fw-bold text-danger" id="pay-total-display">0 đ</div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="tab-content p-4 h-100">
                            
                            <div class="tab-pane fade show active" id="tab-cash" role="tabpanel">
                                <label class="form-label fw-bold">Khách đưa:</label>
                                <div class="input-group mb-3">
                                    <input type="text" id="customer-pay-input" class="form-control form-control-lg fw-bold fs-3 text-primary" placeholder="0">
                                    <span class="input-group-text">đ</span>
                                </div>
                                
                                <div class="d-flex gap-2 flex-wrap mb-4">
                                    <button class="btn btn-outline-secondary btn-sm quick-pay" data-value="50000">50k</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-pay" data-value="100000">100k</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-pay" data-value="200000">200k</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-pay" data-value="500000">500k</button>
                                    <button class="btn btn-outline-primary btn-sm" id="btn-pay-exact">Đủ tiền</button>
                                </div>

                                <div class="alert alert-light border text-center">
                                    <span>Tiền thối lại:</span>
                                    <div class="fw-bold fs-1 text-success" id="change-due-display">0 đ</div>
                                </div>
                            </div>

                            <div class="tab-pane fade text-center" id="tab-transfer" role="tabpanel">
                                <div id="qr-loading" class="d-none text-muted my-5">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">Đang tạo mã QR...</p>
                                </div>
                                <img id="vietqr-image" src="" class="img-fluid border rounded shadow-sm mb-2" style="max-height: 250px; display:none;">
                                <div class="mt-2">
                                    <p class="mb-1 fw-bold text-primary" id="bank-info-text"></p>
                                    <small class="text-muted fst-italic">Vui lòng kiểm tra điện thoại khi nhận được tiền</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-white">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success btn-lg px-5 fw-bold" id="btn-confirm-payment">
                    <i class="fa-solid fa-print"></i> XÁC NHẬN & IN
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="customAlertModal" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header text-white" id="alert-header">
                <h5 class="modal-title" id="alert-title">Thông báo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i id="alert-icon" class="fa-solid fa-circle-info fa-3x mb-3 text-primary"></i>
                <p id="alert-message" class="fw-bold mb-0">Nội dung thông báo...</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary w-50" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customConfirmModal" tabindex="-1" data-bs-backdrop="static" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fa-solid fa-circle-question"></i> XÁC NHẬN</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body fs-6" id="confirm-message">
                Bạn có chắc chắn muốn thực hiện hành động này?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                <button type="button" class="btn btn-warning fw-bold px-4" id="btn-confirm-yes">Đồng ý</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customPromptModal" tabindex="-1" data-bs-backdrop="static" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fa-solid fa-user-shield"></i> ADMIN INPUT</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="prompt-message" class="mb-2">Nhập giá trị:</p>
                <input type="text" id="prompt-input" class="form-control form-control-lg text-center fw-bold" autofocus>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary px-4" id="btn-prompt-submit">Xác nhận</button>
            </div>
        </div>
    </div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="js/pos_main.js"></script>
        
</body>
</html>
---------------- END FILE ----------------

---------------- START FILE: pos\css\index.php ----------------

---------------- END FILE ----------------

---------------- START FILE: pos\js\index.php ----------------

---------------- END FILE ----------------

---------------- START FILE: warehouse\add_ingredient.php ----------------

---------------- END FILE ----------------

---------------- START FILE: warehouse\get_history_api.php ----------------
<?php
session_start();
require_once '../includes/db_connection.php';
header('Content-Type: application/json; charset=utf-8');

// 1. Chặn truy cập
if (!isset($_SESSION['user_id'])) {
    echo json_encode(['success' => false, 'message' => 'Unauthorized']);
    exit;
}

try {
    // 2. Nhận tham số từ Client
    $page = isset($_GET['page']) ? (int)$_GET['page'] : 1;
    $limit = 20; // Load 20 dòng mỗi lần
    $offset = ($page - 1) * $limit;

    // Các tham số lọc
    $filter_date_start = $_GET['date_start'] ?? '';
    $filter_date_end = $_GET['date_end'] ?? '';
    $filter_ing = $_GET['ingredient_id'] ?? '';
    $filter_type = $_GET['type'] ?? '';
    $filter_user = $_GET['user_id'] ?? '';

    // 3. Xây dựng câu Query động (Dynamic SQL)
    $sql = "SELECT 
                l.id, l.type, l.quantity, l.cost, l.note, l.created_at,
                i.name as ingredient_name, i.unit,
                u.fullname as user_name
            FROM inventory_log l
            JOIN ingredients i ON l.ingredient_id = i.id
            LEFT JOIN users u ON l.user_id = u.id
            WHERE 1=1";

    $params = [];
    $types = "";

    // Lọc theo ngày
    if (!empty($filter_date_start)) {
        $sql .= " AND DATE(l.created_at) >= ?";
        $params[] = $filter_date_start;
        $types .= "s";
    }
    if (!empty($filter_date_end)) {
        $sql .= " AND DATE(l.created_at) <= ?";
        $params[] = $filter_date_end;
        $types .= "s";
    }

    // Lọc theo Nguyên liệu
    if (!empty($filter_ing)) {
        $sql .= " AND l.ingredient_id = ?";
        $params[] = $filter_ing;
        $types .= "i";
    }

    // Lọc theo Loại (import/export)
    if (!empty($filter_type)) {
        $sql .= " AND l.type = ?";
        $params[] = $filter_type;
        $types .= "s";
    }

    // Lọc theo Người thực hiện
    if (!empty($filter_user)) {
        $sql .= " AND l.user_id = ?";
        $params[] = $filter_user;
        $types .= "i";
    }

    // Sắp xếp và Phân trang
    $sql .= " ORDER BY l.created_at DESC LIMIT ? OFFSET ?";
    $params[] = $limit;
    $params[] = $offset;
    $types .= "ii";

    // 4. Thực thi Query
    $stmt = $mysqli->prepare($sql);
    if (!empty($params)) {
        $stmt->bind_param($types, ...$params);
    }
    $stmt->execute();
    $result = $stmt->get_result();
    
    $data = [];
    while ($row = $result->fetch_assoc()) {
        // Format sẵn dữ liệu để JS chỉ việc hiện
        $row['formatted_date'] = date('d/m/Y', strtotime($row['created_at']));
        $row['formatted_time'] = date('H:i', strtotime($row['created_at']));
        $row['cost_display'] = ($row['cost'] > 0) ? number_format($row['cost']) . ' đ' : '-';
        $row['qty_display'] = number_format($row['quantity'], 1);
        $data[] = $row;
    }

    // 5. Kiểm tra xem còn trang sau không (để ẩn hiện nút Load More)
    $has_more = count($data) >= $limit;

    echo json_encode([
        'success' => true,
        'data' => $data,
        'has_more' => $has_more,
        'page' => $page
    ]);

} catch (Exception $e) {
    echo json_encode(['success' => false, 'message' => $e->getMessage()]);
}
?>
---------------- END FILE ----------------

---------------- START FILE: warehouse\history.php ----------------
<?php
session_start();
require_once '../includes/db_connection.php';

if (!isset($_SESSION['user_id']) || ($_SESSION['role'] !== 'wh-staff' && $_SESSION['role'] !== 'admin')) {
    header("Location: ../login.php");
    exit;
}

// Lấy danh sách Nguyên liệu & User để đổ vào Select box lọc
$ingredients = $mysqli->query("SELECT id, name FROM ingredients ORDER BY name ASC");
$users = $mysqli->query("SELECT id, fullname FROM users ORDER BY fullname ASC");
?>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Lịch sử Kho | Nguyễn Văn Coffee</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --wh-primary: #2c3e50; --wh-bg: #ecf0f1; }
        body { background-color: var(--wh-bg); font-family: 'Segoe UI', sans-serif; }
        .navbar-wh { background-color: var(--wh-primary); color: white; }
        .card-stock { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .badge-import { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; } 
        .badge-export { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; } 
        .time-text { font-size: 0.85em; color: #6c757d; }
        .cost-col { font-weight: bold; color: #2c3e50; }
        
        /* Loading Spinner */
        #loading-spinner { display: none; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-wh px-3 py-2 shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand text-white fw-bold" href="index.php"><i class="fa-solid fa-boxes-stacked me-2"></i>KHO HÀNG</a>
        <div class="d-flex align-items-center text-white">
            <span class="me-3"><i class="fa-solid fa-user me-1"></i> <?= $_SESSION['fullname'] ?? 'Thủ kho' ?></span>
            <a href="../logout.php" class="btn btn-sm btn-outline-light">Đăng xuất</a>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="row mb-3 g-2 align-items-end">
        <div class="col-md-12 mb-2 d-flex justify-content-between">
            <div class="d-flex align-items-center">
                <a href="index.php" class="btn btn-outline-secondary me-3"><i class="fa-solid fa-arrow-left"></i> Quay lại</a>
                <h4 class="fw-bold text-dark mb-0">Lịch sử Nhập / Xuất</h4>
            </div>
        </div>

        <div class="col-md-2">
            <label class="form-label small fw-bold">Từ ngày:</label>
            <input type="date" id="filter-date-start" class="form-control form-control-sm filter-input">
        </div>
        <div class="col-md-2">
            <label class="form-label small fw-bold">Đến ngày:</label>
            <input type="date" id="filter-date-end" class="form-control form-control-sm filter-input">
        </div>
        <div class="col-md-3">
            <label class="form-label small fw-bold">Nguyên liệu:</label>
            <select id="filter-ing" class="form-select form-select-sm filter-input">
                <option value="">-- Tất cả --</option>
                <?php while($row = $ingredients->fetch_assoc()): ?>
                    <option value="<?= $row['id'] ?>"><?= $row['name'] ?></option>
                <?php endwhile; ?>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small fw-bold">Loại:</label>
            <select id="filter-type" class="form-select form-select-sm filter-input">
                <option value="">-- Tất cả --</option>
                <option value="import">Nhập kho (+)</option>
                <option value="export">Xuất kho (-)</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small fw-bold">Người thực hiện:</label>
            <select id="filter-user" class="form-select form-select-sm filter-input">
                <option value="">-- Tất cả --</option>
                <?php while($row = $users->fetch_assoc()): ?>
                    <option value="<?= $row['id'] ?>"><?= $row['fullname'] ?></option>
                <?php endwhile; ?>
            </select>
        </div>
        <div class="col-md-1">
             <button class="btn btn-dark btn-sm w-100 mt-4" onclick="resetFilters()">
                <i class="fa-solid fa-rotate"></i> Reset
             </button>
        </div>
    </div>

    <div class="card card-stock">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Thời gian</th>
                            <th class="text-center">Loại</th>
                            <th>Nguyên liệu</th>
                            <th class="text-end">Số lượng</th>
                            <th class="text-end">Chi phí</th>
                            <th class="text-center">Người thực hiện</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        </tbody>
                </table>
            </div>
            
            <div id="loading-spinner" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted small">Đang tải dữ liệu...</p>
            </div>
            <div id="no-data-message" class="text-center py-5 d-none">
                <i class="fa-solid fa-file-circle-xmark fa-2x text-muted mb-2"></i>
                <p class="text-muted">Không tìm thấy dữ liệu phù hợp.</p>
            </div>

            <div class="text-center p-3 border-top" id="load-more-container" style="display: none;">
                <button class="btn btn-outline-primary px-4" onclick="loadHistory(false)">
                    Xem thêm cũ hơn <i class="fa-solid fa-angle-down"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentPage = 1;
    let isLoading = false;

    // 1. Hàm load dữ liệu (AJAX)
    // reset = true: Xóa bảng cũ load lại từ đầu (Khi lọc)
    // reset = false: Load trang tiếp theo (Lazy load)
    function loadHistory(reset = false) {
        if (isLoading) return;
        isLoading = true;

        if (reset) {
            currentPage = 1;
            document.getElementById('history-table-body').innerHTML = '';
            document.getElementById('load-more-container').style.display = 'none';
            document.getElementById('no-data-message').classList.add('d-none');
        }

        document.getElementById('loading-spinner').style.display = 'block';

        // Lấy giá trị bộ lọc
        const params = new URLSearchParams({
            page: currentPage,
            date_start: document.getElementById('filter-date-start').value,
            date_end: document.getElementById('filter-date-end').value,
            ingredient_id: document.getElementById('filter-ing').value,
            type: document.getElementById('filter-type').value,
            user_id: document.getElementById('filter-user').value
        });

        fetch(`get_history_api.php?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading-spinner').style.display = 'none';
                
                if (data.success) {
                    renderRows(data.data);
                    
                    // Xử lý nút Load More
                    if (data.has_more) {
                        document.getElementById('load-more-container').style.display = 'block';
                        currentPage++;
                    } else {
                        document.getElementById('load-more-container').style.display = 'none';
                    }

                    // Xử lý khi không có dữ liệu
                    if (data.data.length === 0 && currentPage === 1) {
                        document.getElementById('no-data-message').classList.remove('d-none');
                    }
                } else {
                    alert("Lỗi: " + data.message);
                }
                isLoading = false;
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading-spinner').style.display = 'none';
                isLoading = false;
            });
    }

    // 2. Hàm vẽ dòng HTML
    function renderRows(items) {
        const tbody = document.getElementById('history-table-body');
        
        items.forEach(row => {
            const isImport = (row.type === 'import');
            const badgeClass = isImport ? 'badge-import' : 'badge-export';
            const icon = isImport ? '<i class="fa-solid fa-arrow-down"></i>' : '<i class="fa-solid fa-arrow-up"></i>';
            const typeText = isImport ? 'NHẬP KHO' : 'XUẤT KHO';
            const sign = isImport ? '+' : '-';
            const qtyColor = isImport ? 'text-success' : 'text-danger';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-4">
                    <div class="fw-bold">${row.formatted_time}</div>
                    <div class="time-text">${row.formatted_date}</div>
                </td>
                <td class="text-center">
                    <span class="badge ${badgeClass} px-3 py-2">
                        ${icon} ${typeText}
                    </span>
                </td>
                <td class="fw-bold text-primary">
                    ${row.ingredient_name}
                </td>
                <td class="text-end fw-bold fs-5 ${qtyColor}">
                    ${sign}${row.qty_display} 
                    <small class="text-muted fw-normal fs-6">${row.unit}</small>
                </td>
                <td class="text-end cost-col">
                    ${row.cost_display}
                </td>
                <td class="text-center">
                    <small><i class="fa-regular fa-user-circle text-muted"></i> ${row.user_name || 'N/A'}</small>
                </td>
                <td class="text-muted fst-italic">
                    ${row.note || ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 3. Sự kiện thay đổi bộ lọc -> Load lại từ đầu
    const filters = document.querySelectorAll('.filter-input');
    filters.forEach(input => {
        input.addEventListener('change', () => loadHistory(true));
    });

    // Hàm Reset
    function resetFilters() {
        filters.forEach(input => input.value = '');
        loadHistory(true);
    }

    // Load lần đầu khi vào trang
    document.addEventListener('DOMContentLoaded', () => loadHistory(true));

</script>
</body>
</html>
---------------- END FILE ----------------

---------------- START FILE: warehouse\index.php ----------------
<?php
session_start();
require_once '../includes/db_connection.php';

// 1. Chặn truy cập trái phép
if (!isset($_SESSION['user_id']) || ($_SESSION['role'] !== 'wh-staff' && $_SESSION['role'] !== 'admin')) {
    header("Location: ../login.php");
    exit;
}

// 2. Lấy danh sách nguyên liệu
$query = "SELECT * FROM ingredients ORDER BY quantity ASC"; 
$result = $mysqli->query($query);
?>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Kho | Nguyễn Văn Coffee</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --wh-primary: #2c3e50; --wh-bg: #ecf0f1; }
        body { background-color: var(--wh-bg); font-family: 'Segoe UI', sans-serif; }
        .navbar-wh { background-color: var(--wh-primary); color: white; }
        .card-stock { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .unit-badge { background: #e0e0e0; color: #333; font-size: 0.8em; padding: 2px 6px; border-radius: 4px; }
        
        .row-out { background-color: #f8d7da; }
        .row-low { background-color: #fff3cd; }
        
        /* Style cho Tab trong Modal */
        .nav-tabs .nav-link { color: #555; font-weight: 600; }
        .nav-tabs .nav-link.active { color: var(--wh-primary); border-top: 3px solid var(--wh-primary); }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-wh px-3 py-2 shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand text-white fw-bold" href="#"><i class="fa-solid fa-boxes-stacked me-2"></i>KHO HÀNG</a>
        <div class="d-flex align-items-center text-white">
            <span class="me-3"><i class="fa-solid fa-user me-1"></i> <?= $_SESSION['fullname'] ?? 'Thủ kho' ?></span>
            <button class="btn btn-sm btn-outline-light" onclick="confirmEndShiftWarehouse()">
                <i class="fa-solid fa-right-from-bracket me-1"></i> Thoát ca
            </button>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-12 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="../index.php" class="btn btn-outline-secondary me-3">
                    <i class="fa-solid fa-arrow-left"></i> Trang chủ
                </a>
                <h4 class="fw-bold text-dark mb-0">Tồn kho hiện tại</h4>
            </div>
            
            <div>
                <a href="history.php" class="btn btn-outline-dark me-2">
                    <i class="fa-solid fa-clock-rotate-left me-1"></i> Xem Lịch sử
                </a>
                <button class="btn btn-primary" onclick="openImportModal(null, null, 'new')">
                    <i class="fa-solid fa-plus me-2"></i>Tạo / Nhập hàng mới
                </button>
            </div>
        </div>
    </div>

    <div class="card card-stock">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Tên nguyên liệu</th>
                        <th class="text-center">Tồn kho</th>
                        <th class="text-center">Đơn vị</th>
                        <th class="text-center">Trạng thái</th>
                        <th class="text-end pe-4">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    <?php while($row = $result->fetch_assoc()): ?>
                        <?php 
                            $qty = (float)$row['quantity'];
                            $min = (float)$row['min_quantity'];
                            $status_text = "Ổn định"; $status_class = "badge bg-success"; $row_class = "";

                            if ($qty <= 0) {
                                $status_text = "Đã hết"; $status_class = "badge bg-danger"; $row_class = "row-out";
                            } elseif ($qty <= $min) {
                                $status_text = "Sắp hết"; $status_class = "badge bg-warning text-dark"; $row_class = "row-low";
                            }
                        ?>
                        <tr class="<?= $row_class ?>">
                            <td class="ps-4 fw-bold"><?= $row['name'] ?></td>
                            <td class="text-center fs-5 <?= ($qty <= 0) ? 'text-danger fw-bold' : '' ?>"><?= number_format($qty, 1) ?></td>
                            <td class="text-center"><span class="unit-badge"><?= $row['unit'] ?></span></td>
                            <td class="text-center"><span class="<?= $status_class ?>"><?= $status_text ?></span></td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-primary me-1" 
                                        onclick="openImportModal('<?= $row['id'] ?>', '<?= $row['unit'] ?>', 'existing')">
                                    <i class="fa-solid fa-download"></i> Nhập
                                </button>
                                
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="openExportModal('<?= $row['id'] ?>', '<?= $row['name'] ?>', '<?= $row['quantity'] ?>', '<?= $row['unit'] ?>')">
                                    <i class="fa-solid fa-trash-can"></i> Hủy
                                </button>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fa-solid fa-warehouse me-2"></i>Quản lý Nhập Kho</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body pb-0">
                <ul class="nav nav-tabs" id="importTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-existing-btn" data-bs-toggle="tab" data-bs-target="#tab-existing" type="button" role="tab">
                            <i class="fa-solid fa-boxes-packing"></i> Nhập hàng có sẵn
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-new-btn" data-bs-toggle="tab" data-bs-target="#tab-new" type="button" role="tab">
                            <i class="fa-solid fa-plus-circle"></i> Tạo nguyên liệu mới
                        </button>
                    </li>
                </ul>

                <div class="tab-content pt-3 pb-3" id="importTabContent">
                    
                    <div class="tab-pane fade show active" id="tab-existing" role="tabpanel">
                        <form id="importForm">
                            <div class="mb-3">
                                <label class="form-label">Chọn nguyên liệu:</label>
                                <select id="modal_ing_select" class="form-select" onchange="updateUnitDisplay()">
                                    <option value="">-- Chọn nguyên liệu --</option>
                                    <?php 
                                    $result->data_seek(0);
                                    while($ing = $result->fetch_assoc()): 
                                    ?>
                                        <option value="<?= $ing['id'] ?>" data-unit="<?= $ing['unit'] ?>">
                                            <?= $ing['name'] ?> (Tồn: <?= $ing['quantity'] ?> <?= $ing['unit'] ?>)
                                        </option>
                                    <?php endwhile; ?>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-8">
                                    <label class="form-label">Số lượng nhập thêm:</label>
                                    <input type="number" id="quantity_add" class="form-control fw-bold" min="0.1" step="0.1" placeholder="0">
                                </div>
                                <div class="col-4">
                                     <label class="form-label">Đơn vị:</label>
                                     <input type="text" class="form-control" value="..." disabled id="modal_unit_display">
                                </div>
                            </div>

                            <div class="mb-3 mt-3">
                                <label class="form-label">Tổng chi phí (VNĐ):</label>
                                <input type="number" id="import_cost" class="form-control" min="0" step="1000" placeholder="0">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Ghi chú:</label>
                                <textarea id="import_note" class="form-control" rows="2" placeholder="VD: Nhập thêm..."></textarea>
                            </div>
                            
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary fw-bold" onclick="submitImportAJAX()">
                                    <i class="fa-solid fa-download"></i> XÁC NHẬN NHẬP
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="tab-new" role="tabpanel">
                        <form id="newIngForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Tên nguyên liệu mới <span class="text-danger">*</span>:</label>
                                <input type="text" id="new_name" class="form-control border-primary" placeholder="VD: Bột Matcha, Trân châu trắng...">
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label fw-bold">Đơn vị tính <span class="text-danger">*</span>:</label>
                                    <select id="new_unit" class="form-select">
                                        <option value="ml">ml</option>
                                        <option value="g">gram (g)</option>
                                        <option value="kg">kg</option>
                                        <option value="l">lít (l)</option>
                                        <option value="hop">hộp</option>
                                        <option value="chai">chai</option>
                                        <option value="goi">gói</option>
                                        <option value="qua">quả</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Cảnh báo khi dưới:</label>
                                    <input type="number" id="new_min_qty" class="form-control" value="10" placeholder="Mức tối thiểu">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label">Số lượng ban đầu:</label>
                                    <input type="number" id="new_qty" class="form-control fw-bold" value="0" min="0">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Chi phí ban đầu:</label>
                                    <input type="number" id="new_cost" class="form-control" value="0">
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="button" class="btn btn-success fw-bold" onclick="submitAddNewAJAX()">
                                    <i class="fa-solid fa-plus"></i> TẠO & LƯU KHO
                                </button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalImportResult" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content text-center">
            <div class="modal-body p-4">
                <div id="result-icon" class="mb-3"></div>
                <h5 id="result-title" class="fw-bold"></h5>
                <p id="result-message" class="mb-0"></p>
            </div>
            <div class="modal-footer justify-content-center p-2">
                <button type="button" class="btn btn-dark btn-sm px-4" onclick="location.reload()">OK</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEndShiftWh" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fa-solid fa-door-closed"></i> KẾT THÚC CA</h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">Bạn đang trong ca. Vui lòng chốt tiền két.</div>
                <input type="number" id="wh-end-cash-input" class="form-control mb-3" placeholder="Tiền mặt thực tế...">
                <textarea id="wh-end-note-input" class="form-control" placeholder="Ghi chú..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button class="btn btn-danger" onclick="submitEndShiftWh()">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Xuất Hủy Kho</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <input type="hidden" id="export_ing_id">
                    <input type="text" id="export_ing_name" class="form-control-plaintext fw-bold text-danger mb-2" readonly>
                    <div class="input-group mb-3">
                        <input type="text" id="export_current_qty" class="form-control" disabled>
                        <span class="input-group-text" id="export_unit_display_1">...</span>
                    </div>
                    <label class="text-danger fw-bold">Trừ đi:</label>
                    <div class="input-group mb-3">
                        <input type="number" id="quantity_sub" class="form-control border-danger" required>
                        <span class="input-group-text bg-danger text-white" id="export_unit_display_2">...</span>
                    </div>
                    <select id="export_reason_select" class="form-select mb-2" onchange="updateReason()">
                        <option value="">-- Lý do --</option>
                        <option value="Hỏng/Hết hạn">Hỏng/Hết hạn</option>
                        <option value="Rơi vỡ">Rơi vỡ</option>
                        <option value="Kiểm kê sai">Kiểm kê sai</option>
                        <option value="other">Khác...</option>
                    </select>
                    <textarea id="export_note" class="form-control" placeholder="Chi tiết lý do..."></textarea>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger w-100" onclick="submitExportAJAX()">XÁC NHẬN TRỪ</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 1. Hàm mở Modal nhập (Có tham số mode để chọn tab)
    function openImportModal(id = null, unit = null, mode = 'existing') {
        const modal = new bootstrap.Modal(document.getElementById('importModal'));
        
        // Reset forms
        document.getElementById('importForm').reset();
        document.getElementById('newIngForm').reset();
        
        // Switch Tab
        if (mode === 'new') {
            const newTabBtn = document.querySelector('#tab-new-btn');
            const newTab = new bootstrap.Tab(newTabBtn);
            newTab.show();
        } else {
            const existTabBtn = document.querySelector('#tab-existing-btn');
            const existTab = new bootstrap.Tab(existTabBtn);
            existTab.show();
            
            // Pre-fill data if existing
            const select = document.getElementById('modal_ing_select');
            const unitInput = document.getElementById('modal_unit_display');
            if (id) {
                select.value = id;
                unitInput.value = unit;
            } else {
                select.value = "";
                unitInput.value = "...";
            }
        }
        
        modal.show();
    }

    function updateUnitDisplay() {
        const select = document.getElementById('modal_ing_select');
        const unitInput = document.getElementById('modal_unit_display');
        const selectedOption = select.options[select.selectedIndex];
        const unit = selectedOption.getAttribute('data-unit');
        unitInput.value = unit ? unit : '...';
    }

    // 2. Gửi AJAX Nhập hàng CŨ
    function submitImportAJAX() {
        const ingId = document.getElementById('modal_ing_select').value;
        const qty = document.getElementById('quantity_add').value;
        const cost = document.getElementById('import_cost').value;
        const note = document.getElementById('import_note').value;

        if (!ingId || qty <= 0) { alert("Vui lòng kiểm tra lại thông tin!"); return; }

        // Đóng modal
        bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();

        fetch('process_import.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ingredient_id: ingId, quantity_add: qty, import_cost: cost, note: note })
        })
        .then(res => res.json())
        .then(data => showResultModal(data.success, data.message))
        .catch(err => showResultModal(false, "Lỗi kết nối!"));
    }

    // 3. Gửi AJAX Tạo hàng MỚI (NEW)
    function submitAddNewAJAX() {
        const name = document.getElementById('new_name').value.trim();
        const unit = document.getElementById('new_unit').value;
        const minQty = document.getElementById('new_min_qty').value;
        const qty = document.getElementById('new_qty').value;
        const cost = document.getElementById('new_cost').value;

        if (!name) { alert("Chưa nhập tên nguyên liệu!"); return; }
        if (!unit) { alert("Chưa chọn đơn vị!"); return; }

        // Đóng modal
        bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();

        fetch('process_add_new.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                name: name, unit: unit, 
                quantity: qty, min_quantity: minQty, cost: cost 
            })
        })
        .then(res => res.json())
        .then(data => showResultModal(data.success, data.message))
        .catch(err => showResultModal(false, "Lỗi kết nối!"));
    }

    // 4. Helper hiển thị kết quả
    function showResultModal(isSuccess, message) {
        const iconDiv = document.getElementById('result-icon');
        const titleDiv = document.getElementById('result-title');
        
        if (isSuccess) {
            iconDiv.innerHTML = '<i class="fa-solid fa-circle-check text-success fa-3x"></i>';
            titleDiv.textContent = "THÀNH CÔNG";
            titleDiv.className = "fw-bold text-success";
        } else {
            iconDiv.innerHTML = '<i class="fa-solid fa-circle-xmark text-danger fa-3x"></i>';
            titleDiv.textContent = "THẤT BẠI";
            titleDiv.className = "fw-bold text-danger";
        }
        document.getElementById('result-message').textContent = message;
        new bootstrap.Modal(document.getElementById('modalImportResult')).show();
    }

    // --- LOGIC XUẤT KHO ---
    function openExportModal(id, name, currentQty, unit) {
        const modal = new bootstrap.Modal(document.getElementById('exportModal'));
        document.getElementById('export_ing_id').value = id;
        document.getElementById('export_ing_name').value = name;
        document.getElementById('export_current_qty').value = currentQty;
        document.getElementById('export_unit_display_1').textContent = unit;
        document.getElementById('export_unit_display_2').textContent = unit;
        document.getElementById('quantity_sub').value = '';
        document.getElementById('quantity_sub').max = currentQty;
        modal.show();
    }

    function updateReason() {
        const select = document.getElementById('export_reason_select');
        const note = document.getElementById('export_note');
        if (select.value && select.value !== 'other') note.value = select.value;
        else if (select.value === 'other') note.value = '', note.focus();
    }

    function submitExportAJAX() {
        const id = document.getElementById('export_ing_id').value;
        const qty = document.getElementById('quantity_sub').value;
        const note = document.getElementById('export_note').value;

        if (qty <= 0 || !note) { alert("Kiểm tra lại số lượng và lý do!"); return; }
        if(!confirm("Chắc chắn xuất kho?")) return;

        bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();

        fetch('process_export.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ingredient_id: id, quantity_sub: qty, reason: note })
        })
        .then(res => res.json())
        .then(data => showResultModal(data.success, data.message))
        .catch(err => showResultModal(false, "Lỗi kết nối!"));
    }

    // --- LOGIC THOÁT CA ---
    function confirmEndShiftWarehouse() {
        fetch('../core/session_manager.php?action=check_status')
        .then(res => res.json())
        .then(data => {
            if (data.success && data.is_open) {
                new bootstrap.Modal(document.getElementById('modalEndShiftWh')).show();
            } else {
                window.location.href = '../logout.php';
            }
        });
    }

    function submitEndShiftWh() {
        const cash = document.getElementById('wh-end-cash-input').value;
        const note = document.getElementById('wh-end-note-input').value;
        if (!cash) { alert("Nhập tiền két!"); return; }
        
        fetch('../core/session_manager.php?action=end_shift', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ end_cash: cash, note: note })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) window.location.href = '../login.php';
            else alert(data.message);
        });
    }
</script>
</body>
</html>
---------------- END FILE ----------------

---------------- START FILE: warehouse\process_add_new.php ----------------
<?php
session_start();
header('Content-Type: application/json; charset=utf-8');
require_once '../includes/db_connection.php';

try {
    // 1. Check quyền
    if (!isset($_SESSION['user_id']) || ($_SESSION['role'] !== 'wh-staff' && $_SESSION['role'] !== 'admin')) {
        throw new Exception("Unauthorized");
    }

    $input = json_decode(file_get_contents("php://input"), true);
    if (!$input) throw new Exception("Dữ liệu lỗi.");

    $name = trim($input['name'] ?? '');
    $unit = trim($input['unit'] ?? '');
    $qty = (float)($input['quantity'] ?? 0);
    $min_qty = (float)($input['min_quantity'] ?? 0);
    $cost = (float)($input['cost'] ?? 0);
    $user_id = $_SESSION['user_id'];

    if (empty($name) || empty($unit)) throw new Exception("Tên và Đơn vị tính không được để trống.");
    if ($qty < 0) throw new Exception("Số lượng ban đầu không được âm.");

    // 2. Check trùng tên
    $stmt_check = $mysqli->prepare("SELECT id FROM ingredients WHERE name = ?");
    $stmt_check->bind_param("s", $name);
    $stmt_check->execute();
    if ($stmt_check->get_result()->num_rows > 0) {
        throw new Exception("Nguyên liệu '$name' đã tồn tại trong hệ thống!");
    }

    $mysqli->begin_transaction();

    // 3. Insert Ingredients
    $stmt_ins = $mysqli->prepare("INSERT INTO ingredients (name, unit, quantity, min_quantity, updated_at) VALUES (?, ?, ?, ?, NOW())");
    $stmt_ins->bind_param("ssdd", $name, $unit, $qty, $min_qty);
    
    if ($stmt_ins->execute()) {
        $new_id = $mysqli->insert_id;

        // 4. Ghi Log nhập kho lần đầu (Nếu có số lượng ban đầu)
        if ($qty > 0) {
            $log_note = "Khởi tạo nguyên liệu mới. Vốn: " . number_format($cost);
            $stmt_log = $mysqli->prepare("INSERT INTO inventory_log (ingredient_id, type, quantity, note, user_id, created_at) VALUES (?, 'import', ?, ?, ?, NOW())");
            $stmt_log->bind_param("idsi", $new_id, $qty, $log_note, $user_id);
            $stmt_log->execute();
        }

        $mysqli->commit();
        echo json_encode(['success' => true, 'message' => 'Đã thêm nguyên liệu mới thành công!']);
    } else {
        throw new Exception("Lỗi SQL: " . $mysqli->error);
    }

} catch (Exception $e) {
    $mysqli->rollback();
    echo json_encode(['success' => false, 'message' => $e->getMessage()]);
}
?>
---------------- END FILE ----------------

---------------- START FILE: warehouse\process_export.php ----------------
<?php
session_start();
header('Content-Type: application/json; charset=utf-8');
require_once '../includes/db_connection.php';

try {
    // 1. Check quyền (Chỉ Admin hoặc Thủ kho)
    if (!isset($_SESSION['user_id']) || ($_SESSION['role'] !== 'wh-staff' && $_SESSION['role'] !== 'admin')) {
        throw new Exception("Bạn không có quyền thực hiện chức năng này.");
    }

    // 2. Nhận dữ liệu JSON
    $input = json_decode(file_get_contents("php://input"), true);
    if (!$input) throw new Exception("Dữ liệu không hợp lệ.");

    $ing_id = isset($input['ingredient_id']) ? (int)$input['ingredient_id'] : 0;
    $qty_sub = isset($input['quantity_sub']) ? (float)$input['quantity_sub'] : 0;
    $reason = isset($input['reason']) ? trim($input['reason']) : '';
    $user_id = $_SESSION['user_id'];

    // 3. Validate
    if ($ing_id <= 0) throw new Exception("Chưa chọn nguyên liệu.");
    if ($qty_sub <= 0) throw new Exception("Số lượng xuất phải lớn hơn 0.");
    if (empty($reason)) throw new Exception("Vui lòng nhập lý do xuất kho (VD: Hỏng, Kiểm kê sai...).");

    $mysqli->begin_transaction();

    // 4. Kiểm tra tồn kho hiện tại (Không được xuất âm kho)
    $stmt_check = $mysqli->prepare("SELECT quantity, name FROM ingredients WHERE id = ? FOR UPDATE");
    $stmt_check->bind_param("i", $ing_id);
    $stmt_check->execute();
    $res_check = $stmt_check->get_result();
    $current = $res_check->fetch_assoc();

    if (!$current) throw new Exception("Nguyên liệu không tồn tại.");
    if ($current['quantity'] < $qty_sub) {
        throw new Exception("Không đủ hàng để xuất! Tồn hiện tại: " . $current['quantity']);
    }

    // 5. Trừ kho
    $stmt_update = $mysqli->prepare("UPDATE ingredients SET quantity = quantity - ? WHERE id = ?");
    $stmt_update->bind_param("di", $qty_sub, $ing_id);
    if (!$stmt_update->execute()) {
        throw new Exception("Lỗi SQL Update: " . $mysqli->error);
    }

    // 6. Ghi Log (Lưu ý type là 'export')
    // Ghi chú sẽ có dạng: "Xuất hủy: [Lý do]"
    $full_note = "Xuất kho điều chỉnh: " . $reason;
    
    $stmt_log = $mysqli->prepare("INSERT INTO inventory_log (ingredient_id, type, quantity, note, user_id, created_at) VALUES (?, 'export', ?, ?, ?, NOW())");
    $stmt_log->bind_param("idsi", $ing_id, $qty_sub, $full_note, $user_id);
    
    if (!$stmt_log->execute()) {
        throw new Exception("Lỗi ghi Log.");
    }

    $mysqli->commit();

    echo json_encode([
        'success' => true, 
        'message' => 'Đã trừ kho thành công!'
    ]);

} catch (Exception $e) {
    $mysqli->rollback();
    echo json_encode([
        'success' => false, 
        'message' => $e->getMessage()
    ]);
}
?>
---------------- END FILE ----------------

---------------- START FILE: warehouse\process_import.php ----------------
<?php
session_start();
header('Content-Type: application/json; charset=utf-8');
require_once '../includes/db_connection.php';

try {
    // 1. Nhận dữ liệu JSON từ AJAX
    $input = json_decode(file_get_contents("php://input"), true);
    
    if (!$input) {
        throw new Exception("Dữ liệu gửi lên không hợp lệ (Phải là JSON).");
    }

    $ing_id = isset($input['ingredient_id']) ? (int)$input['ingredient_id'] : 0;
    $qty_add = isset($input['quantity_add']) ? (float)$input['quantity_add'] : 0;
    $cost = isset($input['import_cost']) ? (float)$input['import_cost'] : 0;
    $note_input = isset($input['note']) ? trim($input['note']) : '';
    $user_id = $_SESSION['user_id'] ?? 0;

    // Validate
    if ($ing_id <= 0) throw new Exception("Chưa chọn nguyên liệu.");
    if ($qty_add <= 0) throw new Exception("Số lượng nhập phải lớn hơn 0.");

    $mysqli->begin_transaction();

    // 2. Cập nhật số lượng tồn kho
    $stmt_update = $mysqli->prepare("UPDATE ingredients SET quantity = quantity + ? WHERE id = ?");
    $stmt_update->bind_param("di", $qty_add, $ing_id);
    
    if (!$stmt_update->execute()) {
        throw new Exception("Lỗi SQL Update: " . $mysqli->error);
    }

    // 3. Ghi Log nhập kho
    // Ghép giá nhập vào ghi chú (Vì bảng log có thể chưa có cột price)
    // Nếu bạn muốn lưu giá nhập, hãy thêm cột 'price' vào bảng inventory_log
    $full_note = $note_input;
    if ($cost > 0) {
        $full_note .= " [Chi phí: " . number_format($cost) . "đ]";
    }

    // Trong process_import.php, đoạn INSERT phải như này:
$stmt_log = $mysqli->prepare("INSERT INTO inventory_log (ingredient_id, type, quantity, cost, note, user_id, created_at) VALUES (?, 'import', ?, ?, ?, ?, NOW())");
$stmt_log->bind_param("iddsi", $ing_id, $qty_add, $cost, $note_input, $user_id);
    
    if (!$stmt_log->execute()) {
        throw new Exception("Lỗi ghi Log.");
    }

    $mysqli->commit();

    echo json_encode([
        'success' => true, 
        'message' => 'Đã nhập kho thành công!'
    ]);

} catch (Exception $e) {
    $mysqli->rollback();
    echo json_encode([
        'success' => false, 
        'message' => $e->getMessage()
    ]);
}
?>
---------------- END FILE ----------------

---------------- START FILE: warehouse\suppliers.php ----------------

---------------- END FILE ----------------

================================================================
PHẦN 4: LOG CÁC FILE ĐÃ BỎ QUA HOẶC LỖI (DEBUG)
================================================================
[IGNORED TYPE] ket_qua_scan.txt
[IGNORED TYPE] NewPage.mp3
[IGNORED TYPE] password.txt
[IGNORED TYPE] README.docx
[IGNORED TYPE] readme.txt
[IGNORED TYPE] adminlte.css.map
[IGNORED TYPE] adminlte.min.css.map
[IGNORED TYPE] adminlte.components.css.map
[IGNORED TYPE] adminlte.components.min.css.map
[IGNORED TYPE] adminlte.core.css.map
[IGNORED TYPE] adminlte.core.min.css.map
[IGNORED TYPE] adminlte.extra-components.css.map
[IGNORED TYPE] adminlte.extra-components.min.css.map
[IGNORED TYPE] adminlte.light.css.map
[IGNORED TYPE] adminlte.light.min.css.map
[IGNORED TYPE] adminlte.pages.css.map
[IGNORED TYPE] adminlte.pages.min.css.map
[IGNORED TYPE] adminlte.plugins.css.map
[IGNORED TYPE] adminlte.plugins.min.css.map
[SKIPPED BINARY] C:\xampp\htdocs\coffee\admin\assets\dist\img\logo coffee.png
[SKIPPED BINARY] C:\xampp\htdocs\coffee\admin\assets\dist\img\logo.png
[IGNORED TYPE] adminlte.js.map
[IGNORED TYPE] adminlte.min.js.map
[IGNORED TYPE] fa-brands-400.eot
[IGNORED TYPE] fa-brands-400.svg
[IGNORED TYPE] fa-brands-400.ttf
[SKIPPED BINARY] C:\xampp\htdocs\coffee\admin\assets\plugins\fontawesome-free\webfonts\fa-brands-400.woff
[SKIPPED BINARY] C:\xampp\htdocs\coffee\admin\assets\plugins\fontawesome-free\webfonts\fa-brands-400.woff2
[IGNORED TYPE] fa-regular-400.eot
[IGNORED TYPE] fa-regular-400.svg
[IGNORED TYPE] fa-regular-400.ttf
[SKIPPED BINARY] C:\xampp\htdocs\coffee\admin\assets\plugins\fontawesome-free\webfonts\fa-regular-400.woff
[SKIPPED BINARY] C:\xampp\htdocs\coffee\admin\assets\plugins\fontawesome-free\webfonts\fa-regular-400.woff2
[IGNORED TYPE] fa-solid-900.eot
[IGNORED TYPE] fa-solid-900.svg
[IGNORED TYPE] fa-solid-900.ttf
[SKIPPED BINARY] C:\xampp\htdocs\coffee\admin\assets\plugins\fontawesome-free\webfonts\fa-solid-900.woff
[SKIPPED BINARY] C:\xampp\htdocs\coffee\admin\assets\plugins\fontawesome-free\webfonts\fa-solid-900.woff2
[IGNORED TYPE] jquery.min.map
[IGNORED TYPE] jquery.slim.min.map
[IGNORED TYPE] README.txt
[IGNORED TYPE] LICENSE.txt
[IGNORED TYPE] composer.json
[IGNORED TYPE] composer.lock
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\drink\1766479775_ad.jpg
[IGNORED TYPE] 1766568160_OIP.webp
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\drink\1766636352_bo_pc.jpg
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\drink\ca-phe-den.jpg
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\drink\latte-da.jpg
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\drink\nuoc-ep-cam.png
[IGNORED TYPE] sinh-to-bo.avif
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\drink\tra-dao-cam-sa.jpg
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\food\1766626403_bo_pc.jpg
[IGNORED TYPE] banh-mi-bo-toi.webp
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\food\banh-mousse-chanh-leo.png
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\food\banh-muffin-chocolate.jpg
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\food\banh-tiramisu.png
[SKIPPED BINARY] C:\xampp\htdocs\coffee\assets\img\food\khoai-tay-chien.jpg
[IGNORED TYPE] debug_log.txt
[IGNORED TYPE] debug_order.txt
[SKIPPED BINARY] C:\xampp\htdocs\coffee\pos\webfonts\fa-brands-400.woff2
[SKIPPED BINARY] C:\xampp\htdocs\coffee\pos\webfonts\fa-regular-400.woff2
[SKIPPED BINARY] C:\xampp\htdocs\coffee\pos\webfonts\fa-solid-900.woff2
[SKIPPED BINARY] C:\xampp\htdocs\coffee\pos\webfonts\fa-v4compatibility.woff2
